<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Cost Calculator - Philip Riachy, PhD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1B5E20, #2E7D32);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .signature {
            position: absolute;
            top: 15px;
            right: 30px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h3 {
            color: #1B5E20;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #1B5E20;
            box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #1B5E20, #2E7D32);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin: 3px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(27, 94, 32, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #ff6b6b);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #1B5E20;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr.selected {
            background: #e8f5e8;
        }

        .result-display {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin: 15px 0;
            display: none;
            font-size: 0.9rem;
        }

        .result-display.error {
            background: linear-gradient(135deg, #f44336, #ff6b6b);
        }

        .result-display.warning {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
        }

        .cost-analysis {
            background: #e8f5e8;
            border: 2px solid #1B5E20;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .cost-analysis h4 {
            color: #1b5e20;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .cost-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .cost-category {
            background: #f0f8f0;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #4caf50;
        }

        .cost-summary {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .summary-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1B5E20;
        }

        .summary-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .supplier-categories {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .category-badge {
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .category-badge.raw_materials { background: #e3f2fd; color: #1565c0; }
        .category-badge.packaging { background: #fff3e0; color: #f57c00; }
        .category-badge.labor { background: #fce4ec; color: #ad1457; }
        .category-badge.overhead { background: #f3e5f5; color: #7b1fa2; }

        .category-badge.selected {
            border-color: #1B5E20;
            transform: scale(1.05);
        }

        .profit-calculator {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .competitive-analysis {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .recipe-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .recipe-form {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .recipe-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 800px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .recipe-form {
                grid-template-columns: 1fr;
            }
            
            .cost-breakdown,
            .supplier-categories {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="signature">Philip Riachy, PhD</div>
            <h1>Professional Cost Calculator</h1>
            <p class="subtitle">Comprehensive Cosmetic Formulation Cost Analysis & Profitability Tool</p>
        </div>

        <div class="main-content">
            <!-- Raw Materials Costing -->
            <div class="section">
                <h3>🧪 Raw Materials</h3>
                
                <div class="form-group">
                    <label>Material Category</label>
                    <div class="supplier-categories">
                        <div class="category-badge raw_materials" onclick="selectMaterialCategory('raw_materials')">Active Ingredients</div>
                        <div class="category-badge packaging" onclick="selectMaterialCategory('packaging')">Base Materials</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Material Name</label>
                    <select id="material-select" class="form-control">
                        <option value="">Choose material...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Usage Quantity</label>
                    <input type="number" id="material-quantity" class="form-control" step="0.01" min="0" placeholder="e.g., 25.5">
                </div>

                <div class="form-group">
                    <label>Unit</label>
                    <select id="material-unit" class="form-control">
                        <option value="g">Grams (g)</option>
                        <option value="kg">Kilograms (kg)</option>
                        <option value="ml">Milliliters (ml)</option>
                        <option value="l">Liters (l)</option>
                        <option value="units">Units</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Unit Cost ($)</label>
                    <input type="number" id="material-cost" class="form-control" step="0.01" min="0" placeholder="Cost per unit">
                </div>

                <div>
                    <button class="btn" onclick="addMaterialToCostList()">Add Material</button>
                    <button class="btn btn-danger" onclick="removeSelectedMaterial()">Remove</button>
                </div>

                <table class="data-table" id="materials-table">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Qty</th>
                            <th>Unit Cost</th>
                            <th>Total Cost</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <button class="btn btn-success" onclick="calculateRawMaterialCosts()">Calculate Material Costs</button>
                <div id="materials-cost-result" class="result-display"></div>
            </div>

            <!-- Manufacturing Costs -->
            <div class="section">
                <h3>🏭 Manufacturing</h3>
                
                <div class="form-group">
                    <label>Batch Size (units)</label>
                    <input type="number" id="batch-size" class="form-control" value="1000" min="1">
                </div>

                <div class="form-group">
                    <label>Labor Cost per Batch ($)</label>
                    <input type="number" id="labor-cost" class="form-control" step="0.01" min="0" value="50">
                </div>

                <div class="form-group">
                    <label>Equipment/Utilities per Batch ($)</label>
                    <input type="number" id="equipment-cost" class="form-control" step="0.01" min="0" value="25">
                </div>

                <div class="form-group">
                    <label>Quality Control/Testing ($)</label>
                    <input type="number" id="qc-cost" class="form-control" step="0.01" min="0" value="75">
                </div>

                <div class="cost-breakdown">
                    <div class="cost-category">
                        <h5>Direct Labor</h5>
                        <div style="font-size: 0.8rem;">
                            • Mixing & processing<br>
                            • Filling operations<br>
                            • Quality control
                        </div>
                    </div>
                    <div class="cost-category">
                        <h5>Indirect Costs</h5>
                        <div style="font-size: 0.8rem;">
                            • Equipment depreciation<br>
                            • Utilities (power, water)<br>
                            • Facility overhead
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Manufacturing Method</label>
                    <select id="manufacturing-method" class="form-control" onchange="updateManufacturingCosts()">
                        <option value="manual">Manual Production</option>
                        <option value="semi_automated">Semi-Automated</option>
                        <option value="automated">Fully Automated</option>
                        <option value="contract">Contract Manufacturing</option>
                    </select>
                </div>

                <button class="btn btn-success" onclick="calculateManufacturingCosts()">Calculate Manufacturing</button>
                <div id="manufacturing-cost-result" class="result-display"></div>
            </div>

            <!-- Packaging Costs -->
            <div class="section">
                <h3>📦 Packaging</h3>
                
                <div class="form-group">
                    <label>Primary Packaging</label>
                    <select id="primary-packaging" class="form-control" onchange="updatePackagingCost('primary')">
                        <option value="">Select primary container...</option>
                        <option value="plastic_bottle_30ml">Plastic Bottle 30ml</option>
                        <option value="plastic_bottle_50ml">Plastic Bottle 50ml</option>
                        <option value="glass_bottle_30ml">Glass Bottle 30ml</option>
                        <option value="airless_pump_30ml">Airless Pump 30ml</option>
                        <option value="tube_30ml">Tube 30ml</option>
                        <option value="jar_50ml">Jar 50ml</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Primary Package Cost ($)</label>
                    <input type="number" id="primary-cost" class="form-control" step="0.01" min="0">
                </div>

                <div class="form-group">
                    <label>Secondary Packaging</label>
                    <select id="secondary-packaging" class="form-control" onchange="updatePackagingCost('secondary')">
                        <option value="">Select secondary packaging...</option>
                        <option value="cardboard_box">Cardboard Box</option>
                        <option value="printed_box">Printed Box</option>
                        <option value="premium_box">Premium Box</option>
                        <option value="pouch">Pouch</option>
                        <option value="blister_pack">Blister Pack</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Secondary Package Cost ($)</label>
                    <input type="number" id="secondary-cost" class="form-control" step="0.01" min="0">
                </div>

                <div class="form-group">
                    <label>Labels & Inserts ($)</label>
                    <input type="number" id="labels-cost" class="form-control" step="0.01" min="0" value="0.25">
                </div>

                <div class="cost-analysis" id="packaging-analysis">
                    <h4>Packaging Cost Breakdown</h4>
                    <div id="packaging-breakdown">Select packaging components to see cost analysis</div>
                </div>

                <button class="btn btn-success" onclick="calculatePackagingCosts()">Calculate Packaging</button>
                <div id="packaging-cost-result" class="result-display"></div>
            </div>

            <!-- Profit Analysis -->
            <div class="section">
                <h3>💰 Profit Analysis</h3>
                
                <div class="form-group">
                    <label>Target Retail Price ($)</label>
                    <input type="number" id="retail-price" class="form-control" step="0.01" min="0">
                </div>

                <div class="form-group">
                    <label>Retailer Margin (%)</label>
                    <input type="number" id="retailer-margin" class="form-control" step="1" min="0" max="100" value="50">
                </div>

                <div class="form-group">
                    <label>Distributor Margin (%)</label>
                    <input type="number" id="distributor-margin" class="form-control" step="1" min="0" max="100" value="25">
                </div>

                <div class="profit-calculator">
                    <h4>Margin Calculator</h4>
                    <div style="font-size: 0.85rem;">
                        <strong>Typical Industry Margins:</strong><br>
                        • Mass Market: 40-60% retail<br>
                        • Premium: 60-80% retail<br>
                        • Luxury: 80-90% retail<br>
                        • Direct-to-Consumer: 70-85%
                    </div>
                </div>

                <div class="form-group">
                    <label>Marketing & Sales (%)</label>
                    <input type="number" id="marketing-percentage" class="form-control" step="0.1" min="0" max="50" value="15">
                </div>

                <div class="form-group">
                    <label>Admin & Overhead (%)</label>
                    <input type="number" id="overhead-percentage" class="form-control" step="0.1" min="0" max="30" value="10">
                </div>

                <button class="btn btn-success" onclick="calculateProfitAnalysis()">Analyze Profitability</button>
                <div id="profit-analysis-result" class="result-display"></div>

                <div class="cost-analysis" id="profitability-breakdown" style="display: none;">
                    <h4>Profitability Analysis</h4>
                    <div id="profit-details"></div>
                </div>
            </div>
        </div>

        <!-- Cost Summary & Reports -->
        <div class="recipe-section">
            <h3>📊 Complete Cost Analysis Report</h3>
            
            <div class="recipe-form">
                <div>
                    <div class="form-group">
                        <label>Product Name</label>
                        <input type="text" id="product-name" class="form-control" placeholder="Premium Anti-Aging Serum">
                    </div>
                    <div class="form-group">
                        <label>Product Category</label>
                        <select id="product-category" class="form-control">
                            <option value="skincare">Skincare</option>
                            <option value="haircare">Haircare</option>
                            <option value="makeup">Makeup</option>
                            <option value="fragrance">Fragrance</option>
                            <option value="body_care">Body Care</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Market Segment</label>
                        <select id="market-segment" class="form-control">
                            <option value="mass">Mass Market</option>
                            <option value="premium">Premium</option>
                            <option value="luxury">Luxury</option>
                            <option value="professional">Professional</option>
                            <option value="natural">Natural/Organic</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <div class="form-group">
                        <label>Report ID</label>
                        <input type="text" id="report-id" class="form-control" placeholder="COST001">
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <select id="currency" class="form-control">
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="GBP">GBP (£)</option>
                            <option value="CAD">CAD ($)</option>
                            <option value="AUD">AUD ($)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Production Volume</label>
                        <input type="number" id="production-volume" class="form-control" value="10000" min="1">
                    </div>
                </div>
                
                <div>
                    <div class="form-group">
                        <label>Cost Analysis Notes</label>
                        <textarea id="cost-notes" class="form-control" rows="4" placeholder="Market positioning, competitive analysis, cost optimization opportunities..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Risk Assessment</label>
                        <textarea id="risk-assessment" class="form-control" rows="2" placeholder="Supply chain risks, material price volatility, regulatory costs..."></textarea>
                    </div>
                </div>
            </div>

            <div class="cost-summary" id="cost-summary-display">
                <div class="summary-item">
                    <div class="summary-value" id="total-cogs">$0.00</div>
                    <div class="summary-label">Cost of Goods Sold</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="gross-margin">0%</div>
                    <div class="summary-label">Gross Margin</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="net-profit">$0.00</div>
                    <div class="summary-label">Net Profit per Unit</div>
                </div>
            </div>

            <div class="competitive-analysis" id="competitive-benchmarking" style="display: none;">
                <h4>🎯 Competitive Benchmarking</h4>
                <div id="competitive-data"></div>
            </div>

            <div class="recipe-buttons">
                <button class="btn btn-success" onclick="generateCostReport()">Generate Complete Report</button>
                <button class="btn" onclick="exportCostPDF()">Export PDF</button>
                <button class="btn" onclick="saveCostAnalysis()">Save JSON</button>
                <button class="btn" onclick="loadCostAnalysis()">Load JSON</button>
                <button class="btn btn-danger" onclick="clearAllCostData()">New Analysis</button>
            </div>

            <div id="cost-report-display"></div>
        </div>
    </div>

    <script>
        // Comprehensive Raw Materials Cost Database
        const MATERIALS_DATABASE = {
            // Active Ingredients
            "Hyaluronic Acid": { category: "active", unit_cost: 125.00, unit: "g", supplier_tier: "premium" },
            "Vitamin C (L-Ascorbic Acid)": { category: "active", unit_cost: 85.00, unit: "g", supplier_tier: "premium" },
            "Retinol": { category: "active", unit_cost: 450.00, unit: "g", supplier_tier: "luxury" },
            "Niacinamide": { category: "active", unit_cost: 35.00, unit: "g", supplier_tier: "standard" },
            "Salicylic Acid": { category: "active", unit_cost: 28.00, unit: "g", supplier_tier: "standard" },
            "Glycolic Acid": { category: "active", unit_cost: 45.00, unit: "g", supplier_tier: "premium" },
            "Peptides (Matrixyl 3000)": { category: "active", unit_cost: 180.00, unit: "g", supplier_tier: "luxury" },
            "Ceramides": { category: "active", unit_cost: 95.00, unit: "g", supplier_tier: "premium" },
            
            // Base Materials
            "Distilled Water": { category: "base", unit_cost: 0.001, unit: "ml", supplier_tier: "standard" },
            "Glycerin": { category: "base", unit_cost: 0.08, unit: "ml", supplier_tier: "standard" },
            "Propylene Glycol": { category: "base", unit_cost: 0.06, unit: "ml", supplier_tier: "standard" },
            "Cetyl Alcohol": { category: "base", unit_cost: 0.15, unit: "g", supplier_tier: "standard" },
            "Stearic Acid": { category: "base", unit_cost: 0.12, unit: "g", supplier_tier: "standard" },
            "Phenoxyethanol": { category: "preservative", unit_cost: 2.50, unit: "ml", supplier_tier: "standard" },
            "Xanthan Gum": { category: "thickener", unit_cost: 1.80, unit: "g", supplier_tier: "standard" },
            "Carbomer": { category: "thickener", unit_cost: 2.20, unit: "g", supplier_tier: "standard" },
            "Dimethicone": { category: "silicone", unit_cost: 0.45, unit: "ml", supplier_tier: "standard" },
            "Jojoba Oil": { category: "oil", unit_cost: 0.25, unit: "ml", supplier_tier: "premium" },
            "Argan Oil": { category: "oil", unit_cost: 0.85, unit: "ml", supplier_tier: "luxury" },
            "Squalane": { category: "emollient", unit_cost: 0.95, unit: "ml", supplier_tier: "premium" },
            
            // Packaging Materials
            "30ml Glass Dropper Bottle": { category: "packaging", unit_cost: 1.25, unit: "units", supplier_tier: "premium" },
            "50ml Airless Pump": { category: "packaging", unit_cost: 2.85, unit: "units", supplier_tier: "luxury" },
            "30ml Plastic Bottle": { category: "packaging", unit_cost: 0.35, unit: "units", supplier_tier: "standard" },
            "Premium Gift Box": { category: "packaging", unit_cost: 1.50, unit: "units", supplier_tier: "luxury" },
            "Standard Carton": { category: "packaging", unit_cost: 0.25, unit: "units", supplier_tier: "standard" },
            "Product Label": { category: "packaging", unit_cost: 0.15, unit: "units", supplier_tier: "standard" },
            "Instruction Insert": { category: "packaging", unit_cost: 0.08, unit: "units", supplier_tier: "standard" }
        };

        const PACKAGING_DATABASE = {
            "plastic_bottle_30ml": { cost: 0.35, description: "Standard plastic bottle with pump" },
            "plastic_bottle_50ml": { cost: 0.45, description: "Standard plastic bottle with pump" },
            "glass_bottle_30ml": { cost: 1.25, description: "Premium glass dropper bottle" },
            "airless_pump_30ml": { cost: 2.85, description: "Luxury airless pump system" },
            "tube_30ml": { cost: 0.55, description: "Squeezable tube with flip cap" },
            "jar_50ml": { cost: 0.85, description: "Glass or plastic jar with lid" },
            "cardboard_box": { cost: 0.25, description: "Basic cardboard packaging" },
            "printed_box": { cost: 0.65, description: "Full-color printed box" },
            "premium_box": { cost: 1.50, description: "Premium rigid box with insert" },
            "pouch": { cost: 0.15, description: "Flexible pouch packaging" },
            "blister_pack": { cost: 0.45, description: "Thermoformed blister pack" }
        };

        // Application State
        let currentCostAnalysis = {
            materials: [],
            manufacturingCosts: null,
            packagingCosts: null,
            profitAnalysis: null,
            totalCOGS: 0
        };

        // Initialize Application
        function initializeCostApp() {
            console.log('Initializing Professional Cost Calculator...');
            populateMaterialDropdown();
            setupCostEventListeners();
            console.log('Cost Calculator ready!');
        }

        function populateMaterialDropdown() {
            const materialSelect = document.getElementById('material-select');
            Object.keys(MATERIALS_DATABASE).sort().forEach(material => {
                const option = document.createElement('option');
                option.value = material;
                option.textContent = material;
                materialSelect.appendChild(option);
            });
        }

        function setupCostEventListeners() {
            document.getElementById('material-quantity').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addMaterialToCostList();
            });

            document.getElementById('material-select').addEventListener('change', function() {
                const material = this.value;
                if (material && MATERIALS_DATABASE[material]) {
                    document.getElementById('material-cost').value = MATERIALS_DATABASE[material].unit_cost;
                    document.getElementById('material-unit').value = MATERIALS_DATABASE[material].unit;
                }
            });

            // Auto-calculate when values change
            ['retail-price', 'retailer-margin', 'distributor-margin'].forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    if (currentCostAnalysis.totalCOGS > 0) {
                        calculateProfitAnalysis();
                    }
                });
            });
        }

        function selectMaterialCategory(category) {
            document.querySelectorAll('.category-badge').forEach(badge => badge.classList.remove('selected'));
            document.querySelector(`.category-badge.${category}`).classList.add('selected');
            
            filterMaterialsByCategory(category);
        }

        function filterMaterialsByCategory(category) {
            const materialSelect = document.getElementById('material-select');
            materialSelect.innerHTML = '<option value="">Choose material...</option>';
            
            Object.entries(MATERIALS_DATABASE).forEach(([name, data]) => {
                if ((category === 'raw_materials' && data.category !== 'packaging') ||
                    (category === 'packaging' && data.category === 'packaging')) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    materialSelect.appendChild(option);
                }
            });
        }

        function addMaterialToCostList() {
            const materialName = document.getElementById('material-select').value;
            const quantity = parseFloat(document.getElementById('material-quantity').value);
            const unit = document.getElementById('material-unit').value;
            const unitCost = parseFloat(document.getElementById('material-cost').value);

            if (!materialName || !quantity || !unitCost) {
                alert('Please fill in all material fields');
                return;
            }

            const material = {
                name: materialName,
                quantity: quantity,
                unit: unit,
                unitCost: unitCost,
                totalCost: quantity * unitCost,
                category: MATERIALS_DATABASE[materialName]?.category || 'other'
            };

            currentCostAnalysis.materials.push(material);
            updateMaterialsTable();
            
            // Clear inputs
            document.getElementById('material-select').value = '';
            document.getElementById('material-quantity').value = '';
            document.getElementById('material-cost').value = '';
        }

        function updateMaterialsTable() {
            const tbody = document.querySelector('#materials-table tbody');
            tbody.innerHTML = '';

            currentCostAnalysis.materials.forEach((material, index) => {
                const row = document.createElement('tr');
                row.onclick = () => selectTableRow(row, 'material', index);
                row.innerHTML = `
                    <td>${material.name}</td>
                    <td>${material.quantity} ${material.unit}</td>
                    <td>$${material.unitCost.toFixed(2)}</td>
                    <td>$${material.totalCost.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });

            // Auto-calculate if we have materials
            if (currentCostAnalysis.materials.length > 0) {
                calculateRawMaterialCosts();
            }
        }

        function removeSelectedMaterial() {
            const selectedRow = document.querySelector('#materials-table tr.selected');
            if (!selectedRow) {
                alert('Please select a material to remove');
                return;
            }

            const index = parseInt(selectedRow.dataset.index);
            currentCostAnalysis.materials.splice(index, 1);
            updateMaterialsTable();
        }

        function calculateRawMaterialCosts() {
            if (currentCostAnalysis.materials.length === 0) {
                alert('Please add materials first');
                return;
            }

            const totalMaterialCost = currentCostAnalysis.materials.reduce((sum, material) => sum + material.totalCost, 0);
            const batchSize = parseFloat(document.getElementById('batch-size').value) || 1000;
            const costPerUnit = totalMaterialCost / batchSize;

            currentCostAnalysis.materialsCost = {
                total: totalMaterialCost,
                perUnit: costPerUnit,
                breakdown: categorizeByType(currentCostAnalysis.materials)
            };

            const resultDiv = document.getElementById('materials-cost-result');
            resultDiv.innerHTML = `
                <strong>Raw Materials Calculated!</strong><br>
                Total: $${totalMaterialCost.toFixed(2)}<br>
                Per Unit: $${costPerUnit.toFixed(3)}<br>
                Batch Size: ${batchSize} units
            `;
            resultDiv.className = 'result-display';
            resultDiv.style.display = 'block';

            updateCostSummary();
        }

        function categorizeByType(materials) {
            const categories = {};
            materials.forEach(material => {
                const category = material.category || 'other';
                if (!categories[category]) categories[category] = 0;
                categories[category] += material.totalCost;
            });
            return categories;
        }

        function updateManufacturingCosts() {
            const method = document.getElementById('manufacturing-method').value;
            const laborMultipliers = {
                manual: 1.0,
                semi_automated: 0.7,
                automated: 0.4,
                contract: 0.8
            };

            const baseLabor = 50;
            document.getElementById('labor-cost').value = (baseLabor * (laborMultipliers[method] || 1.0)).toFixed(2);
        }

        function calculateManufacturingCosts() {
            const batchSize = parseFloat(document.getElementById('batch-size').value) || 1000;
            const laborCost = parseFloat(document.getElementById('labor-cost').value) || 0;
            const equipmentCost = parseFloat(document.getElementById('equipment-cost').value) || 0;
            const qcCost = parseFloat(document.getElementById('qc-cost').value) || 0;

            const totalManufacturingCost = laborCost + equipmentCost + qcCost;
            const costPerUnit = totalManufacturingCost / batchSize;

            currentCostAnalysis.manufacturingCosts = {
                labor: laborCost,
                equipment: equipmentCost,
                qc: qcCost,
                total: totalManufacturingCost,
                perUnit: costPerUnit
            };

            const resultDiv = document.getElementById('manufacturing-cost-result');
            resultDiv.innerHTML = `
                <strong>Manufacturing Costs Calculated!</strong><br>
                Total: $${totalManufacturingCost.toFixed(2)}<br>
                Per Unit: $${costPerUnit.toFixed(3)}<br>
                Method: ${document.getElementById('manufacturing-method').value.replace('_', ' ')}
            `;
            resultDiv.className = 'result-display';
            resultDiv.style.display = 'block';

            updateCostSummary();
        }

        function updatePackagingCost(type) {
            const packageType = document.getElementById(`${type}-packaging`).value;
            if (packageType && PACKAGING_DATABASE[packageType]) {
                document.getElementById(`${type}-cost`).value = PACKAGING_DATABASE[packageType].cost;
                updatePackagingBreakdown();
            }
        }

        function updatePackagingBreakdown() {
            const primaryType = document.getElementById('primary-packaging').value;
            const secondaryType = document.getElementById('secondary-packaging').value;
            
            let breakdown = '<strong>Selected Packaging:</strong><br>';
            if (primaryType) {
                breakdown += `Primary: ${PACKAGING_DATABASE[primaryType].description} - $${PACKAGING_DATABASE[primaryType].cost}<br>`;
            }
            if (secondaryType) {
                breakdown += `Secondary: ${PACKAGING_DATABASE[secondaryType].description} - $${PACKAGING_DATABASE[secondaryType].cost}<br>`;
            }

            document.getElementById('packaging-breakdown').innerHTML = breakdown;
        }

        function calculatePackagingCosts() {
            const primaryCost = parseFloat(document.getElementById('primary-cost').value) || 0;
            const secondaryCost = parseFloat(document.getElementById('secondary-cost').value) || 0;
            const labelsCost = parseFloat(document.getElementById('labels-cost').value) || 0;

            const totalPackagingCost = primaryCost + secondaryCost + labelsCost;

            currentCostAnalysis.packagingCosts = {
                primary: primaryCost,
                secondary: secondaryCost,
                labels: labelsCost,
                total: totalPackagingCost
            };

            const resultDiv = document.getElementById('packaging-cost-result');
            resultDiv.innerHTML = `
                <strong>Packaging Costs Calculated!</strong><br>
                Primary: $${primaryCost.toFixed(2)}<br>
                Secondary: $${secondaryCost.toFixed(2)}<br>
                Total: $${totalPackagingCost.toFixed(2)}
            `;
            resultDiv.className = 'result-display';
            resultDiv.style.display = 'block';

            updateCostSummary();
        }

        function calculateProfitAnalysis() {
            const retailPrice = parseFloat(document.getElementById('retail-price').value) || 0;
            const retailerMargin = parseFloat(document.getElementById('retailer-margin').value) || 50;
            const distributorMargin = parseFloat(document.getElementById('distributor-margin').value) || 25;
            const marketingPct = parseFloat(document.getElementById('marketing-percentage').value) || 15;
            const overheadPct = parseFloat(document.getElementById('overhead-percentage').value) || 10;

            if (!retailPrice) {
                alert('Please enter a target retail price');
                return;
            }

            // Calculate backwards from retail price
            const wholesalePrice = retailPrice * (1 - retailerMargin / 100);
            const netPrice = wholesalePrice * (1 - distributorMargin / 100);
            
            // Calculate additional costs
            const marketingCost = netPrice * (marketingPct / 100);
            const overheadCost = netPrice * (overheadPct / 100);
            
            const totalCOGS = currentCostAnalysis.totalCOGS;
            const grossProfit = netPrice - totalCOGS;
            const netProfit = grossProfit - marketingCost - overheadCost;
            const grossMargin = totalCOGS > 0 ? ((grossProfit / netPrice) * 100) : 0;
            const netMargin = netPrice > 0 ? ((netProfit / netPrice) * 100) : 0;

            currentCostAnalysis.profitAnalysis = {
                retailPrice,
                wholesalePrice,
                netPrice,
                totalCOGS,
                grossProfit,
                netProfit,
                grossMargin,
                netMargin,
                marketingCost,
                overheadCost
            };

            let resultClass = '';
            if (netMargin < 10) resultClass = 'error';
            else if (netMargin < 20) resultClass = 'warning';

            const resultDiv = document.getElementById('profit-analysis-result');
            resultDiv.innerHTML = `
                <strong>Profitability Analysis Complete!</strong><br>
                Gross Margin: ${grossMargin.toFixed(1)}%<br>
                Net Margin: ${netMargin.toFixed(1)}%<br>
                Net Profit: $${netProfit.toFixed(2)}
            `;
            resultDiv.className = `result-display ${resultClass}`;
            resultDiv.style.display = 'block';

            // Show detailed breakdown
            document.getElementById('profit-details').innerHTML = `
                <strong>Price Waterfall Analysis:</strong><br>
                Retail Price: $${retailPrice.toFixed(2)}<br>
                - Retailer Margin (${retailerMargin}%): $${(retailPrice - wholesalePrice).toFixed(2)}<br>
                Wholesale Price: $${wholesalePrice.toFixed(2)}<br>
                - Distributor Margin (${distributorMargin}%): $${(wholesalePrice - netPrice).toFixed(2)}<br>
                <strong>Net Price to Manufacturer: $${netPrice.toFixed(2)}</strong><br><br>
                
                <strong>Cost Structure:</strong><br>
                Total COGS: $${totalCOGS.toFixed(2)}<br>
                Marketing (${marketingPct}%): $${marketingCost.toFixed(2)}<br>
                Overhead (${overheadPct}%): $${overheadCost.toFixed(2)}<br>
                <strong>Net Profit: $${netProfit.toFixed(2)} (${netMargin.toFixed(1)}%)</strong>
            `;
            document.getElementById('profitability-breakdown').style.display = 'block';

            updateCostSummary();
        }

        function updateCostSummary() {
            let totalCOGS = 0;
            
            if (currentCostAnalysis.materialsCost) {
                totalCOGS += currentCostAnalysis.materialsCost.perUnit;
            }
            if (currentCostAnalysis.manufacturingCosts) {
                totalCOGS += currentCostAnalysis.manufacturingCosts.perUnit;
            }
            if (currentCostAnalysis.packagingCosts) {
                totalCOGS += currentCostAnalysis.packagingCosts.total;
            }

            currentCostAnalysis.totalCOGS = totalCOGS;

            document.getElementById('total-cogs').textContent = `$${totalCOGS.toFixed(2)}`;

            if (currentCostAnalysis.profitAnalysis) {
                document.getElementById('gross-margin').textContent = `${currentCostAnalysis.profitAnalysis.grossMargin.toFixed(1)}%`;
                document.getElementById('net-profit').textContent = `$${currentCostAnalysis.profitAnalysis.netProfit.toFixed(2)}`;
            }

            // Show competitive benchmarking
            showCompetitiveBenchmarking();
        }

        function showCompetitiveBenchmarking() {
            const category = document.getElementById('product-category').value;
            const segment = document.getElementById('market-segment').value;

            if (!category || !segment || currentCostAnalysis.totalCOGS === 0) return;

            const benchmarks = {
                mass: { typical_margin: 45, cogs_range: [0.50, 2.00] },
                premium: { typical_margin: 65, cogs_range: [2.00, 8.00] },
                luxury: { typical_margin: 85, cogs_range: [5.00, 25.00] },
                professional: { typical_margin: 55, cogs_range: [3.00, 12.00] },
                natural: { typical_margin: 60, cogs_range: [2.50, 10.00] }
            };

            const benchmark = benchmarks[segment];
            if (!benchmark) return;

            const currentCOGS = currentCostAnalysis.totalCOGS;
            const isInRange = currentCOGS >= benchmark.cogs_range[0] && currentCOGS <= benchmark.cogs_range[1];

            document.getElementById('competitive-data').innerHTML = `
                <strong>${segment.charAt(0).toUpperCase() + segment.slice(1)} ${category} Benchmarks:</strong><br>
                Typical Gross Margin: ${benchmark.typical_margin}%<br>
                COGS Range: $${benchmark.cogs_range[0].toFixed(2)} - $${benchmark.cogs_range[1].toFixed(2)}<br>
                Your COGS: $${currentCOGS.toFixed(2)} ${isInRange ? '✓ Within range' : '⚠ Outside typical range'}<br>
                <br>
                <strong>Market Position:</strong> ${getMarketPosition(currentCOGS, benchmark)}
            `;
            document.getElementById('competitive-benchmarking').style.display = 'block';
        }

        function getMarketPosition(cogs, benchmark) {
            if (cogs < benchmark.cogs_range[0]) {
                return 'Below market - may indicate quality concerns or cost optimization opportunities';
            } else if (cogs > benchmark.cogs_range[1]) {
                return 'Above market - premium positioning or cost reduction needed';
            } else {
                return 'Within market range - competitive positioning';
            }
        }

        // Report Generation Functions
        function generateCostReport() {
            if (currentCostAnalysis.totalCOGS === 0) {
                alert('Please calculate costs for all components first');
                return;
            }

            const productName = document.getElementById('product-name').value || 'Cost Analysis Report';
            const costNotes = document.getElementById('cost-notes').value;
            const riskAssessment = document.getElementById('risk-assessment').value;

            let reportHTML = `
                <div style="background: white; border-radius: 8px; padding: 20px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3>${productName} - Cost Analysis</h3>
                    <p><strong>Category:</strong> ${document.getElementById('product-category').value.charAt(0).toUpperCase() + document.getElementById('product-category').value.slice(1)} | <strong>Segment:</strong> ${document.getElementById('market-segment').value.charAt(0).toUpperCase() + document.getElementById('market-segment').value.slice(1)} | <strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin: 20px 0; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #1B5E20;">$${currentCostAnalysis.totalCOGS.toFixed(2)}</div>
                            <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">Total COGS</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #1B5E20;">${currentCostAnalysis.profitAnalysis ? currentCostAnalysis.profitAnalysis.grossMargin.toFixed(1) : 0}%</div>
                            <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">Gross Margin</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #1B5E20;">${currentCostAnalysis.profitAnalysis ? currentCostAnalysis.profitAnalysis.netMargin.toFixed(1) : 0}%</div>
                            <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">Net Margin</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #1B5E20;">$${currentCostAnalysis.profitAnalysis ? currentCostAnalysis.profitAnalysis.netProfit.toFixed(2) : '0.00'}</div>
                            <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">Net Profit/Unit</div>
                        </div>
                    </div>

                    <h4 style="color: #1B5E20; margin-top: 20px;">Raw Materials Breakdown</h4>
                    <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                        <thead>
                            <tr style="background: #1B5E20; color: white;">
                                <th style="padding: 12px; text-align: left;">Material</th>
                                <th style="padding: 12px; text-align: left;">Quantity</th>
                                <th style="padding: 12px; text-align: left;">Unit Cost</th>
                                <th style="padding: 12px; text-align: left;">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            currentCostAnalysis.materials.forEach(material => {
                reportHTML += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">${material.name}</td>
                        <td style="padding: 10px;">${material.quantity} ${material.unit}</td>
                        <td style="padding: 10px;">$${material.unitCost.toFixed(2)}</td>
                        <td style="padding: 10px;">$${material.totalCost.toFixed(2)}</td>
                    </tr>
                `;
            });

            reportHTML += `</tbody></table>`;

            // Manufacturing costs
            if (currentCostAnalysis.manufacturingCosts) {
                reportHTML += `
                    <h4 style="color: #1B5E20; margin-top: 20px;">Manufacturing Costs</h4>
                    <div style="background: #f0f8f0; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <strong>Labor:</strong> $${currentCostAnalysis.manufacturingCosts.labor.toFixed(2)}<br>
                        <strong>Equipment:</strong> $${currentCostAnalysis.manufacturingCosts.equipment.toFixed(2)}<br>
                        <strong>Quality Control:</strong> $${currentCostAnalysis.manufacturingCosts.qc.toFixed(2)}<br>
                        <strong>Total per Batch:</strong> $${currentCostAnalysis.manufacturingCosts.total.toFixed(2)}<br>
                        <strong>Per Unit:</strong> $${currentCostAnalysis.manufacturingCosts.perUnit.toFixed(3)}
                    </div>
                `;
            }

            // Packaging costs
            if (currentCostAnalysis.packagingCosts) {
                reportHTML += `
                    <h4 style="color: #1B5E20; margin-top: 20px;">Packaging Costs</h4>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <strong>Primary:</strong> $${currentCostAnalysis.packagingCosts.primary.toFixed(2)}<br>
                        <strong>Secondary:</strong> $${currentCostAnalysis.packagingCosts.secondary.toFixed(2)}<br>
                        <strong>Labels:</strong> $${currentCostAnalysis.packagingCosts.labels.toFixed(2)}<br>
                        <strong>Total per Unit:</strong> $${currentCostAnalysis.packagingCosts.total.toFixed(2)}
                    </div>
                `;
            }

            // Profitability analysis
            if (currentCostAnalysis.profitAnalysis) {
                reportHTML += `
                    <h4 style="color: #1B5E20; margin-top: 20px;">Profitability Analysis</h4>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <strong>Retail Price:</strong> $${currentCostAnalysis.profitAnalysis.retailPrice.toFixed(2)}<br>
                        <strong>Wholesale Price:</strong> $${currentCostAnalysis.profitAnalysis.wholesalePrice.toFixed(2)}<br>
                        <strong>Net to Manufacturer:</strong> $${currentCostAnalysis.profitAnalysis.netPrice.toFixed(2)}<br>
                        <strong>Gross Profit:</strong> $${currentCostAnalysis.profitAnalysis.grossProfit.toFixed(2)} (${currentCostAnalysis.profitAnalysis.grossMargin.toFixed(1)}%)<br>
                        <strong>Net Profit:</strong> $${currentCostAnalysis.profitAnalysis.netProfit.toFixed(2)} (${currentCostAnalysis.profitAnalysis.netMargin.toFixed(1)}%)
                    </div>
                `;
            }

            if (costNotes) {
                reportHTML += `
                    <h4 style="color: #1B5E20; margin-top: 20px;">Analysis Notes:</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${costNotes}</div>
                `;
            }

            if (riskAssessment) {
                reportHTML += `
                    <h4 style="color: #1B5E20; margin-top: 20px;">Risk Assessment:</h4>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${riskAssessment}</div>
                `;
            }

            reportHTML += '</div>';

            document.getElementById('cost-report-display').innerHTML = reportHTML;
        }

        function exportCostPDF() {
            if (currentCostAnalysis.totalCOGS === 0) {
                alert('Please complete cost analysis first');
                return;
            }

            if (!window.jspdf) {
                alert('PDF library not loaded. Please refresh the page and try again.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            const productName = document.getElementById('product-name').value || 'Cost Analysis Report';

            let yPosition = 20;

            // Header
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text(productName + ' - Cost Analysis', 20, yPosition);
            yPosition += 12;

            pdf.setFontSize(8);
            pdf.setFont(undefined, 'normal');
            pdf.text('Professional Cost Calculator - Philip Riachy, PhD', 130, 15);
            pdf.text(`Date: ${new Date().toLocaleDateString()}`, 20, yPosition);
            yPosition += 15;

            // Cost Summary
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Cost Summary', 20, yPosition);
            yPosition += 8;

            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Total COGS: $${currentCostAnalysis.totalCOGS.toFixed(2)}`, 20, yPosition);
            if (currentCostAnalysis.profitAnalysis) {
                pdf.text(`Gross Margin: ${currentCostAnalysis.profitAnalysis.grossMargin.toFixed(1)}%`, 80, yPosition);
                pdf.text(`Net Profit: $${currentCostAnalysis.profitAnalysis.netProfit.toFixed(2)}`, 130, yPosition);
            }
            yPosition += 12;

            // Raw Materials
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'bold');
            pdf.text('Raw Materials', 20, yPosition);
            yPosition += 8;

            pdf.setFontSize(8);
            pdf.setFont(undefined, 'normal');
            let materialTotal = 0;
            currentCostAnalysis.materials.forEach(material => {
                materialTotal += material.totalCost;
                pdf.text(`${material.name}`, 20, yPosition);
                pdf.text(`${material.quantity} ${material.unit}`, 80, yPosition);
                pdf.text(`$${material.unitCost.toFixed(2)}`, 110, yPosition);
                pdf.text(`$${material.totalCost.toFixed(2)}`, 140, yPosition);
                yPosition += 4;
            });
            yPosition += 5;

            pdf.setFont(undefined, 'bold');
            pdf.text(`Total Materials: $${materialTotal.toFixed(2)}`, 20, yPosition);
            yPosition += 10;

            // Manufacturing & Packaging
            if (currentCostAnalysis.manufacturingCosts) {
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('Manufacturing Costs', 20, yPosition);
                yPosition += 6;

                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                pdf.text(`Per Unit: $${currentCostAnalysis.manufacturingCosts.perUnit.toFixed(3)}`, 20, yPosition);
                yPosition += 8;
            }

            if (currentCostAnalysis.packagingCosts) {
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('Packaging Costs', 20, yPosition);
                yPosition += 6;

                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                pdf.text(`Per Unit: $${currentCostAnalysis.packagingCosts.total.toFixed(2)}`, 20, yPosition);
                yPosition += 8;
            }

            // Profitability
            if (currentCostAnalysis.profitAnalysis) {
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('Profitability Analysis', 20, yPosition);
                yPosition += 8;

                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                const analysis = currentCostAnalysis.profitAnalysis;
                pdf.text(`Retail Price: $${analysis.retailPrice.toFixed(2)}`, 20, yPosition);
                pdf.text(`Net Price: $${analysis.netPrice.toFixed(2)}`, 80, yPosition);
                pdf.text(`Net Margin: ${analysis.netMargin.toFixed(1)}%`, 130, yPosition);
                yPosition += 10;
            }

            const fileName = `${productName.replace(/[^a-z0-9]/gi, '_')}_Cost_Analysis.pdf`;
            pdf.save(fileName);
        }

        // Data Management Functions
        function saveCostAnalysis() {
            const productName = document.getElementById('product-name').value || 'cost_analysis';
            
            const data = {
                analysis: currentCostAnalysis,
                productDetails: {
                    name: document.getElementById('product-name').value,
                    category: document.getElementById('product-category').value,
                    segment: document.getElementById('market-segment').value,
                    reportId: document.getElementById('report-id').value,
                    currency: document.getElementById('currency').value,
                    productionVolume: document.getElementById('production-volume').value,
                    costNotes: document.getElementById('cost-notes').value,
                    riskAssessment: document.getElementById('risk-assessment').value
                },
                timestamp: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${productName.replace(/[^a-z0-9]/gi, '_')}_cost_analysis.json`;
            link.click();
            
            URL.revokeObjectURL(link.href);
        }

        function loadCostAnalysis() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        currentCostAnalysis = data.analysis || {
                            materials: [],
                            manufacturingCosts: null,
                            packagingCosts: null,
                            profitAnalysis: null,
                            totalCOGS: 0
                        };
                        
                        if (data.productDetails) {
                            document.getElementById('product-name').value = data.productDetails.name || '';
                            document.getElementById('product-category').value = data.productDetails.category || 'skincare';
                            document.getElementById('market-segment').value = data.productDetails.segment || 'premium';
                            document.getElementById('report-id').value = data.productDetails.reportId || '';
                            document.getElementById('currency').value = data.productDetails.currency || 'USD';
                            document.getElementById('production-volume').value = data.productDetails.productionVolume || '10000';
                            document.getElementById('cost-notes').value = data.productDetails.costNotes || '';
                            document.getElementById('risk-assessment').value = data.productDetails.riskAssessment || '';
                        }
                        
                        updateMaterialsTable();
                        updateCostSummary();
                        
                        alert('Cost analysis loaded successfully!');
                        
                    } catch (error) {
                        console.error('Error loading analysis:', error);
                        alert('Error loading analysis file. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllCostData() {
            if (confirm('Are you sure you want to clear all data and start a new cost analysis?')) {
                currentCostAnalysis = {
                    materials: [],
                    manufacturingCosts: null,
                    packagingCosts: null,
                    profitAnalysis: null,
                    totalCOGS: 0
                };
                
                // Clear all form fields
                document.getElementById('product-name').value = '';
                document.getElementById('product-category').value = 'skincare';
                document.getElementById('market-segment').value = 'premium';
                document.getElementById('report-id').value = '';
                document.getElementById('currency').value = 'USD';
                document.getElementById('production-volume').value = '10000';
                document.getElementById('cost-notes').value = '';
                document.getElementById('risk-assessment').value = '';
                
                // Clear cost inputs
                document.getElementById('material-select').value = '';
                document.getElementById('material-quantity').value = '';
                document.getElementById('material-cost').value = '';
                document.getElementById('batch-size').value = '1000';
                document.getElementById('labor-cost').value = '50';
                document.getElementById('equipment-cost').value = '25';
                document.getElementById('qc-cost').value = '75';
                document.getElementById('primary-packaging').value = '';
                document.getElementById('primary-cost').value = '';
                document.getElementById('secondary-packaging').value = '';
                document.getElementById('secondary-cost').value = '';
                document.getElementById('labels-cost').value = '0.25';
                document.getElementById('retail-price').value = '';
                document.getElementById('retailer-margin').value = '50';
                document.getElementById('distributor-margin').value = '25';
                document.getElementById('marketing-percentage').value = '15';
                document.getElementById('overhead-percentage').value = '10';
                
                // Reset displays
                updateMaterialsTable();
                document.querySelectorAll('.category-badge').forEach(badge => badge.classList.remove('selected'));
                document.querySelectorAll('.result-display').forEach(div => div.style.display = 'none');
                document.getElementById('packaging-breakdown').innerHTML = 'Select packaging components to see cost analysis';
                document.getElementById('profitability-breakdown').style.display = 'none';
                document.getElementById('competitive-benchmarking').style.display = 'none';
                document.getElementById('cost-report-display').innerHTML = '';
                
                // Reset cost summary
                document.getElementById('total-cogs').textContent = '$0.00';
                document.getElementById('gross-margin').textContent = '0%';
                document.getElementById('net-profit').textContent = '$0.00';
                
                alert('Started new cost analysis!');
            }
        }

        // Utility Functions
        function selectTableRow(row, type, index) {
            const table = row.closest('table');
            table.querySelectorAll('tr').forEach(tr => tr.classList.remove('selected'));
            row.classList.add('selected');
            row.dataset.index = index;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeCostApp);
    </script>
</body>
</html>