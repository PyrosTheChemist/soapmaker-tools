<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLB Calculator - Philip Riachy, PhD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .signature {
            position: absolute;
            top: 15px;
            right: 30px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h3 {
            color: #2196F3;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin: 3px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #ff6b6b);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #2196F3;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr.selected {
            background: #e3f2fd;
        }

        .result-display {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin: 15px 0;
            display: none;
        }

        .result-display.error {
            background: linear-gradient(135deg, #f44336, #ff6b6b);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="signature">By Philip Riachy, PhD</div>
            <h1>HLB Calculator</h1>
            <p class="subtitle">Professional Cosmetic Formulation Tool</p>
        </div>

        <div class="main-content">
            <!-- Oil Selection Section -->
            <div class="section">
                <h3>ðŸ“Š Oil Phase</h3>
                <div class="form-group">
                    <label for="oil-select">Select Oil/Ingredient:</label>
                    <select id="oil-select" class="form-control">
                        <option value="">Choose an oil...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="oil-percentage">Percentage (%):</label>
                    <input type="number" id="oil-percentage" class="form-control" min="0" max="100" step="0.1" placeholder="Enter percentage">
                </div>
                <button onclick="addOil()" class="btn">Add Oil</button>
                <button onclick="clearOils()" class="btn btn-danger">Clear All</button>
                
                <table class="data-table" id="oils-table">
                    <thead>
                        <tr>
                            <th>Oil</th>
                            <th>%</th>
                            <th>rHLB</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="oils-tbody"></tbody>
                </table>

                <button onclick="calculateRequiredHLB()" class="btn btn-success">Calculate Required HLB</button>
                <div id="rhlb-result" class="result-display"></div>
            </div>

            <!-- Surfactant Selection Section -->
            <div class="section">
                <h3>ðŸ§ª Surfactant System</h3>
                <div class="form-group">
                    <label for="surfactant-1">Primary Surfactant:</label>
                    <select id="surfactant-1" class="form-control">
                        <option value="">Choose surfactant...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="surfactant-2">Secondary Surfactant:</label>
                    <select id="surfactant-2" class="form-control">
                        <option value="">Choose surfactant...</option>
                    </select>
                </div>
                <button onclick="calculateSurfactantRatios()" class="btn btn-success">Calculate Surfactant Ratios</button>
                <div id="surfactant-result" class="result-display"></div>

                <div class="form-group">
                    <label for="surfactant-total">Total Surfactant (% of oil phase):</label>
                    <input type="number" id="surfactant-total" class="form-control" value="25" min="0" max="100" step="1">
                </div>
                <button onclick="calculateWaterPhase()" class="btn btn-success">Calculate Water Phase</button>
                <div id="water-result" class="result-display"></div>
            </div>

            <!-- Other Ingredients Section -->
            <div class="section">
                <h3>âž• Other Ingredients</h3>
                <div class="form-group">
                    <label for="other-name">Ingredient Name:</label>
                    <input type="text" id="other-name" class="form-control" placeholder="e.g., Preservative, Fragrance">
                </div>
                <div class="form-group">
                    <label for="other-percentage">Percentage (%):</label>
                    <input type="number" id="other-percentage" class="form-control" min="0" max="100" step="0.1" placeholder="Enter percentage">
                </div>
                <button onclick="addOtherIngredient()" class="btn">Add Ingredient</button>
                <button onclick="clearOthers()" class="btn btn-danger">Clear All</button>
                
                <table class="data-table" id="others-table">
                    <thead>
                        <tr>
                            <th>Ingredient</th>
                            <th>%</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="others-tbody"></tbody>
                </table>
            </div>

            <!-- Full Formula Summary -->
            <div class="section full-width">
                <h3>ðŸ“‹ Complete Formula</h3>
                
                <div class="form-group">
                    <label for="formula-name">Formula Name:</label>
                    <input type="text" id="formula-name" class="form-control" placeholder="Enter formula name">
                </div>
                
                <div class="form-group">
                    <label for="formula-id">Formula ID:</label>
                    <input type="text" id="formula-id" class="form-control" placeholder="e.g., F001, CR-2024-01">
                </div>

                <div class="form-group">
                    <label for="formula-version">Version:</label>
                    <input type="text" id="formula-version" class="form-control" placeholder="e.g., v1.0, Draft, Final">
                </div>

                <div class="form-group">
                    <label for="batch-size">Batch Size (g):</label>
                    <input type="number" id="batch-size" class="form-control" value="100" min="1" step="1">
                </div>

                <div class="form-group">
                    <label for="formula-notes">Notes:</label>
                    <textarea id="formula-notes" class="form-control" rows="3" placeholder="Add any notes about this formulation..."></textarea>
                </div>

                <button onclick="generateRecipe()" class="btn btn-success">Generate Recipe</button>
                <button onclick="exportToPDF()" class="btn">Export to PDF</button>
                <button onclick="saveFormulation()" class="btn">Save Formulation</button>
                <button onclick="loadFormulation()" class="btn">Load Formulation</button>
                <button onclick="clearAllData()" class="btn btn-danger">Clear All & Start New</button>
                
                <div id="recipe-display"></div>
            </div>
        </div>
    </div>

    <script>
        // Complete Oil Database with rHLB values from the PDF
        const OILS_DATABASE = {
            "Andiroba Oil": 16.70,
            "Apricot Kernel Oil": 7.00,
            "Argan Oil": 11.00,
            "Astaxanthin Oleoresin": 10.81,
            "Avocado Oil": 7.00,
            "Babassu Oil": 8.00,
            "Beeswax": 12.00,
            "Behenyl Alcohol": 16.00,
            "Black Cumin Seed Oil": 16.00,
            "Borage Seed Oil": 7.00,
            "Brazil Nut Oil": 8.00,
            "Butyl Methoxydibenzoylmethane": 13.40,
            "Butyl Stearate": 11.00,
            "C12-15 Alkyl Benzoate": 13.00,
            "Camelina Oil": 7.00,
            "Candelilla Wax": 14.50,
            "Canola Oil": 6.00,
            "Caprylic/Capric Triglyceride": 5.00,
            "Cardamom Seed Oil": 11.00,
            "Carnauba Wax": 15.00,
            "Carrot Oil": 6.00,
            "Castor Oil": 14.00,
            "Ceresin Wax": 8.00,
            "Cetearyl Alcohol": 15.50,
            "Cetearyl Ethylhexanoate": 8.22,
            "Cetyl Alcohol": 15.50,
            "Cetyl Esters": 10.00,
            "Cetyl Ethylhexanoate": 1.00,
            "Cetyl Palmitate": 10.00,
            "Chia Seed Oil": 12.90,
            "Citronella Herb Oil": 12.60,
            "Coco-Caprylate/Caprate": 5.00,
            "Cocoa Butter": 6.00,
            "Coconut Oil": 8.00,
            "Corn Oil": 10.00,
            "Cottonseed Oil": 5.50,
            "Cyclohexane": 15.00,
            "Cyclomethicone": 7.50,
            "Cyclopentasiloxane": 7.50,
            "Decyl Acetate": 11.00,
            "Decyl Alcohol": 15.00,
            "Diisooctyl Phthalate": 13.00,
            "Diisopropyl Adipate": 9.00,
            "Diisopropyl Benzene": 15.00,
            "Dimethicone": 5.00,
            "Dimethyl Silicone": 9.00,
            "Emu Oil": 8.00,
            "Ethyl Benzoate": 13.00,
            "Ethylhexyl Isononanoate": 9.00,
            "Ethylhexyl Methoxycinnamate": 6.00,
            "Ethylhexyl Methoxycrylene": 8.00,
            "Ethylhexyl Palmitate": 8.00,
            "Ethylhexyl Salicylate": 6.00,
            "Eucalyptus Leaf Oil": 9.80,
            "Eugenol Oil": 6.00,
            "Evening Primrose Oil": 7.00,
            "Geranium Oil": 12.00,
            "Glyceryl Tricaprylate/Caprate": 11.00,
            "Grape Seed Oil": 7.00,
            "Hazelnut Oil": 11.70,
            "Hemp Seed Oil": 7.00,
            "Hexadecyl Alcohol": 11.50,
            "Hybrid Safflower Oil": 9.00,
            "Hydrogenated Vegetable Oil": 3.00,
            "Isodecyl Alcohol": 14.00,
            "Isohexadecyl Alcohol": 11.50,
            "Isononyl Isononanoate": 2.00,
            "Isopropyl Lanolate": 14.00,
            "Isopropyl Myristate": 11.50,
            "Isopropyl Palmitate": 11.50,
            "Isostearic Acid": 15.50,
            "Isostearyl Isostearate": 11.00,
            "Jojoba Seed Oil": 6.00,
            "Karanja Seed Oil": 8.00,
            "Kokum Seed Butter": 8.00,
            "Kukui Nut Oil": 7.00,
            "Lanolin": 10.00,
            "Laurel Oil": 8.00,
            "Lauric Acid": 16.00,
            "Lauryl Alcohol": 14.00,
            "Lauryl PEG-9 Polydimethylsiloxyethyl Dimethicone": 3.00,
            "Lavender Oil": 12.00,
            "Lemon Peel Oil": 12.00,
            "Lignoceryl Erucate": 6.81,
            "Linoleic Acid": 16.00,
            "Linseed Oil": 3.23,
            "Liquid Paraffin": 11.80,
            "Macadamia Nut Oil": 7.00,
            "Mango Seed Butter": 8.00,
            "Mango Seed Oil": 7.00,
            "Meadowfoam Seed Oil": 6.00,
            "Methyl Phenyl Silicone": 7.00,
            "Methyl Silicone": 11.00,
            "Mineral Oil": 10.00,
            "Myristyl Myristate": 7.52,
            "Neem Oil": 9.00,
            "Octyldodecanol": 10.90,
            "Oleic Acid": 17.00,
            "Oleyl Alcohol": 13.50,
            "Olive Oil": 7.00,
            "Palm Oil": 10.00,
            "Palmitic Acid": 11.50,
            "Paraffin Wax": 10.00,
            "Passion Fruit Seed Oil": 15.00,
            "Peanut Oil": 6.00,
            "PEG-3 Dimethicone": 4.50,
            "PEG-9 Dimethicone": 10.00,
            "PEG-9 Methyl Ether Dimethicone": 4.50,
            "PEG-9 Polydimethylsiloxyethyl Dimethicone": 4.00,
            "PEG-10 Dimethicone": 4.50,
            "PEG-11 Methyl Ether Dimethicone": 14.50,
            "PEG-32 Methyl Ether Dimethicone": 9.00,
            "PEG/PPG-20/22 Butyl Ether Dimethicone": 7.00,
            "Pentaerythrityl Tetraisostearate": 7.67,
            "Peppermint Oil": 12.30,
            "Petrolatum": 7.50,
            "Pistachio Seed Oil": 7.00,
            "Polyethylene Glycol": 20.00,
            "Polyethylene Wax": 15.00,
            "PPG-2 Myristyl Ether Propionate": 8.03,
            "PPG-3 Benzyl Ether Myristate": 13.49,
            "PPG-15 Stearyl Ether": 7.00,
            "Red Raspberry Seed Oil": 7.00,
            "Retinyl Palmitate": 6.00,
            "Rice Bran Oil": 7.00,
            "Ricinoleic Acid": 16.00,
            "Rose Hips Oil": 7.00,
            "Rosemary Leaf Extract": 7.00,
            "Rosemary Oil": 15.00,
            "Sacha Inchi Seed Oil": 8.50,
            "Safflower Oil": 8.00,
            "Sesame Oil": 7.00,
            "Shea Butter": 8.00,
            "Soybean Oil": 6.00,
            "Squalane": 7.00,
            "Star Anise Oil": 16.50,
            "Stearic Acid": 15.00,
            "Stearyl Alcohol": 15.50,
            "Sunflower Seed Oil": 7.00,
            "Sweet Almond Oil": 7.00,
            "Tamanu Seed Oil": 8.00,
            "Thyme Oil": 9.30,
            "Tocopherol": 6.00,
            "Tricresyl Phosphate": 17.00,
            "Tridecyl Alcohol": 14.00,
            "Tridecyl Neopentanoate": 9.88,
            "Wheat Germ Oil": 7.00
        };

        // Complete Surfactant Database with HLB values from the PDF
        const SURFACTANTS_DATABASE = {
            "Beheneth-5": 7.00,
            "Beheneth-10": 10.00,
            "Beheneth-20": 16.50,
            "Beheneth-25": 15.50,
            "Beheneth-30": 18.00,
            "Butylene Glycol": 8.90,
            "C9-11 Pareth-3": 12.40,
            "Calcium Stearoyl Lactylate": 5.10,
            "Ceteareth-6": 10.50,
            "Ceteareth-6 + Stearyl Alcohol": 11.00,
            "Ceteareth-12": 13.50,
            "Ceteareth-15": 14.50,
            "Ceteareth-20": 15.20,
            "Ceteareth-25": 16.50,
            "Ceteareth-30": 16.50,
            "Ceteareth-100": 18.50,
            "Cetearyl Alcohol + Ceteareth-20": 6.00,
            "Cetearyl Alcohol + PEG-40 Castor Oil + Sodium Cetearyl Sulfate": 10.50,
            "Cetearyl Alcohol + Polysorbate 60 (Lanette Wax ES)": 12.50,
            "Cetearyl Alcohol + Polysorbate 60 (Emulsifying Wax NF)": 14.90,
            "Cetearyl Glucoside": 11.00,
            "Cetearyl Glucoside + Cetearyl Alcohol": 11.00,
            "Cetearyl Isononanoate": 4.50,
            "Cetearyl Olivate + Sorbitan Olivate": 9.00,
            "Cetearyl Wheat Straw Glycosides + Cetearyl Alcohol": 8.00,
            "Ceteth-2": 5.30,
            "Ceteth-10": 12.90,
            "Ceteth-20": 15.70,
            "Cetrimonium Chloride": 15.00,
            "Cetyl PEG/PPG-10/1 Dimethicone": 5.00,
            "Cocamide DEA": 12.56,
            "Cocamide MEA": 13.50,
            "Coco Glucoside": 13.00,
            "Decyl Glucoside": 13.50,
            "Diacetyl Tartaric Acid Esters of Mono- and Diglycerides": 9.00,
            "Diethylene Glycol Monoethyl Ether": 4.20,
            "Dimethyl Isosorbide": 8.40,
            "Erythorbyl Laurate": 15.25,
            "Ethylene Glycol": 9.85,
            "Ethylhexyl Stearate": 8.00,
            "Glyceryl Caprylate": 6.00,
            "Glyceryl Laurate": 5.40,
            "Glyceryl Oleate": 3.50,
            "Glyceryl Oleate Citrate": 13.00,
            "Glyceryl Stearate": 3.80,
            "Glyceryl Stearate + PEG-100 Stearate": 11.50,
            "Glyceryl Stearate Citrate": 12.00,
            "Glyceryl Stearate SE": 6.00,
            "Glyceryl Stearate SE + Sucrose Stearate": 13.00,
            "Glycol Distearate": 5.50,
            "Glycol Stearate": 2.90,
            "Hexylene Glycol": 7.95,
            "Isoamyl Laurate": 1.80,
            "Isoceteth-20": 15.70,
            "Isosteareth-20": 15.00,
            "Lauramide DEA": 15.00,
            "Laureth-1": 3.50,
            "Laureth-2": 6.00,
            "Laureth-3": 8.00,
            "Laureth-4": 9.70,
            "Laureth-5": 10.50,
            "Laureth-7": 12.00,
            "Laureth-9": 13.00,
            "Laureth-23": 16.90,
            "Lauroyl Polyoxyl-32 Glycerides": 11.00,
            "Lauryl Glucoside": 11.50,
            "Lecithin": 4.00,
            "Linoleamide DEA": 10.00,
            "Lysolecithin": 11.50,
            "Methyl Glucose Sesquistearate": 12.00,
            "Methyl Laurate": 3.70,
            "Monolaurin": 7.03,
            "Octoxynol-40": 19.00,
            "Oleoyl Polyoxyl-6 Glycerides": 9.00,
            "Oleth-2": 4.90,
            "Oleth-5": 9.50,
            "Oleth-10": 12.40,
            "Oleth-20": 15.30,
            "Oleth-30": 16.80,
            "Olive Oil PEG-7 Esters": 11.00,
            "PEG-4 Dilaurate": 6.00,
            "PEG-7 Glyceryl Cocoate": 10.00,
            "PEG-7 Olivate": 11.00,
            "PEG-8 Beeswax": 9.00,
            "PEG-8 Dioleate": 8.00,
            "PEG-8 Laurate": 13.00,
            "PEG-8 Oleate": 11.60,
            "PEG-12 Dimethicone": 12.00,
            "PEG-20 Almond Glycerides": 10.00,
            "PEG-20 Glyceryl Stearate": 15.00,
            "PEG-20 Methyl Glucose Sesquistearate": 15.00,
            "PEG-25 Hydrogenated Castor Oil": 10.80,
            "PEG-30 Dipolyhydroxystearate": 5.50,
            "PEG-32 Hydrogenated Palm Glycerides": 11.00,
            "PEG-40 Hydrogenated Castor Oil": 15.00,
            "PEG-40 Sorbitan Peroleate": 9.00,
            "PEG-60 Almond Glycerides": 15.00,
            "PEG-80 Sorbitan Laurate": 19.10,
            "PEG-100 Stearate": 18.80,
            "Pentylene Glycol": 8.42,
            "Polyethylene Glycol Octyl Ether": 13.40,
            "Polyglyceryl-3 Beeswax": 4.50,
            "Polyglyceryl-3 Methylglucose Distearate": 12.00,
            "Polyglyceryl-3 Oleate": 5.50,
            "Polyglyceryl-4 Laurate": 10.00,
            "Polyglyceryl-4 Oleate": 4.00,
            "Polyglyceryl-6 Polyhydroxystearate + Polyglyceryl-6 Polyricinoleate": 4.50,
            "Polyglyceryl-6 Stearate + Polyglyceryl-6 Behenate": 13.00,
            "Polyglyceryl-10 Caprylate": 16.50,
            "Polyglyceryl-10 Caprylate/Caprate": 14.50,
            "Polyglyceryl-10 Laurate": 12.00,
            "Polyglyceryl-10 Oleate": 9.00,
            "Polyoxyl 20 Cetostearyl Ether": 15.70,
            "Polyoxyl Castor Oil": 13.00,
            "Polysorbate 20": 16.67,
            "Polysorbate 22": 15.00,
            "Polysorbate 23": 16.00,
            "Polysorbate 24": 17.00,
            "Polysorbate 60": 14.90,
            "Polysorbate 80": 15.00,
            "Polysorbate 85": 11.00,
            "Potassium Cetyl Phosphate": 9.60,
            "PPG-26 Buteth-26 + PEG-40 Hydrogenated Castor Oil": 15.50,
            "Propylene Glycol": 9.38,
            "Propylene Glycol Isostearate": 2.50,
            "Propylene Glycol Mono and Dicaprylate": 6.00,
            "Propylene Glycol Monocaprylate": 5.00,
            "Propylene Glycol Monostearate": 3.80,
            "Sesamol Laurate": 4.83,
            "Sodium Caseinate": 14.00,
            "Sodium Dioctyl Sulfosuccinate": 10.00,
            "Sodium Dodecylbenzenesulfonate": 10.60,
            "Sodium Stearoyl Lactylate": 8.30,
            "Sorbeth-6 Beeswax": 7.50,
            "Sorbeth-6 Laurate": 15.50,
            "Sorbeth-6 Tetraoleate": 8.50,
            "Sorbeth-20 Beeswax": 9.50,
            "Sorbeth-30 Tetraoleate": 11.50,
            "Sorbeth-40 Tetraoleate": 12.50,
            "Sorbeth-60 Tetraoleate": 14.00,
            "Sorbitan Isostearate": 4.70,
            "Sorbitan Laurate": 8.60,
            "Sorbitan Monolaurate": 9.00,
            "Sorbitan Monooleate": 4.00,
            "Sorbitan Monostearate": 5.00,
            "Sorbitan Oleate": 4.30,
            "Sorbitan Olivate": 4.50,
            "Sorbitan Palmitate": 6.70,
            "Sorbitan Sesquioleate": 3.70,
            "Sorbitan Stearate + Sucrose Cocoate": 6.00,
            "Sorbitan Trioleate": 2.00,
            "Sorbitan Tristearate": 2.00,
            "Stearamide MEA": 11.00,
            "Steareth-2": 6.00,
            "Steareth-20": 15.30,
            "Steareth-21": 16.00,
            "Steareth-100": 18.80,
            "Sucrose Monolaurate": 16.09,
            "Sucrose Stearate": 13.00,
            "Trideceth-9 + PEG-40 Hydrogenated Castor Oil": 13.40,
            "Tridecyl Stearate": 7.50
        };

        // Application State
        let currentFormulation = {
            oils: [],
            others: [],
            requiredHLB: null,
            surfactantSystem: null
        };

        // Initialize Application
        function initializeApp() {
            console.log('Initializing HLB Calculator...');
            
            populateDropdowns();
            setupEventListeners();
            
            console.log('HLB Calculator ready!');
        }

        // Populate dropdowns with database
        function populateDropdowns() {
            const oilSelect = document.getElementById('oil-select');
            const surf1Select = document.getElementById('surfactant-1');
            const surf2Select = document.getElementById('surfactant-2');

            // Sort and populate oils
            const sortedOils = Object.keys(OILS_DATABASE).sort();
            sortedOils.forEach(oil => {
                const option = document.createElement('option');
                option.value = oil;
                option.textContent = `${oil} (rHLB: ${OILS_DATABASE[oil]})`;
                oilSelect.appendChild(option);
            });

            // Sort and populate surfactants
            const sortedSurfactants = Object.keys(SURFACTANTS_DATABASE).sort();
            sortedSurfactants.forEach(surf => {
                const option1 = document.createElement('option');
                option1.value = surf;
                option1.textContent = `${surf} (HLB: ${SURFACTANTS_DATABASE[surf]})`;
                surf1Select.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = surf;
                option2.textContent = `${surf} (HLB: ${SURFACTANTS_DATABASE[surf]})`;
                surf2Select.appendChild(option2);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Allow Enter key to trigger actions
            document.getElementById('oil-percentage').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addOil();
            });

            document.getElementById('other-percentage').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addOtherIngredient();
            });
        }

        // Oil Functions
        function addOil() {
            const oilSelect = document.getElementById('oil-select');
            const oilPercentage = parseFloat(document.getElementById('oil-percentage').value);

            if (!oilSelect.value) {
                alert('Please select an oil');
                return;
            }

            if (!oilPercentage || oilPercentage <= 0 || oilPercentage > 100) {
                alert('Please enter a valid percentage (0-100)');
                return;
            }

            const totalPercentage = currentFormulation.oils.reduce((sum, oil) => sum + oil.percentage, 0) + oilPercentage;
            if (totalPercentage > 100) {
                alert('Total oil percentage cannot exceed 100%');
                return;
            }

            currentFormulation.oils.push({
                name: oilSelect.value,
                percentage: oilPercentage,
                rhlb: OILS_DATABASE[oilSelect.value]
            });

            updateOilsTable();
            oilSelect.value = '';
            document.getElementById('oil-percentage').value = '';
            
            // Clear required HLB when oils change
            currentFormulation.requiredHLB = null;
            document.getElementById('rhlb-result').style.display = 'none';
        }

        function updateOilsTable() {
            const tbody = document.getElementById('oils-tbody');
            tbody.innerHTML = '';

            currentFormulation.oils.forEach((oil, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${oil.name}</td>
                    <td>${oil.percentage.toFixed(1)}%</td>
                    <td>${oil.rhlb}</td>
                    <td><button onclick="removeOil(${index})" class="btn btn-danger">Remove</button></td>
                `;
            });
        }

        function removeOil(index) {
            currentFormulation.oils.splice(index, 1);
            updateOilsTable();
            
            // Clear required HLB when oils change
            currentFormulation.requiredHLB = null;
            document.getElementById('rhlb-result').style.display = 'none';
        }

        function clearOils() {
            if (confirm('Are you sure you want to clear all oils?')) {
                currentFormulation.oils = [];
                updateOilsTable();
                currentFormulation.requiredHLB = null;
                document.getElementById('rhlb-result').style.display = 'none';
            }
        }

        function calculateRequiredHLB() {
            if (currentFormulation.oils.length === 0) {
                alert('Please add oils to your formulation first');
                return;
            }

            const totalPercentage = currentFormulation.oils.reduce((sum, oil) => sum + oil.percentage, 0);
            const weightedRHLB = currentFormulation.oils.reduce((sum, oil) => 
                sum + (oil.rhlb * oil.percentage / totalPercentage), 0);

            currentFormulation.requiredHLB = weightedRHLB;

            const resultDiv = document.getElementById('rhlb-result');
            resultDiv.innerHTML = `Required HLB: ${weightedRHLB.toFixed(2)}`;
            resultDiv.className = 'result-display';
            resultDiv.style.display = 'block';
        }

        // Surfactant Functions
        function calculateSurfactantRatios() {
            if (!currentFormulation.requiredHLB) {
                alert('Please calculate the Required HLB first');
                return;
            }

            const surf1Name = document.getElementById('surfactant-1').value;
            const surf2Name = document.getElementById('surfactant-2').value;

            if (!surf1Name || !surf2Name) {
                alert('Please select two surfactants');
                return;
            }

            if (surf1Name === surf2Name) {
                alert('Please select two different surfactants');
                return;
            }

            const surf1HLB = SURFACTANTS_DATABASE[surf1Name];
            const surf2HLB = SURFACTANTS_DATABASE[surf2Name];
            const targetHLB = currentFormulation.requiredHLB;

            if (surf1HLB === surf2HLB) {
                alert('Selected surfactants have the same HLB value. Please choose different ones.');
                return;
            }

            // Calculate ratios
            const surf1Ratio = (surf2HLB - targetHLB) / (surf2HLB - surf1HLB);
            const surf2Ratio = 1 - surf1Ratio;

            if (surf1Ratio < 0 || surf1Ratio > 1) {
                alert('The required HLB is outside the range of the selected surfactants. Please choose different surfactants.');
                return;
            }

            currentFormulation.surfactantSystem = {
                surfactant1: { name: surf1Name, hlb: surf1HLB, ratio: surf1Ratio },
                surfactant2: { name: surf2Name, hlb: surf2HLB, ratio: surf2Ratio }
            };

            const resultDiv = document.getElementById('surfactant-result');
            resultDiv.innerHTML = `
                <strong>Surfactant Ratios:</strong><br>
                ${surf1Name}: ${(surf1Ratio * 100).toFixed(1)}%<br>
                ${surf2Name}: ${(surf2Ratio * 100).toFixed(1)}%
            `;
            resultDiv.className = 'result-display';
            resultDiv.style.display = 'block';
        }

        function calculateWaterPhase() {
            if (!currentFormulation.surfactantSystem) {
                alert('Please calculate surfactant ratios first');
                return;
            }

            const oilTotal = currentFormulation.oils.reduce((sum, oil) => sum + oil.percentage, 0);
            const surfactantPercent = parseFloat(document.getElementById('surfactant-total').value);
            const surfactantTotal = (oilTotal * surfactantPercent) / 100;
            const othersTotal = currentFormulation.others.reduce((sum, item) => sum + item.percentage, 0);
            const waterPhase = 100 - oilTotal - surfactantTotal - othersTotal;

            if (waterPhase < 0) {
                const resultDiv = document.getElementById('water-result');
                resultDiv.innerHTML = 'Error: Total exceeds 100%. Please adjust your formulation.';
                resultDiv.className = 'result-display error';
                resultDiv.style.display = 'block';
                return;
            }

            const resultDiv = document.getElementById('water-result');
            resultDiv.innerHTML = `Water Phase: ${waterPhase.toFixed(1)}%`;
            resultDiv.className = 'result-display';
            resultDiv.style.display = 'block';
        }

        // Other Ingredients Functions
        function addOtherIngredient() {
            const name = document.getElementById('other-name').value.trim();
            const percentage = parseFloat(document.getElementById('other-percentage').value);

            if (!name) {
                alert('Please enter an ingredient name');
                return;
            }

            if (!percentage || percentage <= 0 || percentage > 100) {
                alert('Please enter a valid percentage (0-100)');
                return;
            }

            currentFormulation.others.push({
                name: name,
                percentage: percentage
            });

            updateOthersTable();
            document.getElementById('other-name').value = '';
            document.getElementById('other-percentage').value = '';
        }

        function updateOthersTable() {
            const tbody = document.getElementById('others-tbody');
            tbody.innerHTML = '';

            currentFormulation.others.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.percentage.toFixed(1)}%</td>
                    <td><button onclick="removeOther(${index})" class="btn btn-danger">Remove</button></td>
                `;
            });
        }

        function removeOther(index) {
            currentFormulation.others.splice(index, 1);
            updateOthersTable();
        }

        function clearOthers() {
            if (confirm('Are you sure you want to clear all other ingredients?')) {
                currentFormulation.others = [];
                updateOthersTable();
            }
        }

        // Recipe Generation
        function generateRecipe() {
            if (currentFormulation.oils.length === 0 || !currentFormulation.surfactantSystem) {
                alert('Please complete your formulation (oils and surfactants) first');
                return;
            }

            const batchSize = parseFloat(document.getElementById('batch-size').value) || 100;
            const oilTotal = currentFormulation.oils.reduce((sum, oil) => sum + oil.percentage, 0);
            const surfactantPercent = parseFloat(document.getElementById('surfactant-total').value);
            const surfactantTotal = (oilTotal * surfactantPercent) / 100;
            const othersTotal = currentFormulation.others.reduce((sum, item) => sum + item.percentage, 0);
            const waterPhase = 100 - oilTotal - surfactantTotal - othersTotal;

            if (waterPhase < 0) {
                alert('Error: Total exceeds 100%. Please adjust your formulation.');
                return;
            }

            let recipe = '<div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">';
            recipe += '<h3 style="color: #2196F3; margin-bottom: 15px;">Formula Recipe</h3>';
            
            // Oil Phase
            recipe += '<h4 style="color: #495057; margin: 15px 0 10px 0;">Oil Phase (' + oilTotal.toFixed(1) + '%)</h4>';
            recipe += '<ul style="list-style: none; padding: 0;">';
            currentFormulation.oils.forEach(oil => {
                const weight = (oil.percentage * batchSize / 100).toFixed(2);
                recipe += `<li style="padding: 5px 0;">${oil.name}: ${oil.percentage.toFixed(1)}% (${weight}g)</li>`;
            });
            recipe += '</ul>';

            // Surfactant Phase
            recipe += '<h4 style="color: #495057; margin: 15px 0 10px 0;">Surfactant Phase (' + surfactantTotal.toFixed(1) + '%)</h4>';
            recipe += '<ul style="list-style: none; padding: 0;">';
            const surf1Weight = (surfactantTotal * currentFormulation.surfactantSystem.surfactant1.ratio * batchSize / 100).toFixed(2);
            const surf2Weight = (surfactantTotal * currentFormulation.surfactantSystem.surfactant2.ratio * batchSize / 100).toFixed(2);
            recipe += `<li style="padding: 5px 0;">${currentFormulation.surfactantSystem.surfactant1.name}: ${(currentFormulation.surfactantSystem.surfactant1.ratio * 100).toFixed(1)}% of surfactants (${surf1Weight}g)</li>`;
            recipe += `<li style="padding: 5px 0;">${currentFormulation.surfactantSystem.surfactant2.name}: ${(currentFormulation.surfactantSystem.surfactant2.ratio * 100).toFixed(1)}% of surfactants (${surf2Weight}g)</li>`;
            recipe += '</ul>';

            // Water Phase
            recipe += '<h4 style="color: #495057; margin: 15px 0 10px 0;">Water Phase (' + waterPhase.toFixed(1) + '%)</h4>';
            const waterWeight = (waterPhase * batchSize / 100).toFixed(2);
            recipe += `<p style="padding: 5px 0;">Water: ${waterPhase.toFixed(1)}% (${waterWeight}g)</p>`;

            // Other Ingredients
            if (currentFormulation.others.length > 0) {
                recipe += '<h4 style="color: #495057; margin: 15px 0 10px 0;">Other Ingredients (' + othersTotal.toFixed(1) + '%)</h4>';
                recipe += '<ul style="list-style: none; padding: 0;">';
                currentFormulation.others.forEach(item => {
                    const weight = (item.percentage * batchSize / 100).toFixed(2);
                    recipe += `<li style="padding: 5px 0;">${item.name}: ${item.percentage.toFixed(1)}% (${weight}g)</li>`;
                });
                recipe += '</ul>';
            }

            recipe += '</div>';

            document.getElementById('recipe-display').innerHTML = recipe;
        }

        // Export to PDF
        function exportToPDF() {
            if (!window.jspdf) {
                alert('PDF library not loaded. Please refresh the page and try again.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            const formulaName = document.getElementById('formula-name').value || 'Untitled Formula';
            const batchSize = parseFloat(document.getElementById('batch-size').value) || 100;
            const notes = document.getElementById('formula-notes').value.trim();

            let yPosition = 20;

            // Header
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text(formulaName, 20, yPosition);
            yPosition += 15;

            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.text('HLB Calculator - Philip Riachy, PhD', 150, 15);
            pdf.text(`Date: ${new Date().toLocaleDateString()}`, 20, yPosition);
            pdf.text(`Batch Size: ${batchSize}g`, 20, yPosition + 5);
            pdf.text(`Required HLB: ${currentFormulation.requiredHLB.toFixed(2)}`, 20, yPosition + 10);
            yPosition += 25;

            // Oil Phase
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            const oilTotal = currentFormulation.oils.reduce((sum, oil) => sum + oil.percentage, 0);
            pdf.text(`Oil Phase (${oilTotal.toFixed(1)}%)`, 20, yPosition);
            yPosition += 10;

            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            currentFormulation.oils.forEach(oil => {
                const weight = (oil.percentage * batchSize / 100).toFixed(1);
                pdf.text(`${oil.name}`, 20, yPosition);
                pdf.text(`${oil.percentage.toFixed(1)}%`, 100, yPosition);
                pdf.text(`${weight}g`, 130, yPosition);
                yPosition += 5;
            });
            yPosition += 5;

            // Surfactant Phase
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            const surfactantPercent = parseFloat(document.getElementById('surfactant-total').value);
            const surfactantTotal = (oilTotal * surfactantPercent) / 100;
            pdf.text(`Surfactant Phase (${surfactantTotal.toFixed(1)}%)`, 20, yPosition);
            yPosition += 10;

            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            const surf1Weight = (surfactantTotal * currentFormulation.surfactantSystem.surfactant1.ratio * batchSize / 100).toFixed(1);
            const surf2Weight = (surfactantTotal * currentFormulation.surfactantSystem.surfactant2.ratio * batchSize / 100).toFixed(1);
            pdf.text(currentFormulation.surfactantSystem.surfactant1.name, 20, yPosition);
            pdf.text(`${(currentFormulation.surfactantSystem.surfactant1.ratio * 100).toFixed(1)}%`, 100, yPosition);
            pdf.text(`${surf1Weight}g`, 130, yPosition);
            yPosition += 5;
            pdf.text(currentFormulation.surfactantSystem.surfactant2.name, 20, yPosition);
            pdf.text(`${(currentFormulation.surfactantSystem.surfactant2.ratio * 100).toFixed(1)}%`, 100, yPosition);
            pdf.text(`${surf2Weight}g`, 130, yPosition);
            yPosition += 10;

            // Water Phase
            const othersTotal = currentFormulation.others.reduce((sum, item) => sum + item.percentage, 0);
            const waterPhase = 100 - oilTotal - surfactantTotal - othersTotal;
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text(`Water Phase (${waterPhase.toFixed(1)}%)`, 20, yPosition);
            yPosition += 10;

            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            const waterWeight = (waterPhase * batchSize / 100).toFixed(1);
            pdf.text('Water', 20, yPosition);
            pdf.text(`${waterPhase.toFixed(1)}%`, 100, yPosition);
            pdf.text(`${waterWeight}g`, 130, yPosition);
            yPosition += 10;

            // Other Ingredients
            if (currentFormulation.others.length > 0) {
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text(`Other Ingredients (${othersTotal.toFixed(1)}%)`, 20, yPosition);
                yPosition += 10;

                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                currentFormulation.others.forEach(item => {
                    const weight = (item.percentage * batchSize / 100).toFixed(1);
                    pdf.text(item.name, 20, yPosition);
                    pdf.text(`${item.percentage.toFixed(1)}%`, 100, yPosition);
                    pdf.text(`${weight}g`, 130, yPosition);
                    yPosition += 5;
                });
            }

            // Notes
            if (notes) {
                yPosition += 10;
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('Notes:', 20, yPosition);
                yPosition += 10;
                
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                const splitNotes = pdf.splitTextToSize(notes, 170);
                pdf.text(splitNotes, 20, yPosition);
            }

            pdf.save(`${formulaName.replace(/[^a-z0-9]/gi, '_')}.pdf`);
        }

        // Save/Load Functions
        function saveFormulation() {
            const formulaName = document.getElementById('formula-name').value || 'Untitled';
            
            const data = {
                formulation: currentFormulation,
                formulaDetails: {
                    name: formulaName,
                    id: document.getElementById('formula-id').value,
                    version: document.getElementById('formula-version').value,
                    batchSize: document.getElementById('batch-size').value,
                    surfactantRatio: document.getElementById('surfactant-total').value,
                    notes: document.getElementById('formula-notes').value
                },
                timestamp: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${formulaName.replace(/[^a-z0-9]/gi, '_')}_formulation.json`;
            link.click();
            
            URL.revokeObjectURL(link.href);
        }

        function loadFormulation() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        currentFormulation = data.formulation || {
                            oils: [],
                            others: [],
                            requiredHLB: null,
                            surfactantSystem: null
                        };
                        
                        if (data.formulaDetails) {
                            document.getElementById('formula-name').value = data.formulaDetails.name || '';
                            document.getElementById('formula-id').value = data.formulaDetails.id || '';
                            document.getElementById('formula-version').value = data.formulaDetails.version || '';
                            document.getElementById('batch-size').value = data.formulaDetails.batchSize || '100';
                            document.getElementById('surfactant-total').value = data.formulaDetails.surfactantRatio || '25';
                            document.getElementById('formula-notes').value = data.formulaDetails.notes || '';
                        }
                        
                        updateOilsTable();
                        updateOthersTable();
                        
                        if (currentFormulation.requiredHLB) {
                            const rhlbDiv = document.getElementById('rhlb-result');
                            rhlbDiv.innerHTML = `Required HLB: ${currentFormulation.requiredHLB.toFixed(2)}`;
                            rhlbDiv.className = 'result-display';
                            rhlbDiv.style.display = 'block';
                        }
                        
                        if (currentFormulation.surfactantSystem) {
                            const surfDiv = document.getElementById('surfactant-result');
                            const system = currentFormulation.surfactantSystem;
                            surfDiv.innerHTML = `
                                <strong>Surfactant Ratios:</strong><br>
                                ${system.surfactant1.name}: ${(system.surfactant1.ratio * 100).toFixed(1)}%<br>
                                ${system.surfactant2.name}: ${(system.surfactant2.ratio * 100).toFixed(1)}%
                            `;
                            surfDiv.className = 'result-display';
                            surfDiv.style.display = 'block';
                        }
                        
                        alert('Formulation loaded successfully!');
                        
                    } catch (error) {
                        console.error('Error loading formulation:', error);
                        alert('Error loading formulation file. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data and start a new formulation?')) {
                currentFormulation = {
                    oils: [],
                    others: [],
                    requiredHLB: null,
                    surfactantSystem: null
                };
                
                document.getElementById('formula-name').value = '';
                document.getElementById('formula-id').value = '';
                document.getElementById('formula-version').value = '';
                document.getElementById('batch-size').value = '100';
                document.getElementById('surfactant-total').value = '25';
                document.getElementById('formula-notes').value = '';
                
                document.getElementById('oil-select').value = '';
                document.getElementById('oil-percentage').value = '';
                document.getElementById('surfactant-1').value = '';
                document.getElementById('surfactant-2').value = '';
                document.getElementById('other-name').value = '';
                document.getElementById('other-percentage').value = '';
                
                updateOilsTable();
                updateOthersTable();
                document.getElementById('rhlb-result').style.display = 'none';
                document.getElementById('surfactant-result').style.display = 'none';
                document.getElementById('water-result').style.display = 'none';
                document.getElementById('recipe-display').innerHTML = '';
                
                alert('Started new formulation!');
            }
        }

        // Initialize on page load
        window.onload = initializeApp;
    </script>
</body>
</html>
