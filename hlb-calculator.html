<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLB Calculator - Philip Riachy, PhD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .signature {
            position: absolute;
            top: 15px;
            right: 30px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h3 {
            color: #2196F3;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin: 3px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #ff6b6b);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #2196F3;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr.selected {
            background: #e3f2fd;
        }

        .result-display {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin: 15px 0;
            display: none;
        }

        .result-display.error {
            background: linear-gradient(135deg, #f44336, #ff6b6b);
        }

        .recipe-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .recipe-form {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .recipe-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .recipe-output {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .recipe-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .recipe-table th {
            background: #2196F3;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .recipe-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ddd;
        }

        .recipe-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .recipe-form {
                grid-template-columns: 1fr;
            }
            
            .recipe-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="signature">Philip Riachy, PhD</div>
            <h1>Professional HLB Calculator</h1>
            <p class="subtitle">Hydrophilic-Lipophilic Balance Formulation Tool</p>
        </div>

        <div class="main-content">
            <!-- Oil Phase Section -->
            <div class="section">
                <h3>üõ¢Ô∏è Oil Phase</h3>
                
                <div class="form-group">
                    <label>Select Oil</label>
                    <select id="oil-select" class="form-control">
                        <option value="">Choose an oil...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Percentage (%)</label>
                    <input type="number" id="oil-percentage" class="form-control" step="0.1" min="0" max="100">
                </div>
                
                <div>
                    <button class="btn" onclick="addOilToFormulation()">Add Oil</button>
                    <button class="btn btn-danger" onclick="removeSelectedOil()">Remove</button>
                </div>

                <table class="data-table" id="oils-table">
                    <thead>
                        <tr>
                            <th>Oil</th>
                            <th>RHLB</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <button class="btn btn-success" onclick="calculateRequiredHLB()">Calculate Required HLB</button>
                <div id="rhlb-result" class="result-display"></div>
            </div>

            <!-- Surfactant Phase Section -->
            <div class="section">
                <h3>üß™ Surfactant System</h3>
                
                <div class="form-group">
                    <label>Surfactant System (% of Oil Phase)</label>
                    <input type="number" id="surfactant-total" class="form-control" step="0.1" min="0" value="25">
                </div>
                
                <div class="form-group">
                    <label>Primary Surfactant</label>
                    <select id="surfactant-1" class="form-control">
                        <option value="">Select surfactant...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Secondary Surfactant</label>
                    <select id="surfactant-2" class="form-control">
                        <option value="">Select surfactant...</option>
                    </select>
                </div>

                <button class="btn btn-success" onclick="calculateSurfactantRatios()">Calculate Ratios</button>
                <div id="surfactant-result" class="result-display"></div>
            </div>

            <!-- Other Ingredients Section -->
            <div class="section">
                <h3>üßÇ Other Ingredients</h3>
                
                <div class="form-group">
                    <label>Ingredient Name</label>
                    <input type="text" id="other-name" class="form-control" placeholder="e.g., Glycerin, Preservative">
                </div>
                
                <div class="form-group">
                    <label>Percentage (%)</label>
                    <input type="number" id="other-percentage" class="form-control" step="0.1" min="0" max="100">
                </div>
                
                <div>
                    <button class="btn" onclick="addOtherIngredient()">Add Ingredient</button>
                    <button class="btn btn-danger" onclick="removeSelectedOther()">Remove</button>
                </div>

                <table class="data-table" id="others-table">
                    <thead>
                        <tr>
                            <th>Ingredient</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <button class="btn btn-success" onclick="calculateWaterPercentage()">Calculate Water %</button>
                <div id="water-result" class="result-display"></div>
            </div>
        </div>

        <!-- Recipe Generation Section -->
        <div class="recipe-section">
            <h3>üìã Formula Generator</h3>
            
            <div class="recipe-form">
                <div>
                    <div class="form-group">
                        <label>Formula Name</label>
                        <input type="text" id="formula-name" class="form-control" placeholder="My Amazing Formula">
                    </div>
                    <div class="form-group">
                        <label>Batch Size (g)</label>
                        <input type="number" id="batch-size" class="form-control" value="100" min="1">
                    </div>
                </div>
                
                <div>
                    <div class="form-group">
                        <label>Formula ID</label>
                        <input type="text" id="formula-id" class="form-control" placeholder="F001">
                    </div>
                    <div class="form-group">
                        <label>Version</label>
                        <input type="text" id="formula-version" class="form-control" placeholder="v1.0">
                    </div>
                </div>
                
                <div>
                    <div class="form-group">
                        <label>Notes & Instructions</label>
                        <textarea id="formula-notes" class="form-control" rows="4" placeholder="Processing instructions, observations, stability notes..."></textarea>
                    </div>
                </div>
            </div>

            <div class="recipe-buttons">
                <button class="btn btn-success" onclick="generateCompleteRecipe()">Generate Recipe</button>
                <button class="btn" onclick="exportToPDF()">Export PDF</button>
                <button class="btn" onclick="saveFormulation()">Save JSON</button>
                <button class="btn" onclick="loadFormulation()">Load JSON</button>
                <button class="btn btn-danger" onclick="clearAllData()">New Formula</button>
            </div>

            <div id="recipe-display"></div>
        </div>
    </div>

    <script>
        // Professional Database - Industry Standard Values
        const OILS_DATABASE = {
            "Olive Oil": 7.00, "Coconut Oil": 8.00, "Jojoba Oil": 6.00, "Sweet Almond Oil": 7.00,
            "Avocado Oil": 7.00, "Sunflower Oil": 7.00, "Argan Oil": 11.00, "Castor Oil": 14.00,
            "Sesame Oil": 7.00, "Rice Bran Oil": 7.00, "Grapeseed Oil": 7.00, "Safflower Oil": 8.00,
            "Andiroba Oil": 16.70, "Apricot Kernel Oil": 7.00, "Astaxanthin Oleoresin": 10.81,
            "Babassu Oil": 8.00, "Black Cumin Seed Oil": 16.00, "Borage Seed Oil": 7.00,
            "Brazil Nut Oil": 8.00, "Camelina Oil": 7.00, "Canola Oil": 6.00,
            "Cardamom Seed Oil": 11.00, "Carrot Oil": 6.00, "Chia Seed Oil": 12.90,
            "Evening Primrose Oil": 7.00, "Hazelnut Oil": 11.70, "Hemp Seed Oil": 7.00,
            "Karanja Seed Oil": 8.00, "Kukui Nut Oil": 7.00, "Macadamia Oil": 7.00,
            "Mango Seed Oil": 7.00, "Meadowfoam Seed Oil": 6.00, "Neem Oil": 9.00,
            "Palm Oil": 10.00, "Peanut Oil": 6.00, "Pistachio Seed Oil": 7.00,
            "Red Raspberry Seed Oil": 7.00, "Rose Hip Oil": 7.00, "Sacha Inchi Oil": 8.50,
            "Soybean Oil": 6.00, "Tamanu Oil": 8.00, "Wheat Germ Oil": 7.00,
            "Shea Butter": 8.00, "Cocoa Butter": 6.00, "Mango Butter": 8.00,
            "Kokum Butter": 8.00, "Beeswax": 12.00, "Candelilla Wax": 14.50,
            "Carnauba Wax": 15.00, "Ceresin Wax": 8.00, "Paraffin Wax": 10.00,
            "Caprylic/Capric Triglyceride": 5.00, "C12-15 Alkyl Benzoate": 13.00,
            "Ethylhexyl Palmitate": 8.00, "Isopropyl Myristate": 11.50,
            "Isopropyl Palmitate": 11.50, "Cetyl Ethylhexanoate": 1.00,
            "Butyl Stearate": 11.00, "Cetyl Palmitate": 10.00,
            "Cetyl Alcohol": 15.50, "Stearyl Alcohol": 15.50, "Cetearyl Alcohol": 15.50,
            "Behenyl Alcohol": 16.00, "Oleyl Alcohol": 13.50,
            "Dimethicone": 5.00, "Cyclomethicone": 7.50, "Cyclopentasiloxane": 7.50,
            "Lavender Oil": 12.00, "Lemon Peel Oil": 12.00, "Peppermint Oil": 12.30,
            "Rosemary Oil": 15.00, "Thyme Oil": 9.30, "Eucalyptus Oil": 9.80,
            "Geranium Oil": 12.00, "Citronella Oil": 12.60,
            "Squalane": 7.00, "Tocopherol (Vitamin E)": 6.00, "Retinyl Palmitate": 6.00,
            "Mineral Oil": 10.00, "Petrolatum": 7.50, "Lanolin": 10.00
        };

        const SURFACTANTS_DATABASE = {
            "Polysorbate 20 (Tween 20)": 16.67, "Polysorbate 22": 15.00, "Polysorbate 23": 16.00,
            "Polysorbate 24": 17.00, "Polysorbate 60 (Tween 60)": 14.90,
            "Polysorbate 80 (Tween 80)": 15.00, "Polysorbate 85 (Tween 85)": 11.00,
            "Sorbitan Monolaurate (Span 20)": 9.00, "Sorbitan Palmitate (Span 40)": 6.70,
            "Sorbitan Monostearate (Span 60)": 5.00, "Sorbitan Monooleate (Span 80)": 4.00,
            "Sorbitan Trioleate (Span 85)": 2.00, "Sorbitan Tristearate (Span 65)": 2.00,
            "Sorbitan Oleate": 4.30, "Sorbitan Isostearate": 4.70, "Sorbitan Olivate": 4.50,
            "Ceteareth-6": 10.50, "Ceteareth-12": 13.50, "Ceteareth-15": 14.50,
            "Ceteareth-20": 15.20, "Ceteareth-25": 16.50, "Ceteareth-30": 16.50,
            "Ceteareth-100": 18.50, "Laureth-1": 3.50, "Laureth-2": 6.00, "Laureth-3": 8.00,
            "Laureth-4": 9.70, "Laureth-5": 10.50, "Laureth-7": 12.00, "Laureth-9": 13.00,
            "Laureth-23": 16.90, "Steareth-2": 6.00, "Steareth-20": 15.30, "Steareth-21": 16.00,
            "Steareth-100": 18.80, "Oleth-2": 4.90, "Oleth-5": 9.50, "Oleth-10": 12.40,
            "Oleth-20": 15.30, "Oleth-30": 16.80, "Ceteth-2": 5.30, "Ceteth-10": 12.90,
            "Ceteth-20": 15.70, "Beheneth-5": 7.00, "Beheneth-10": 10.00, "Beheneth-20": 16.50,
            "Beheneth-25": 15.50, "Beheneth-30": 18.00, "Glyceryl Stearate": 3.80,
            "Glyceryl Oleate": 3.50, "Glyceryl Laurate": 5.40, "Glyceryl Stearate SE": 6.00,
            "Glyceryl Caprylate": 6.00, "Glyceryl Stearate + PEG-100 Stearate": 11.50,
            "PEG-7 Glyceryl Cocoate": 10.00, "PEG-8 Oleate": 11.60, "PEG-8 Laurate": 13.00,
            "PEG-20 Glyceryl Stearate": 15.00, "PEG-40 Hydrogenated Castor Oil": 15.00,
            "PEG-100 Stearate": 18.80, "Polyglyceryl-3 Oleate": 5.50, "Polyglyceryl-4 Oleate": 4.00,
            "Polyglyceryl-10 Oleate": 9.00, "Polyglyceryl-10 Laurate": 12.00, "Coco Glucoside": 13.00,
            "Decyl Glucoside": 13.50, "Lauryl Glucoside": 11.50, "Cetearyl Glucoside": 11.00,
            "Lecithin": 4.00, "Lysolecithin": 11.50, "Sodium Stearoyl Lactylate": 8.30,
            "Calcium Stearoyl Lactylate": 5.10, "Sucrose Stearate": 13.00, "Cetrimonium Chloride": 15.00,
            "Emulsifying Wax NF": 14.90, "Olivem 1000": 9.00, "Olivem 300": 11.00,
            "PEG-9 Dimethicone": 10.00, "PEG-12 Dimethicone": 12.00, "Polyoxyl Castor Oil": 13.00,
            "Octoxynol-40": 19.00
        };

        // Application State
        let currentFormulation = {
            oils: [],
            others: [],
            requiredHLB: null,
            surfactantSystem: null
        };

        // Initialize Application
        function initializeApp() {
            console.log('Initializing HLB Calculator...');
            
            populateDropdowns();
            setupEventListeners();
            
            console.log('HLB Calculator ready!');
        }

        function populateDropdowns() {
            const oilSelect = document.getElementById('oil-select');
            const surf1Select = document.getElementById('surfactant-1');
            const surf2Select = document.getElementById('surfactant-2');

            // Populate oil dropdown
            Object.keys(OILS_DATABASE).sort().forEach(oil => {
                const option = document.createElement('option');
                option.value = oil;
                option.textContent = oil;
                oilSelect.appendChild(option);
            });

            // Populate surfactant dropdowns
            Object.keys(SURFACTANTS_DATABASE).sort().forEach(surfactant => {
                const option1 = document.createElement('option');
                option1.value = surfactant;
                option1.textContent = surfactant;
                surf1Select.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = surfactant;
                option2.textContent = surfactant;
                surf2Select.appendChild(option2);
            });
        }

        function setupEventListeners() {
            // Add Enter key support for inputs
            document.getElementById('oil-percentage').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addOilToFormulation();
            });

            document.getElementById('other-percentage').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addOtherIngredient();
            });
        }

        // Oil Phase Functions
        function addOilToFormulation() {
            const oilSelect = document.getElementById('oil-select');
            const percentageInput = document.getElementById('oil-percentage');

            const oilName = oilSelect.value;
            const percentage = parseFloat(percentageInput.value);

            if (!oilName) {
                alert('Please select an oil');
                return;
            }

            if (!percentage || percentage <= 0) {
                alert('Please enter a valid percentage');
                percentageInput.focus();
                return;
            }

            const oil = {
                name: oilName,
                rhlb: OILS_DATABASE[oilName],
                percentage: percentage
            };

            currentFormulation.oils.push(oil);
            updateOilsTable();
            
            // Clear inputs
            oilSelect.value = '';
            percentageInput.value = '';
            oilSelect.focus();
        }

        function updateOilsTable() {
            const tbody = document.querySelector('#oils-table tbody');
            tbody.innerHTML = '';

            currentFormulation.oils.forEach((oil, index) => {
                const row = document.createElement('tr');
                row.onclick = () => selectTableRow(row, 'oil', index);
                row.innerHTML = `
                    <td>${oil.name}</td>
                    <td>${oil.rhlb.toFixed(1)}</td>
                    <td>${oil.percentage.toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        function removeSelectedOil() {
            const selectedRow = document.querySelector('#oils-table tr.selected');
            if (!selectedRow) {
                alert('Please select an oil to remove');
                return;
            }

            const index = parseInt(selectedRow.dataset.index);
            currentFormulation.oils.splice(index, 1);
            updateOilsTable();
            
            // Clear HLB calculation
            currentFormulation.requiredHLB = null;
            document.getElementById('rhlb-result').style.display = 'none';
        }

        function calculateRequiredHLB() {
            if (currentFormulation.oils.length === 0) {
                alert('Please add oils to your formulation first');
                return;
            }

            const totalPercentage = currentFormulation.oils.reduce((sum, oil) => sum + oil.percentage, 0);
            const weightedRHLB = currentFormulation.oils.reduce((sum, oil) => 
                sum + (oil.rhlb * oil.percentage / totalPercentage), 0);

            currentFormulation.requiredHLB = weightedRHLB;

            const resultDiv = document.getElementById('rhlb-result');
            resultDiv.innerHTML = `Required HLB: ${weightedRHLB.toFixed(2)}`;
            resultDiv.className = 'result-display';
            resultDiv.style.display = 'block';
        }

        // Surfactant Functions
        function calculateSurfactantRatios() {
            if (!currentFormulation.requiredHLB) {
                alert('Please calculate the Required HLB first');
                return;
            }

            const surf1Name = document.getElementById('surfactant-1').value;
            const surf2Name = document.getElementById('surfactant-2').value;

            if (!surf1Name || !surf2Name) {
                alert('Please select two surfactants');
                return;
            }

            if (surf1Name === surf2Name) {
                alert('Please select two different surfactants');
                return;
            }

            const surf1HLB = SURFACTANTS_DATABASE[surf1Name];
            const surf2HLB = SURFACTANTS_DATABASE[surf2Name];
            const targetHLB = currentFormulation.requiredHLB;

            if (surf1HLB === surf2HLB) {
                alert('Selected surfactants have the same HLB value. Please choose different ones.');
                return;
            }

            const ratio1 = (targetHLB - surf2HLB) / (surf1HLB - surf2HLB);
            const ratio2 = 1 - ratio1;

            if (ratio1 < 0 || ratio1 > 1) {
                const resultDiv = document.getElementById('surfactant-result');
                resultDiv.innerHTML = 'Cannot achieve target HLB with these surfactants';
                resultDiv.className = 'result-display error';
                resultDiv.style.display = 'block';
                return;
            }

            currentFormulation.surfactantSystem = {
                surfactant1: { name: surf1Name, hlb: surf1HLB, ratio: ratio1 },
                surfactant2: { name: surf2Name, hlb: surf2HLB, ratio: ratio2 }
            };

            const resultDiv = document.getElementById('surfactant-result');
            resultDiv.innerHTML = `
                <strong>Surfactant Ratios:</strong><br>
                ${surf1Name}: ${(ratio1 * 100).toFixed(1)}%<br>
                ${surf2Name}: ${(ratio2 * 100).toFixed(1)}%
            `;
            resultDiv.className = 'result-display';
            resultDiv.style.display = 'block';
        }

        // Other Ingredients Functions
        function addOtherIngredient() {
            const nameInput = document.getElementById('other-name');
            const percentageInput = document.getElementById('other-percentage');

            const name = nameInput.value.trim();
            const percentage = parseFloat(percentageInput.value);

            if (!name) {
                alert('Please enter an ingredient name');
                nameInput.focus();
                return;
            }

            if (!percentage || percentage <= 0) {
                alert('Please enter a valid percentage');
                percentageInput.focus();
                return;
            }

            const ingredient = {
                name: name,
                percentage: percentage
            };

            currentFormulation.others.push(ingredient);
            updateOthersTable();
            
            // Clear inputs
            nameInput.value = '';
            percentageInput.value = '';
            nameInput.focus();
        }

        function updateOthersTable() {
            const tbody = document.querySelector('#others-table tbody');
            tbody.innerHTML = '';

            currentFormulation.others.forEach((ingredient, index) => {
                const row = document.createElement('tr');
                row.onclick = () => selectTableRow(row, 'other', index);
                row.innerHTML = `
                    <td>${ingredient.name}</td>
                    <td>${ingredient.percentage.toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        function removeSelectedOther() {
            const selectedRow = document.querySelector('#others-table tr.selected');
            if (!selectedRow) {
                alert('Please select an ingredient to remove');
                return;
            }

            const index = parseInt(selectedRow.dataset.index);
            currentFormulation.others.splice(index, 1);
            updateOthersTable();
        }

        function calculateWaterPercentage() {
            const oilTotal = currentFormulation.oils.reduce((sum, oil) => sum + oil.percentage, 0);
            const surfactantRatio = parseFloat(document.getElementById('surfactant-total').value) || 0;
            const surfactantTotal = oilTotal * (surfactantRatio / 100); // Calculate actual surfactant % from oil phase
            const otherTotal = currentFormulation.others.reduce((sum, ingredient) => sum + ingredient.percentage, 0);
            
            const waterPercentage = 100 - oilTotal - surfactantTotal - otherTotal;

            const resultDiv = document.getElementById('water-result');
            
            if (waterPercentage < 0) {
                resultDiv.innerHTML = `Total exceeds 100% (${(100 - waterPercentage).toFixed(1)}%)`;
                resultDiv.className = 'result-display error';
            } else {
                resultDiv.innerHTML = `
                    <strong>Breakdown:</strong><br>
                    Surfactants: ${surfactantTotal.toFixed(1)}% (${surfactantRatio}% of oils)<br>
                    Water: ${waterPercentage.toFixed(1)}%
                `;
                resultDiv.className = 'result-display';
            }
            
            resultDiv.style.display = 'block';
        }

        // Recipe Generation
        function generateCompleteRecipe() {
            if (!validateFormulation()) return;

            const formulaName = document.getElementById('formula-name').value || 'Untitled Formula';
            const batchSize = parseFloat(document.getElementById('batch-size').value) || 100;
            const notes = document.getElementById('formula-notes').value.trim();

            const oilTotal = currentFormulation.oils.reduce((sum, oil) => sum + oil.percentage, 0);
            const surfactantRatio = parseFloat(document.getElementById('surfactant-total').value) || 0;
            const surfactantTotal = oilTotal * (surfactantRatio / 100); // Calculate actual surfactant % from oil phase
            const otherTotal = currentFormulation.others.reduce((sum, ingredient) => sum + ingredient.percentage, 0);
            const waterPercentage = 100 - oilTotal - surfactantTotal - otherTotal;

            let recipeHTML = `
                <div class="recipe-output">
                    <h3>${formulaName}</h3>
                    <p><strong>Batch Size:</strong> ${batchSize}g | <strong>Required HLB:</strong> ${currentFormulation.requiredHLB.toFixed(2)} | <strong>Surfactant System:</strong> ${surfactantRatio}% of oils | <strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    
                    <table class="recipe-table">
                        <thead>
                            <tr>
                                <th>Phase</th>
                                <th>Ingredient</th>
                                <th>Percentage</th>
                                <th>Weight (g)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Oil Phase
            currentFormulation.oils.forEach(oil => {
                const weight = (oil.percentage * batchSize / 100).toFixed(1);
                recipeHTML += `
                    <tr>
                        <td>Oil</td>
                        <td>${oil.name}</td>
                        <td>${oil.percentage.toFixed(1)}%</td>
                        <td>${weight}g</td>
                    </tr>
                `;
            });

            // Surfactant Phase
            const surf1Percentage = surfactantTotal * currentFormulation.surfactantSystem.surfactant1.ratio;
            const surf2Percentage = surfactantTotal * currentFormulation.surfactantSystem.surfactant2.ratio;

            recipeHTML += `
                <tr>
                    <td>Surfactant</td>
                    <td>${currentFormulation.surfactantSystem.surfactant1.name}</td>
                    <td>${surf1Percentage.toFixed(1)}%</td>
                    <td>${(surf1Percentage * batchSize / 100).toFixed(1)}g</td>
                </tr>
                <tr>
                    <td>Surfactant</td>
                    <td>${currentFormulation.surfactantSystem.surfactant2.name}</td>
                    <td>${surf2Percentage.toFixed(1)}%</td>
                    <td>${(surf2Percentage * batchSize / 100).toFixed(1)}g</td>
                </tr>
            `;

            // Other Ingredients
            currentFormulation.others.forEach(ingredient => {
                const weight = (ingredient.percentage * batchSize / 100).toFixed(1);
                recipeHTML += `
                    <tr>
                        <td>Water</td>
                        <td>${ingredient.name}</td>
                        <td>${ingredient.percentage.toFixed(1)}%</td>
                        <td>${weight}g</td>
                    </tr>
                `;
            });

            // Water
            if (waterPercentage > 0) {
                const waterWeight = (waterPercentage * batchSize / 100).toFixed(1);
                recipeHTML += `
                    <tr>
                        <td>Water</td>
                        <td>Distilled Water</td>
                        <td>${waterPercentage.toFixed(1)}%</td>
                        <td>${waterWeight}g</td>
                    </tr>
                `;
            }

            recipeHTML += `
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px;">
                        <strong>Formula Summary:</strong><br>
                        Oil Phase: ${oilTotal.toFixed(1)}% | Surfactant Phase: ${surfactantTotal.toFixed(1)}% (${surfactantRatio}% of oils) | Water Phase: ${(waterPercentage + otherTotal).toFixed(1)}%
                    </div>
            `;

            if (notes) {
                recipeHTML += `
                    <h4 style="color: #2196F3; margin-top: 20px;">Notes:</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${notes}</div>
                `;
            }

            recipeHTML += '</div>';

            document.getElementById('recipe-display').innerHTML = recipeHTML;
        }

        function exportToPDF() {
            if (!validateFormulation()) return;

            if (!window.jspdf) {
                alert('PDF library not loaded. Please refresh the page and try again.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            const formulaName = document.getElementById('formula-name').value || 'Untitled Formula';
            const batchSize = parseFloat(document.getElementById('batch-size').value) || 100;
            const notes = document.getElementById('formula-notes').value.trim();

            let yPosition = 20;

            // Header
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text(formulaName, 20, yPosition);
            yPosition += 15;

            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.text('HLB Calculator - Philip Riachy, PhD', 150, 15);
            pdf.text(`Date: ${new Date().toLocaleDateString()}`, 20, yPosition);
            pdf.text(`Batch Size: ${batchSize}g`, 20, yPosition + 5);
            pdf.text(`Required HLB: ${currentFormulation.requiredHLB.toFixed(2)}`, 20, yPosition + 10);
            yPosition += 25;

            // Oil Phase
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            const oilTotal = currentFormulation.oils.reduce((sum, oil) => sum + oil.percentage, 0);
            pdf.text(`Oil Phase (${oilTotal.toFixed(1)}%)`, 20, yPosition);
            yPosition += 10;

            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            currentFormulation.oils.forEach(oil => {
                const weight = (oil.percentage * batchSize / 100).toFixed(1);
                pdf.text(`${oil.name}`, 20, yPosition);
                pdf.text(`${oil.percentage.toFixed(1)}%`, 100, yPosition);
                pdf.text(`${weight}g`, 130, yPosition);
                yPosition += 5;
            });
            yPosition += 5;

            // Surfactant Phase
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            const surfactantRatio = parseFloat(document.getElementById('surfactant-total').value) || 0;
            const surfactantTotal = oilTotal * (surfactantRatio / 100); // Calculate actual surfactant % from oil phase
            pdf.text(`Surfactant Phase (${surfactantTotal.toFixed(1)}% - ${surfactantRatio}% of oils)`, 20, yPosition);
            yPosition += 10;

            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            const surf1Percentage = surfactantTotal * currentFormulation.surfactantSystem.surfactant1.ratio;
            const surf2Percentage = surfactantTotal * currentFormulation.surfactantSystem.surfactant2.ratio;

            pdf.text(currentFormulation.surfactantSystem.surfactant1.name, 20, yPosition);
            pdf.text(`${surf1Percentage.toFixed(1)}%`, 100, yPosition);
            pdf.text(`${(surf1Percentage * batchSize / 100).toFixed(1)}g`, 130, yPosition);
            yPosition += 5;

            pdf.text(currentFormulation.surfactantSystem.surfactant2.name, 20, yPosition);
            pdf.text(`${surf2Percentage.toFixed(1)}%`, 100, yPosition);
            pdf.text(`${(surf2Percentage * batchSize / 100).toFixed(1)}g`, 130, yPosition);
            yPosition += 10;

            // Water Phase
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            const otherTotal = currentFormulation.others.reduce((sum, ingredient) => sum + ingredient.percentage, 0);
            const waterPercentage = 100 - oilTotal - surfactantTotal - otherTotal;
            pdf.text(`Water Phase (${(waterPercentage + otherTotal).toFixed(1)}%)`, 20, yPosition);
            yPosition += 10;

            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            currentFormulation.others.forEach(ingredient => {
                const weight = (ingredient.percentage * batchSize / 100).toFixed(1);
                pdf.text(ingredient.name, 20, yPosition);
                pdf.text(`${ingredient.percentage.toFixed(1)}%`, 100, yPosition);
                pdf.text(`${weight}g`, 130, yPosition);
                yPosition += 5;
            });

            if (waterPercentage > 0) {
                const waterWeight = (waterPercentage * batchSize / 100).toFixed(1);
                pdf.text('Distilled Water', 20, yPosition);
                pdf.text(`${waterPercentage.toFixed(1)}%`, 100, yPosition);
                pdf.text(`${waterWeight}g`, 130, yPosition);
                yPosition += 10;
            }

            // Notes
            if (notes) {
                yPosition += 5;
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('Notes:', 20, yPosition);
                yPosition += 8;

                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                const lines = pdf.splitTextToSize(notes, 170);
                lines.forEach(line => {
                    pdf.text(line, 20, yPosition);
                    yPosition += 5;
                });
            }

            const fileName = `${formulaName.replace(/[^a-z0-9]/gi, '_')}_HLB_Formula.pdf`;
            pdf.save(fileName);
        }

        // Data Management
        function saveFormulation() {
            const formulaName = document.getElementById('formula-name').value || 'untitled_formula';
            
            const data = {
                formulation: currentFormulation,
                formulaDetails: {
                    name: document.getElementById('formula-name').value,
                    id: document.getElementById('formula-id').value,
                    version: document.getElementById('formula-version').value,
                    batchSize: document.getElementById('batch-size').value,
                    surfactantRatio: document.getElementById('surfactant-total').value, // % of oil phase
                    notes: document.getElementById('formula-notes').value
                },
                timestamp: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${formulaName.replace(/[^a-z0-9]/gi, '_')}_formulation.json`;
            link.click();
            
            URL.revokeObjectURL(link.href);
        }

        function loadFormulation() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Restore formulation data
                        currentFormulation = data.formulation || {
                            oils: [],
                            others: [],
                            requiredHLB: null,
                            surfactantSystem: null
                        };
                        
                        // Restore form fields
                        if (data.formulaDetails) {
                            document.getElementById('formula-name').value = data.formulaDetails.name || '';
                            document.getElementById('formula-id').value = data.formulaDetails.id || '';
                            document.getElementById('formula-version').value = data.formulaDetails.version || '';
                            document.getElementById('batch-size').value = data.formulaDetails.batchSize || '100';
                            document.getElementById('surfactant-total').value = data.formulaDetails.surfactantRatio || data.formulaDetails.surfactantTotal || '25';
                            document.getElementById('formula-notes').value = data.formulaDetails.notes || '';
                        }
                        
                        // Update displays
                        updateOilsTable();
                        updateOthersTable();
                        
                        if (currentFormulation.requiredHLB) {
                            const rhlbDiv = document.getElementById('rhlb-result');
                            rhlbDiv.innerHTML = `Required HLB: ${currentFormulation.requiredHLB.toFixed(2)}`;
                            rhlbDiv.className = 'result-display';
                            rhlbDiv.style.display = 'block';
                        }
                        
                        if (currentFormulation.surfactantSystem) {
                            const surfDiv = document.getElementById('surfactant-result');
                            const system = currentFormulation.surfactantSystem;
                            surfDiv.innerHTML = `
                                <strong>Surfactant Ratios:</strong><br>
                                ${system.surfactant1.name}: ${(system.surfactant1.ratio * 100).toFixed(1)}%<br>
                                ${system.surfactant2.name}: ${(system.surfactant2.ratio * 100).toFixed(1)}%
                            `;
                            surfDiv.className = 'result-display';
                            surfDiv.style.display = 'block';
                        }
                        
                        alert('Formulation loaded successfully!');
                        
                    } catch (error) {
                        console.error('Error loading formulation:', error);
                        alert('Error loading formulation file. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data and start a new formulation?')) {
                currentFormulation = {
                    oils: [],
                    others: [],
                    requiredHLB: null,
                    surfactantSystem: null
                };
                
                // Clear all form fields
                document.getElementById('formula-name').value = '';
                document.getElementById('formula-id').value = '';
                document.getElementById('formula-version').value = '';
                document.getElementById('batch-size').value = '100';
                document.getElementById('surfactant-total').value = '25';
                document.getElementById('formula-notes').value = '';
                
                // Clear dropdowns
                document.getElementById('oil-select').value = '';
                document.getElementById('oil-percentage').value = '';
                document.getElementById('surfactant-1').value = '';
                document.getElementById('surfactant-2').value = '';
                document.getElementById('other-name').value = '';
                document.getElementById('other-percentage').value = '';
                
                // Clear tables and results
                updateOilsTable();
                updateOthersTable();
                document.getElementById('rhlb-result').style.display = 'none';
                document.getElementById('surfactant-result').style.display = 'none';
                document.getElementById('water-result').style.display = 'none';
                document.getElementById('recipe-display').innerHTML = '';
                
                alert('Started new formulation!');
            }
        }

        // Utility Functions
        function selectTableRow(row, type, index) {
            // Clear previous selections
            const table = row.closest('table');
            table.querySelectorAll('tr').forEach(tr => tr.classList.remove('selected'));
            
            // Select clicked row
            row.classList.add('selected');
            row.dataset.index = index;
        }

        function validateFormulation() {
            if (currentFormulation.oils.length === 0) {
                alert('Please add oils to your formulation');
                return false;
            }
            
            if (!currentFormulation.requiredHLB) {
                alert('Please calculate the Required HLB');
                return false;
            }
            
            if (!currentFormulation.surfactantSystem) {
                alert('Please calculate surfactant ratios');
                return false;
            }
            
            const oilTotal = currentFormulation.oils.reduce((sum, oil) => sum + oil.percentage, 0);
            const surfactantRatio = parseFloat(document.getElementById('surfactant-total').value) || 0;
            const surfactantTotal = oilTotal * (surfactantRatio / 100); // Calculate actual surfactant % from oil phase
            const otherTotal = currentFormulation.others.reduce((sum, ingredient) => sum + ingredient.percentage, 0);
            
            if (oilTotal + surfactantTotal + otherTotal > 100) {
                alert('Total percentages exceed 100%. Please adjust your formulation.');
                return false;
            }
            
            return true;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
