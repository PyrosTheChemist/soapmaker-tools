<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional pH Calculator - Philip Riachy, PhD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .signature {
            position: absolute;
            top: 15px;
            right: 30px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h3 {
            color: #4ECDC4;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4ECDC4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin: 3px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #ff6b6b);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }

        .ph-scale {
            background: linear-gradient(to right, #ff0000, #ff8000, #ffff00, #80ff00, #00ff00, #00ff80, #00ffff, #0080ff, #0000ff, #8000ff, #ff00ff);
            height: 40px;
            border-radius: 20px;
            position: relative;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .ph-marker {
            position: absolute;
            top: -10px;
            width: 4px;
            height: 60px;
            background: #333;
            border-radius: 2px;
            transition: left 0.3s ease;
        }

        .ph-scale-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .result-display {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin: 15px 0;
            display: none;
            font-size: 0.9rem;
        }

        .result-display.error {
            background: linear-gradient(135deg, #f44336, #ff6b6b);
        }

        .result-display.warning {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
        }

        .ph-analysis {
            background: #e8f5f5;
            border: 2px solid #4ECDC4;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .ph-analysis h4 {
            color: #2c5282;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .adjustment-calculator {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .buffer-system {
            background: #f0f8ff;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #4ECDC4;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr.selected {
            background: #e8f5f5;
        }

        .ingredient-category {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .category-badge {
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .category-badge.acidic { background: #ffebee; color: #c62828; }
        .category-badge.basic { background: #e8f5e8; color: #2e7d32; }
        .category-badge.neutral { background: #f5f5f5; color: #424242; }
        .category-badge.buffer { background: #e3f2fd; color: #1565c0; }

        .category-badge.selected {
            border-color: #4ECDC4;
            transform: scale(1.05);
        }

        .recipe-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .recipe-form {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .recipe-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 800px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .recipe-form {
                grid-template-columns: 1fr;
            }
            
            .ingredient-category {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="signature">Philip Riachy, PhD</div>
            <h1>Professional pH Calculator</h1>
            <p class="subtitle">Scientific pH Analysis & Adjustment Tool for Cosmetic Formulation</p>
        </div>

        <div class="main-content">
            <!-- Current pH Analysis -->
            <div class="section">
                <h3>üî¨ Current pH Analysis</h3>
                
                <div class="form-group">
                    <label>Current pH Value</label>
                    <input type="number" id="current-ph" class="form-control" step="0.01" min="0" max="14" placeholder="e.g., 6.8">
                </div>
                
                <div class="form-group">
                    <label>Product Type</label>
                    <select id="product-type" class="form-control" onchange="updateOptimalRange()">
                        <option value="">Select product type...</option>
                        <option value="cleanser">Cleanser/Face Wash</option>
                        <option value="toner">Toner/Astringent</option>
                        <option value="serum">Serum/Treatment</option>
                        <option value="moisturizer">Moisturizer/Cream</option>
                        <option value="sunscreen">Sunscreen</option>
                        <option value="shampoo">Shampoo</option>
                        <option value="conditioner">Conditioner</option>
                        <option value="soap">Bar Soap</option>
                        <option value="deodorant">Deodorant</option>
                        <option value="lotion">Body Lotion</option>
                    </select>
                </div>

                <div class="ph-scale">
                    <div class="ph-marker" id="ph-marker"></div>
                </div>
                <div class="ph-scale-labels">
                    <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span><span>11</span><span>12</span><span>13</span><span>14</span>
                </div>

                <button class="btn btn-success" onclick="analyzePH()">Analyze pH</button>
                <div id="ph-analysis-result" class="result-display"></div>

                <div class="ph-analysis" id="ph-detailed-analysis" style="display: none;">
                    <h4>pH Analysis</h4>
                    <div id="ph-classification"></div>
                    <div id="skin-compatibility"></div>
                    <div id="stability-assessment"></div>
                    <div id="regulatory-compliance"></div>
                </div>
            </div>

            <!-- Target pH Settings -->
            <div class="section">
                <h3>üéØ Target pH Settings</h3>
                
                <div class="form-group">
                    <label>Target pH</label>
                    <input type="number" id="target-ph" class="form-control" step="0.01" min="0" max="14" placeholder="e.g., 5.5">
                </div>
                
                <div class="form-group">
                    <label>pH Tolerance (¬±)</label>
                    <select id="ph-tolerance" class="form-control">
                        <option value="0.1">¬±0.1 (Pharmaceutical)</option>
                        <option value="0.2" selected>¬±0.2 (Premium Cosmetic)</option>
                        <option value="0.3">¬±0.3 (Standard Cosmetic)</option>
                        <option value="0.5">¬±0.5 (Basic Formulation)</option>
                    </select>
                </div>

                <div class="ph-analysis" id="optimal-range-guide">
                    <h4>Optimal pH Ranges by Product Type</h4>
                    <div style="font-size: 0.8rem;">
                        <strong>Cleansers:</strong> 5.5-6.5 (gentle), 8.0-10.0 (deep clean)<br>
                        <strong>Toners:</strong> 3.5-5.5<br>
                        <strong>Serums:</strong> 3.0-6.0 (active-dependent)<br>
                        <strong>Moisturizers:</strong> 5.0-7.0<br>
                        <strong>Sunscreens:</strong> 6.0-8.0<br>
                        <strong>Hair Products:</strong> 4.5-6.5<br>
                        <strong>Soaps:</strong> 9.0-10.0
                    </div>
                </div>

                <div class="form-group">
                    <label>Batch Volume (L)</label>
                    <input type="number" id="batch-volume" class="form-control" step="0.1" min="0" value="1.0">
                </div>

                <button class="btn btn-success" onclick="calculateAdjustment()">Calculate pH Adjustment</button>
                <div id="adjustment-result" class="result-display"></div>
            </div>

            <!-- pH Adjusters Database -->
            <div class="section">
                <h3>‚öóÔ∏è pH Adjusters Database</h3>
                
                <div class="form-group">
                    <label>Adjuster Category</label>
                    <div class="ingredient-category">
                        <div class="category-badge acidic" onclick="selectAdjusterCategory('acidic')">Acidic</div>
                        <div class="category-badge basic" onclick="selectAdjusterCategory('basic')">Basic</div>
                        <div class="category-badge neutral" onclick="selectAdjusterCategory('neutral')">Neutral</div>
                        <div class="category-badge buffer" onclick="selectAdjusterCategory('buffer')">Buffer</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Select pH Adjuster</label>
                    <select id="adjuster-select" class="form-control" onchange="showAdjusterInfo()">
                        <option value="">Choose a pH adjuster...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Concentration (%)</label>
                    <input type="number" id="adjuster-concentration" class="form-control" step="0.01" min="0" placeholder="Solution concentration">
                </div>

                <div id="adjuster-info" class="ph-analysis" style="display: none;">
                    <h4 id="adjuster-name-display"></h4>
                    <div id="adjuster-details"></div>
                </div>

                <div>
                    <button class="btn" onclick="addAdjusterToFormula()">Add to Formula</button>
                    <button class="btn btn-danger" onclick="removeSelectedAdjuster()">Remove</button>
                </div>

                <table class="data-table" id="adjusters-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>pH Adjuster</th>
                            <th>Type</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Buffer Systems -->
            <div class="section">
                <h3>üõ°Ô∏è Buffer Systems</h3>
                
                <div class="buffer-system">
                    <h4>Common Buffer Systems</h4>
                    <div style="font-size: 0.85rem;">
                        <strong>Citric Acid/Sodium Citrate:</strong> pH 3.0-6.2<br>
                        <strong>Phosphate Buffer:</strong> pH 6.2-8.2<br>
                        <strong>Tris Buffer:</strong> pH 7.0-9.0<br>
                        <strong>Carbonate Buffer:</strong> pH 9.2-10.8<br>
                        <strong>Acetate Buffer:</strong> pH 3.6-5.6
                    </div>
                </div>

                <div class="form-group">
                    <label>Buffer System</label>
                    <select id="buffer-system" class="form-control" onchange="updateBufferInfo()">
                        <option value="">Select buffer system...</option>
                        <option value="citrate">Citric Acid/Sodium Citrate</option>
                        <option value="phosphate">Phosphate Buffer</option>
                        <option value="tris">Tris Buffer</option>
                        <option value="acetate">Acetate Buffer</option>
                        <option value="carbonate">Carbonate Buffer</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Buffer Concentration (mM)</label>
                    <input type="number" id="buffer-concentration" class="form-control" step="0.1" min="0" value="10">
                </div>

                <div id="buffer-info" class="ph-analysis" style="display: none;">
                    <h4>Buffer Calculation</h4>
                    <div id="buffer-details"></div>
                </div>

                <button class="btn btn-success" onclick="calculateBuffer()">Calculate Buffer</button>
                <div id="buffer-result" class="result-display"></div>

                <div class="ph-analysis">
                    <h4>üí° Buffer Benefits</h4>
                    <ul style="font-size: 0.8rem; margin: 8px 0; padding-left: 16px;">
                        <li>Maintains stable pH during storage</li>
                        <li>Resists pH changes from contamination</li>
                        <li>Improves product consistency</li>
                        <li>Enhances active ingredient stability</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Formula Generation -->
        <div class="recipe-section">
            <h3>üìã Complete pH Adjustment Formula</h3>
            
            <div class="recipe-form">
                <div>
                    <div class="form-group">
                        <label>Formula Name</label>
                        <input type="text" id="formula-name" class="form-control" placeholder="pH-Balanced Serum">
                    </div>
                    <div class="form-group">
                        <label>Current pH</label>
                        <input type="text" id="display-current-ph" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>Target pH</label>
                        <input type="text" id="display-target-ph" class="form-control" readonly>
                    </div>
                </div>
                
                <div>
                    <div class="form-group">
                        <label>Formula ID</label>
                        <input type="text" id="formula-id" class="form-control" placeholder="pH001">
                    </div>
                    <div class="form-group">
                        <label>Batch Size</label>
                        <input type="text" id="display-batch-size" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>Product Category</label>
                        <input type="text" id="display-product-type" class="form-control" readonly>
                    </div>
                </div>
                
                <div>
                    <div class="form-group">
                        <label>Adjustment Notes</label>
                        <textarea id="adjustment-notes" class="form-control" rows="4" placeholder="pH adjustment procedure, testing protocols, stability considerations..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Quality Control</label>
                        <textarea id="qc-notes" class="form-control" rows="2" placeholder="Testing frequency, acceptable ranges, corrective actions..."></textarea>
                    </div>
                </div>
            </div>

            <div class="recipe-buttons">
                <button class="btn btn-success" onclick="generatePHFormula()">Generate pH Formula</button>
                <button class="btn" onclick="exportPHPDF()">Export PDF</button>
                <button class="btn" onclick="savePHFormula()">Save JSON</button>
                <button class="btn" onclick="loadPHFormula()">Load JSON</button>
                <button class="btn btn-danger" onclick="clearAllPHData()">New Formula</button>
            </div>

            <div id="ph-formula-display"></div>
        </div>
    </div>

    <script>
        // Comprehensive pH Adjusters Database
        const PH_ADJUSTERS_DATABASE = {
            // Acidic Adjusters (Lower pH)
            "Citric Acid": {
                category: "acidic",
                pka: [3.13, 4.76, 6.40],
                molecular_weight: 192.12,
                max_usage: 2.0,
                solubility: "Very high (59.2g/100ml)",
                buffering_range: "3.0-6.2",
                advantages: ["Natural origin", "Multifunctional (chelating)", "GRAS status"],
                disadvantages: ["Can cause irritation at high concentrations"],
                typical_usage: "0.01-0.5%",
                mechanism: "Weak triprotic acid, provides gradual pH reduction with buffering capacity"
            },
            "Lactic Acid": {
                category: "acidic",
                pka: [3.86],
                molecular_weight: 90.08,
                max_usage: 10.0,
                solubility: "Very high (miscible)",
                buffering_range: "2.9-4.9",
                advantages: ["Natural moisturizing factor", "Gentle exfoliation", "Skin conditioning"],
                disadvantages: ["More expensive than mineral acids"],
                typical_usage: "0.1-2.0%",
                mechanism: "Alpha-hydroxy acid with mild buffering and humectant properties"
            },
            "Hydrochloric Acid": {
                category: "acidic",
                pka: [-6],
                molecular_weight: 36.46,
                max_usage: 1.0,
                solubility: "Complete",
                buffering_range: "None (strong acid)",
                advantages: ["Precise pH control", "No residual effects", "Inexpensive"],
                disadvantages: ["No buffering capacity", "Can cause sharp pH changes"],
                typical_usage: "0.001-0.1%",
                mechanism: "Strong acid providing immediate pH reduction without buffering"
            },
            "Phosphoric Acid": {
                category: "acidic",
                pka: [2.15, 7.20, 12.35],
                molecular_weight: 97.99,
                max_usage: 1.5,
                solubility: "Very high",
                buffering_range: "1.1-3.1, 6.2-8.2",
                advantages: ["Excellent buffering capacity", "Multi-functional"],
                disadvantages: ["Can interfere with some actives"],
                typical_usage: "0.01-0.5%",
                mechanism: "Triprotic acid with excellent buffering at physiological pH"
            },

            // Basic Adjusters (Raise pH)
            "Sodium Hydroxide": {
                category: "basic",
                pka: [15.7],
                molecular_weight: 39.997,
                max_usage: 1.0,
                solubility: "Very high (111g/100ml)",
                buffering_range: "None (strong base)",
                advantages: ["Precise pH control", "Highly effective", "Inexpensive"],
                disadvantages: ["No buffering capacity", "Caustic at high concentrations"],
                typical_usage: "0.001-0.2%",
                mechanism: "Strong base providing immediate pH increase without buffering"
            },
            "Triethanolamine (TEA)": {
                category: "basic",
                pka: [7.76],
                molecular_weight: 149.19,
                max_usage: 5.0,
                solubility: "Complete",
                buffering_range: "6.8-8.8",
                advantages: ["Emulsifying properties", "Buffering capacity", "Multifunctional"],
                disadvantages: ["Potential nitrosamine formation", "Can yellow over time"],
                typical_usage: "0.1-2.0%",
                mechanism: "Tertiary amine with emulsifying and pH buffering properties"
            },
            "Aminomethyl Propanol (AMP)": {
                category: "basic",
                pka: [9.69],
                molecular_weight: 89.14,
                max_usage: 2.0,
                solubility: "Complete",
                buffering_range: "8.7-10.7",
                advantages: ["Excellent solubilizer", "Low odor", "Thermal stability"],
                disadvantages: ["Higher cost than TEA"],
                typical_usage: "0.1-1.0%",
                mechanism: "Primary amine providing pH adjustment with good buffering capacity"
            },
            "Potassium Hydroxide": {
                category: "basic",
                pka: [15.7],
                molecular_weight: 56.11,
                max_usage: 1.0,
                solubility: "Very high (121g/100ml)",
                buffering_range: "None (strong base)",
                advantages: ["Fast pH adjustment", "No residual effects"],
                disadvantages: ["No buffering", "More expensive than NaOH"],
                typical_usage: "0.001-0.2%",
                mechanism: "Strong base for immediate pH increase, preferred for liquid soaps"
            },

            // Neutral/Buffer Systems
            "Sodium Citrate": {
                category: "buffer",
                pka: [3.13, 4.76, 6.40],
                molecular_weight: 294.10,
                max_usage: 3.0,
                solubility: "High (92.5g/100ml)",
                buffering_range: "3.0-6.2",
                advantages: ["Excellent buffering", "Chelating properties", "Natural origin"],
                disadvantages: ["Can affect product viscosity"],
                typical_usage: "0.1-1.0%",
                mechanism: "Conjugate base of citric acid, provides stable buffering system"
            },
            "Sodium Phosphate Dibasic": {
                category: "buffer",
                pka: [2.15, 7.20, 12.35],
                molecular_weight: 141.96,
                max_usage: 2.0,
                solubility: "High (11.8g/100ml)",
                buffering_range: "6.2-8.2",
                advantages: ["Excellent physiological buffering", "High buffer capacity"],
                disadvantages: ["Can precipitate with some minerals"],
                typical_usage: "0.05-0.5%",
                mechanism: "Phosphate buffer system ideal for physiological pH range"
            },
            "Tris (Hydroxymethyl) Aminomethane": {
                category: "buffer",
                pka: [8.06],
                molecular_weight: 121.14,
                max_usage: 1.0,
                solubility: "Very high (55g/100ml)",
                buffering_range: "7.0-9.0",
                advantages: ["Excellent buffering capacity", "Low interference with metals"],
                disadvantages: ["Temperature sensitive", "More expensive"],
                typical_usage: "0.1-0.5%",
                mechanism: "Biological buffer with excellent capacity in alkaline range"
            }
        };

        // Application State
        let currentPHFormula = {
            currentPH: null,
            targetPH: null,
            productType: null,
            adjusters: [],
            bufferSystem: null
        };

        // Initialize Application
        function initializePHApp() {
            console.log('Initializing Professional pH Calculator...');
            populateAdjusterDropdown();
            setupPHEventListeners();
            console.log('pH Calculator ready!');
        }

        function populateAdjusterDropdown() {
            const adjusterSelect = document.getElementById('adjuster-select');
            Object.keys(PH_ADJUSTERS_DATABASE).sort().forEach(adjuster => {
                const option = document.createElement('option');
                option.value = adjuster;
                option.textContent = adjuster;
                adjusterSelect.appendChild(option);
            });
        }

        function setupPHEventListeners() {
            document.getElementById('current-ph').addEventListener('input', updatePHMarker);
            document.getElementById('target-ph').addEventListener('input', function() {
                updateDisplayField('display-target-ph', this.value);
            });
            document.getElementById('batch-volume').addEventListener('input', function() {
                updateDisplayField('display-batch-size', this.value + 'L');
            });
        }

        function updatePHMarker() {
            const ph = parseFloat(document.getElementById('current-ph').value);
            const marker = document.getElementById('ph-marker');
            
            if (!isNaN(ph) && ph >= 0 && ph <= 14) {
                const position = (ph / 14) * 100;
                marker.style.left = `calc(${position}% - 2px)`;
                marker.style.display = 'block';
                updateDisplayField('display-current-ph', ph.toString());
            } else {
                marker.style.display = 'none';
            }
        }

        function updateDisplayField(fieldId, value) {
            document.getElementById(fieldId).value = value;
        }

        function updateOptimalRange() {
            const productType = document.getElementById('product-type').value;
            updateDisplayField('display-product-type', productType.charAt(0).toUpperCase() + productType.slice(1));
            
            const ranges = {
                cleanser: { min: 5.5, max: 6.5, optimal: 6.0 },
                toner: { min: 3.5, max: 5.5, optimal: 4.5 },
                serum: { min: 3.0, max: 6.0, optimal: 4.5 },
                moisturizer: { min: 5.0, max: 7.0, optimal: 6.0 },
                sunscreen: { min: 6.0, max: 8.0, optimal: 7.0 },
                shampoo: { min: 4.5, max: 6.5, optimal: 5.5 },
                conditioner: { min: 4.5, max: 6.0, optimal: 5.0 },
                soap: { min: 9.0, max: 10.0, optimal: 9.5 },
                deodorant: { min: 5.5, max: 7.5, optimal: 6.5 },
                lotion: { min: 5.0, max: 7.0, optimal: 6.0 }
            };
            
            if (ranges[productType]) {
                document.getElementById('target-ph').value = ranges[productType].optimal;
                updateDisplayField('display-target-ph', ranges[productType].optimal.toString());
            }
        }

        function selectAdjusterCategory(category) {
            document.querySelectorAll('.category-badge').forEach(badge => badge.classList.remove('selected'));
            document.querySelector(`.category-badge.${category}`).classList.add('selected');
            
            filterAdjustersByCategory(category);
        }

        function filterAdjustersByCategory(category) {
            const adjusterSelect = document.getElementById('adjuster-select');
            adjusterSelect.innerHTML = '<option value="">Choose a pH adjuster...</option>';
            
            Object.entries(PH_ADJUSTERS_DATABASE).forEach(([name, data]) => {
                if (data.category === category) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    adjusterSelect.appendChild(option);
                }
            });
        }

        function showAdjusterInfo() {
            const adjusterName = document.getElementById('adjuster-select').value;
            const infoDiv = document.getElementById('adjuster-info');
            const nameDisplay = document.getElementById('adjuster-name-display');
            const detailsDiv = document.getElementById('adjuster-details');

            if (!adjusterName) {
                infoDiv.style.display = 'none';
                return;
            }

            const data = PH_ADJUSTERS_DATABASE[adjusterName];
            nameDisplay.textContent = `${adjusterName} (${data.category.charAt(0).toUpperCase() + data.category.slice(1)})`;
            
            let detailsHTML = `
                <p><strong>pKa:</strong> ${Array.isArray(data.pka) ? data.pka.join(', ') : data.pka}</p>
                <p><strong>Molecular Weight:</strong> ${data.molecular_weight} g/mol</p>
                <p><strong>Buffering Range:</strong> ${data.buffering_range}</p>
                <p><strong>Typical Usage:</strong> ${data.typical_usage}</p>
                <p><strong>Mechanism:</strong> ${data.mechanism}</p>
                <p><strong>Advantages:</strong> ${data.advantages.join(', ')}</p>
                <p><strong>Considerations:</strong> ${data.disadvantages.join(', ')}</p>
            `;
            
            detailsDiv.innerHTML = detailsHTML;
            infoDiv.style.display = 'block';
        }

        function analyzePH() {
            const currentPH = parseFloat(document.getElementById('current-ph').value);
            const productType = document.getElementById('product-type').value;
            
            if (isNaN(currentPH) || !productType) {
                alert('Please enter current pH and select product type');
                return;
            }

            currentPHFormula.currentPH = currentPH;
            currentPHFormula.productType = productType;

            // Classify pH
            let classification = '';
            let skinCompatibility = '';
            let stabilityAssessment = '';
            let regulatoryCompliance = '';
            let resultClass = '';

            if (currentPH < 3.0) {
                classification = 'Strongly Acidic - Risk of chemical burns and material degradation';
                skinCompatibility = 'Unsafe for skin contact - Immediate tissue damage likely';
                resultClass = 'error';
            } else if (currentPH < 4.0) {
                classification = 'Very Acidic - Suitable for chemical peels and preservative systems';
                skinCompatibility = 'Irritating to sensitive skin - Professional use only';
                resultClass = 'warning';
            } else if (currentPH < 5.5) {
                classification = 'Mildly Acidic - Good for antimicrobial activity and active stability';
                skinCompatibility = 'Compatible with skin acid mantle - Suitable for most users';
                resultClass = '';
            } else if (currentPH < 7.0) {
                classification = 'Slightly Acidic - Physiologically compatible range';
                skinCompatibility = 'Excellent skin compatibility - Ideal for daily use products';
                resultClass = '';
            } else if (currentPH < 8.0) {
                classification = 'Neutral to Slightly Basic - Good for sensitive formulations';
                skinCompatibility = 'Generally well tolerated - May reduce preservative efficacy';
                resultClass = '';
            } else if (currentPH < 10.0) {
                classification = 'Basic - Effective for cleansing and saponification';
                skinCompatibility = 'May cause dryness - Suitable for rinse-off products';
                resultClass = 'warning';
            } else {
                classification = 'Strongly Basic - High cleaning power but harsh on skin';
                skinCompatibility = 'Harsh on skin barrier - Industrial/household cleaning only';
                resultClass = 'error';
            }

            // Stability assessment
            if (productType === 'serum' && (currentPH < 3.0 || currentPH > 7.0)) {
                stabilityAssessment = 'pH may affect active ingredient stability - Monitor during storage';
            } else if (productType === 'sunscreen' && (currentPH < 6.0 || currentPH > 8.0)) {
                stabilityAssessment = 'UV filters may degrade outside optimal pH range (6.0-8.0)';
            } else {
                stabilityAssessment = 'pH within acceptable range for product stability';
            }

            // Regulatory compliance
            if (productType === 'cleanser' && currentPH > 10.5) {
                regulatoryCompliance = 'May require safety substantiation for pH >10.5 in leave-on products';
            } else {
                regulatoryCompliance = 'Within typical regulatory guidelines for cosmetic products';
            }

            // Display results
            const resultDiv = document.getElementById('ph-analysis-result');
            resultDiv.innerHTML = `
                <strong>pH Analysis Complete!</strong><br>
                Classification: ${classification.split(' - ')[0]}<br>
                Current pH: ${currentPH.toFixed(2)}
            `;
            resultDiv.className = `result-display ${resultClass}`;
            resultDiv.style.display = 'block';

            document.getElementById('ph-classification').innerHTML = `<strong>Classification:</strong> ${classification}`;
            document.getElementById('skin-compatibility').innerHTML = `<strong>Skin Compatibility:</strong> ${skinCompatibility}`;
            document.getElementById('stability-assessment').innerHTML = `<strong>Stability:</strong> ${stabilityAssessment}`;
            document.getElementById('regulatory-compliance').innerHTML = `<strong>Regulatory:</strong> ${regulatoryCompliance}`;
            
            document.getElementById('ph-detailed-analysis').style.display = 'block';
        }

        function calculateAdjustment() {
            const currentPH = parseFloat(document.getElementById('current-ph').value);
            const targetPH = parseFloat(document.getElementById('target-ph').value);
            const batchVolume = parseFloat(document.getElementById('batch-volume').value);
            
            if (isNaN(currentPH) || isNaN(targetPH) || isNaN(batchVolume)) {
                alert('Please enter current pH, target pH, and batch volume');
                return;
            }

            currentPHFormula.targetPH = targetPH;
            const pHDifference = targetPH - currentPH;

            let adjustmentDirection = '';
            let recommendedAdjusters = [];
            let estimatedAmount = 0;

            if (Math.abs(pHDifference) < 0.05) {
                adjustmentDirection = 'No adjustment needed - within tolerance';
            } else if (pHDifference > 0) {
                adjustmentDirection = 'pH needs to be increased (more basic)';
                recommendedAdjusters = ['Sodium Hydroxide', 'Triethanolamine (TEA)', 'Aminomethyl Propanol (AMP)'];
                estimatedAmount = Math.abs(pHDifference) * batchVolume * 0.1; // Rough estimation
            } else {
                adjustmentDirection = 'pH needs to be decreased (more acidic)';
                recommendedAdjusters = ['Citric Acid', 'Lactic Acid', 'Hydrochloric Acid'];
                estimatedAmount = Math.abs(pHDifference) * batchVolume * 0.05; // Rough estimation
            }

            const resultDiv = document.getElementById('adjustment-result');
            if (Math.abs(pHDifference) < 0.05) {
                resultDiv.innerHTML = `<strong>No Adjustment Required!</strong><br>Current pH is within target range.`;
                resultDiv.className = 'result-display';
            } else {
                resultDiv.innerHTML = `
                    <strong>pH Adjustment Required!</strong><br>
                    ${adjustmentDirection}<br>
                    ŒîpH: ${pHDifference.toFixed(2)} units<br>
                    Estimated amount: ${estimatedAmount.toFixed(3)}g
                `;
                resultDiv.className = 'result-display warning';
            }
            resultDiv.style.display = 'block';

            updateDisplayField('display-batch-size', batchVolume + 'L');
        }

        function addAdjusterToFormula() {
            const adjusterName = document.getElementById('adjuster-select').value;
            const concentration = parseFloat(document.getElementById('adjuster-concentration').value);

            if (!adjusterName) {
                alert('Please select a pH adjuster');
                return;
            }

            if (!concentration || concentration <= 0) {
                alert('Please enter a valid concentration');
                return;
            }

            const adjusterData = PH_ADJUSTERS_DATABASE[adjusterName];
            const adjuster = {
                name: adjusterName,
                category: adjusterData.category,
                concentration: concentration,
                data: adjusterData
            };

            currentPHFormula.adjusters.push(adjuster);
            updateAdjustersTable();
            
            // Clear inputs
            document.getElementById('adjuster-select').value = '';
            document.getElementById('adjuster-concentration').value = '';
            document.getElementById('adjuster-info').style.display = 'none';
        }

        function updateAdjustersTable() {
            const table = document.getElementById('adjusters-table');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            if (currentPHFormula.adjusters.length === 0) {
                table.style.display = 'none';
                return;
            }

            currentPHFormula.adjusters.forEach((adjuster, index) => {
                const row = document.createElement('tr');
                row.onclick = () => selectTableRow(row, 'adjuster', index);
                row.innerHTML = `
                    <td>${adjuster.name}</td>
                    <td><span class="category-badge ${adjuster.category}">${adjuster.category.charAt(0).toUpperCase() + adjuster.category.slice(1)}</span></td>
                    <td>${adjuster.concentration}%</td>
                `;
                tbody.appendChild(row);
            });

            table.style.display = 'table';
        }

        function removeSelectedAdjuster() {
            const selectedRow = document.querySelector('#adjusters-table tr.selected');
            if (!selectedRow) {
                alert('Please select an adjuster to remove');
                return;
            }

            const index = parseInt(selectedRow.dataset.index);
            currentPHFormula.adjusters.splice(index, 1);
            updateAdjustersTable();
        }

        function updateBufferInfo() {
            const bufferSystem = document.getElementById('buffer-system').value;
            const infoDiv = document.getElementById('buffer-info');
            
            if (!bufferSystem) {
                infoDiv.style.display = 'none';
                return;
            }

            const bufferData = {
                citrate: {
                    name: 'Citric Acid/Sodium Citrate',
                    pH_range: '3.0-6.2',
                    components: 'Citric acid (C‚ÇÜH‚ÇàO‚Çá) + Sodium citrate (Na‚ÇÉC‚ÇÜH‚ÇÖO‚Çá)',
                    preparation: 'Mix citric acid and sodium citrate in appropriate ratio for desired pH'
                },
                phosphate: {
                    name: 'Phosphate Buffer',
                    pH_range: '6.2-8.2',
                    components: 'KH‚ÇÇPO‚ÇÑ + K‚ÇÇHPO‚ÇÑ or NaH‚ÇÇPO‚ÇÑ + Na‚ÇÇHPO‚ÇÑ',
                    preparation: 'Physiological buffer system, excellent for pH 7.0-7.4'
                },
                tris: {
                    name: 'Tris Buffer',
                    pH_range: '7.0-9.0',
                    components: 'Tris base + Tris-HCl',
                    preparation: 'Excellent buffering capacity, temperature sensitive'
                },
                acetate: {
                    name: 'Acetate Buffer',
                    pH_range: '3.6-5.6',
                    components: 'Acetic acid + Sodium acetate',
                    preparation: 'Good for mildly acidic formulations'
                },
                carbonate: {
                    name: 'Carbonate Buffer',
                    pH_range: '9.2-10.8',
                    components: 'Na‚ÇÇCO‚ÇÉ + NaHCO‚ÇÉ',
                    preparation: 'For alkaline formulations, CO‚ÇÇ sensitive'
                }
            };

            const buffer = bufferData[bufferSystem];
            document.getElementById('buffer-details').innerHTML = `
                <strong>${buffer.name}</strong><br>
                <strong>pH Range:</strong> ${buffer.pH_range}<br>
                <strong>Components:</strong> ${buffer.components}<br>
                <strong>Notes:</strong> ${buffer.preparation}
            `;
            
            infoDiv.style.display = 'block';
        }

        function calculateBuffer() {
            const bufferSystem = document.getElementById('buffer-system').value;
            const concentration = parseFloat(document.getElementById('buffer-concentration').value);
            const batchVolume = parseFloat(document.getElementById('batch-volume').value) || 1.0;

            if (!bufferSystem || !concentration) {
                alert('Please select buffer system and enter concentration');
                return;
            }

            const totalMoles = (concentration / 1000) * batchVolume; // Convert mM to moles
            
            let component1Amount = 0;
            let component2Amount = 0;
            let component1Name = '';
            let component2Name = '';

            // Calculate buffer component amounts based on Henderson-Hasselbalch equation
            const targetPH = currentPHFormula.targetPH || 7.0;
            
            switch(bufferSystem) {
                case 'citrate':
                    component1Name = 'Citric Acid';
                    component2Name = 'Sodium Citrate';
                    // Simplified calculation for pH 5.0
                    component1Amount = totalMoles * 0.3 * 192.12; // MW of citric acid
                    component2Amount = totalMoles * 0.7 * 294.10; // MW of sodium citrate
                    break;
                case 'phosphate':
                    component1Name = 'KH‚ÇÇPO‚ÇÑ';
                    component2Name = 'K‚ÇÇHPO‚ÇÑ';
                    component1Amount = totalMoles * 0.5 * 136.09;
                    component2Amount = totalMoles * 0.5 * 174.18;
                    break;
                case 'tris':
                    component1Name = 'Tris Base';
                    component2Name = 'Tris-HCl';
                    component1Amount = totalMoles * 0.8 * 121.14;
                    component2Amount = totalMoles * 0.2 * 157.60;
                    break;
                default:
                    component1Amount = totalMoles * 0.5;
                    component2Amount = totalMoles * 0.5;
            }

            currentPHFormula.bufferSystem = {
                system: bufferSystem,
                concentration: concentration,
                component1: component1Name,
                component2: component2Name,
                amount1: component1Amount,
                amount2: component2Amount
            };

            const resultDiv = document.getElementById('buffer-result');
            resultDiv.innerHTML = `
                <strong>Buffer Calculated!</strong><br>
                ${component1Name}: ${component1Amount.toFixed(3)}g<br>
                ${component2Name}: ${component2Amount.toFixed(3)}g<br>
                Total volume: ${batchVolume}L
            `;
            resultDiv.className = 'result-display';
            resultDiv.style.display = 'block';
        }

        // Formula Generation Functions
        function generatePHFormula() {
            const formulaName = document.getElementById('formula-name').value || 'pH Adjustment Formula';
            const adjustmentNotes = document.getElementById('adjustment-notes').value;
            const qcNotes = document.getElementById('qc-notes').value;

            if (!currentPHFormula.currentPH || !currentPHFormula.targetPH) {
                alert('Please analyze current pH and calculate pH adjustment first');
                return;
            }

            let formulaHTML = `
                <div style="background: white; border-radius: 8px; padding: 20px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3>${formulaName}</h3>
                    <p><strong>Product Type:</strong> ${currentPHFormula.productType.charAt(0).toUpperCase() + currentPHFormula.productType.slice(1)} | <strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0; padding: 15px; background: #e8f5f5; border-radius: 8px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #4ECDC4;">${currentPHFormula.currentPH.toFixed(2)}</div>
                            <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">Current pH</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #4ECDC4;">${currentPHFormula.targetPH.toFixed(2)}</div>
                            <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">Target pH</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #4ECDC4;">${(currentPHFormula.targetPH - currentPHFormula.currentPH).toFixed(2)}</div>
                            <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">pH Adjustment</div>
                        </div>
                    </div>
            `;

            if (currentPHFormula.adjusters.length > 0) {
                formulaHTML += `
                    <h4 style="color: #4ECDC4; margin-top: 20px;">pH Adjusters</h4>
                    <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                        <thead>
                            <tr style="background: #4ECDC4; color: white;">
                                <th style="padding: 12px; text-align: left;">Adjuster</th>
                                <th style="padding: 12px; text-align: left;">Type</th>
                                <th style="padding: 12px; text-align: left;">Concentration</th>
                                <th style="padding: 12px; text-align: left;">Mechanism</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                currentPHFormula.adjusters.forEach(adjuster => {
                    formulaHTML += `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px;">${adjuster.name}</td>
                            <td style="padding: 10px;"><span class="category-badge ${adjuster.category}">${adjuster.category.charAt(0).toUpperCase() + adjuster.category.slice(1)}</span></td>
                            <td style="padding: 10px;">${adjuster.concentration}%</td>
                            <td style="padding: 10px; font-size: 0.8rem;">${adjuster.data.mechanism}</td>
                        </tr>
                    `;
                });

                formulaHTML += `</tbody></table>`;
            }

            if (currentPHFormula.bufferSystem) {
                formulaHTML += `
                    <h4 style="color: #4ECDC4; margin-top: 20px;">Buffer System</h4>
                    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <strong>System:</strong> ${currentPHFormula.bufferSystem.system.charAt(0).toUpperCase() + currentPHFormula.bufferSystem.system.slice(1)}<br>
                        <strong>Concentration:</strong> ${currentPHFormula.bufferSystem.concentration}mM<br>
                        <strong>${currentPHFormula.bufferSystem.component1}:</strong> ${currentPHFormula.bufferSystem.amount1.toFixed(3)}g<br>
                        <strong>${currentPHFormula.bufferSystem.component2}:</strong> ${currentPHFormula.bufferSystem.amount2.toFixed(3)}g
                    </div>
                `;
            }

            if (adjustmentNotes) {
                formulaHTML += `
                    <h4 style="color: #4ECDC4; margin-top: 20px;">Adjustment Procedure:</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${adjustmentNotes}</div>
                `;
            }

            if (qcNotes) {
                formulaHTML += `
                    <h4 style="color: #4ECDC4; margin-top: 20px;">Quality Control:</h4>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${qcNotes}</div>
                `;
            }

            formulaHTML += `
                <div style="margin-top: 20px; padding: 15px; background: #e8f5f5; border-radius: 6px; font-size: 0.9rem;">
                    <h4 style="color: #2c5282; margin-bottom: 8px;">‚ö†Ô∏è Safety & Handling</h4>
                    <ul style="margin: 8px 0; padding-left: 16px;">
                        <li>Always wear appropriate PPE when handling pH adjusters</li>
                        <li>Add adjusters slowly while mixing to prevent localized pH spikes</li>
                        <li>Allow equilibration time between additions (minimum 5 minutes)</li>
                        <li>Validate pH with calibrated meter before final packaging</li>
                        <li>Document all pH measurements and adjustments</li>
                    </ul>
                </div>
            `;

            formulaHTML += '</div>';

            document.getElementById('ph-formula-display').innerHTML = formulaHTML;
        }

        function exportPHPDF() {
            if (!currentPHFormula.currentPH || !currentPHFormula.targetPH) {
                alert('Please complete pH analysis first');
                return;
            }

            if (!window.jspdf) {
                alert('PDF library not loaded. Please refresh the page and try again.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            const formulaName = document.getElementById('formula-name').value || 'pH Adjustment Formula';

            let yPosition = 20;

            // Header
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text(formulaName, 20, yPosition);
            yPosition += 12;

            pdf.setFontSize(8);
            pdf.setFont(undefined, 'normal');
            pdf.text('Professional pH Calculator - Philip Riachy, PhD', 140, 15);
            pdf.text(`Date: ${new Date().toLocaleDateString()}`, 20, yPosition);
            yPosition += 15;

            // pH Summary
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('pH Analysis Summary', 20, yPosition);
            yPosition += 8;

            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Product Type: ${currentPHFormula.productType}`, 20, yPosition);
            pdf.text(`Current pH: ${currentPHFormula.currentPH.toFixed(2)}`, 80, yPosition);
            pdf.text(`Target pH: ${currentPHFormula.targetPH.toFixed(2)}`, 130, yPosition);
            yPosition += 5;
            pdf.text(`pH Adjustment Required: ${(currentPHFormula.targetPH - currentPHFormula.currentPH).toFixed(2)} units`, 20, yPosition);
            yPosition += 12;

            // pH Adjusters
            if (currentPHFormula.adjusters.length > 0) {
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('pH Adjusters', 20, yPosition);
                yPosition += 8;

                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                currentPHFormula.adjusters.forEach(adjuster => {
                    pdf.text(`${adjuster.name} (${adjuster.category})`, 20, yPosition);
                    pdf.text(`${adjuster.concentration}%`, 100, yPosition);
                    yPosition += 4;
                });
                yPosition += 5;
            }

            // Buffer System
            if (currentPHFormula.bufferSystem) {
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('Buffer System', 20, yPosition);
                yPosition += 8;

                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                pdf.text(`System: ${currentPHFormula.bufferSystem.system}`, 20, yPosition);
                pdf.text(`Concentration: ${currentPHFormula.bufferSystem.concentration}mM`, 80, yPosition);
                yPosition += 4;
                pdf.text(`${currentPHFormula.bufferSystem.component1}: ${currentPHFormula.bufferSystem.amount1.toFixed(3)}g`, 20, yPosition);
                yPosition += 4;
                pdf.text(`${currentPHFormula.bufferSystem.component2}: ${currentPHFormula.bufferSystem.amount2.toFixed(3)}g`, 20, yPosition);
                yPosition += 10;
            }

            // Notes
            const adjustmentNotes = document.getElementById('adjustment-notes').value;
            if (adjustmentNotes) {
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text('Adjustment Procedure:', 20, yPosition);
                yPosition += 6;

                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                const lines = pdf.splitTextToSize(adjustmentNotes, 170);
                lines.forEach(line => {
                    if (yPosition > 270) return;
                    pdf.text(line, 20, yPosition);
                    yPosition += 3;
                });
            }

            const fileName = `${formulaName.replace(/[^a-z0-9]/gi, '_')}_pH_Formula.pdf`;
            pdf.save(fileName);
        }

        // Data Management Functions
        function savePHFormula() {
            const formulaName = document.getElementById('formula-name').value || 'ph_formula';
            
            const data = {
                formula: currentPHFormula,
                formulaDetails: {
                    name: document.getElementById('formula-name').value,
                    id: document.getElementById('formula-id').value,
                    adjustmentNotes: document.getElementById('adjustment-notes').value,
                    qcNotes: document.getElementById('qc-notes').value,
                    batchVolume: document.getElementById('batch-volume').value
                },
                timestamp: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${formulaName.replace(/[^a-z0-9]/gi, '_')}_ph_formula.json`;
            link.click();
            
            URL.revokeObjectURL(link.href);
        }

        function loadPHFormula() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        currentPHFormula = data.formula || {
                            currentPH: null,
                            targetPH: null,
                            productType: null,
                            adjusters: [],
                            bufferSystem: null
                        };
                        
                        if (data.formulaDetails) {
                            document.getElementById('formula-name').value = data.formulaDetails.name || '';
                            document.getElementById('formula-id').value = data.formulaDetails.id || '';
                            document.getElementById('adjustment-notes').value = data.formulaDetails.adjustmentNotes || '';
                            document.getElementById('qc-notes').value = data.formulaDetails.qcNotes || '';
                            document.getElementById('batch-volume').value = data.formulaDetails.batchVolume || '1.0';
                        }
                        
                        if (currentPHFormula.currentPH) {
                            document.getElementById('current-ph').value = currentPHFormula.currentPH;
                            updatePHMarker();
                        }
                        
                        if (currentPHFormula.targetPH) {
                            document.getElementById('target-ph').value = currentPHFormula.targetPH;
                        }
                        
                        if (currentPHFormula.productType) {
                            document.getElementById('product-type').value = currentPHFormula.productType;
                        }
                        
                        updateAdjustersTable();
                        
                        alert('pH formula loaded successfully!');
                        
                    } catch (error) {
                        console.error('Error loading formula:', error);
                        alert('Error loading formula file. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllPHData() {
            if (confirm('Are you sure you want to clear all data and start a new pH formula?')) {
                currentPHFormula = {
                    currentPH: null,
                    targetPH: null,
                    productType: null,
                    adjusters: [],
                    bufferSystem: null
                };
                
                // Clear form fields
                document.getElementById('formula-name').value = '';
                document.getElementById('formula-id').value = '';
                document.getElementById('adjustment-notes').value = '';
                document.getElementById('qc-notes').value = '';
                document.getElementById('current-ph').value = '';
                document.getElementById('target-ph').value = '';
                document.getElementById('product-type').value = '';
                document.getElementById('batch-volume').value = '1.0';
                document.getElementById('adjuster-select').value = '';
                document.getElementById('adjuster-concentration').value = '';
                document.getElementById('buffer-system').value = '';
                document.getElementById('buffer-concentration').value = '10';
                
                // Clear display fields
                document.getElementById('display-current-ph').value = '';
                document.getElementById('display-target-ph').value = '';
                document.getElementById('display-batch-size').value = '';
                document.getElementById('display-product-type').value = '';
                
                // Reset displays
                updateAdjustersTable();
                document.getElementById('ph-marker').style.display = 'none';
                document.querySelectorAll('.category-badge').forEach(badge => badge.classList.remove('selected'));
                document.getElementById('ph-analysis-result').style.display = 'none';
                document.getElementById('ph-detailed-analysis').style.display = 'none';
                document.getElementById('adjustment-result').style.display = 'none';
                document.getElementById('adjuster-info').style.display = 'none';
                document.getElementById('buffer-info').style.display = 'none';
                document.getElementById('buffer-result').style.display = 'none';
                document.getElementById('ph-formula-display').innerHTML = '';
                
                // Repopulate dropdown
                populateAdjusterDropdown();
                
                alert('Started new pH formula!');
            }
        }

        // Utility Functions
        function selectTableRow(row, type, index) {
            const table = row.closest('table');
            table.querySelectorAll('tr').forEach(tr => tr.classList.remove('selected'));
            row.classList.add('selected');
            row.dataset.index = index;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePHApp);
    </script>
</body>
</html>
