<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulation pH Adjustment Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            font-size: 2em;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border: 2px solid #e0e0e0;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .input-group input {
            flex: 1;
        }
        
        .unit {
            color: #666;
            font-weight: 600;
            min-width: 30px;
        }
        
        .ph-visual {
            position: relative;
            height: 60px;
            background: linear-gradient(to right,
                #ff0000 0%, #ff6600 14%, #ffcc00 28%,
                #ffff00 35%, #00ff00 50%, #00cccc 64%,
                #0066ff 78%, #6600ff 100%);
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .ph-markers {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        
        .ph-arrow {
            position: absolute;
            bottom: -30px;
            transform: translateX(-50%);
            font-size: 2em;
            transition: all 0.3s ease;
        }
        
        .current-ph-arrow {
            color: #000;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
        }
        
        .target-ph-arrow {
            color: #667eea;
            filter: drop-shadow(0 2px 3px rgba(102, 126, 234, 0.5));
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .adjuster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .adjuster-card {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
        }
        
        .adjuster-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .adjuster-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .adjuster-card.acidic { border-left: 4px solid #ff6b6b; }
        .adjuster-card.basic { border-left: 4px solid #4ecdc4; }
        .adjuster-card.buffer { border-left: 4px solid #45b7d1; }
        
        .result-box {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e0e0e0;
        }
        
        .result-header {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }
        
        .result-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin: 10px 0;
        }
        
        .result-details {
            color: #666;
            line-height: 1.6;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .safety-box {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .info-box {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .formula-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .formula-summary h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .formula-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            padding: 20px 30px 0;
            background: white;
        }
        
        .tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: #f8f9fa;
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        @media (max-width: 768px) {
            .main-content, .tab-content.active {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Formulation pH Adjustment Calculator</h1>
        <div style="background: rgba(255,255,255,0.95); padding: 15px; text-align: center; color: #333; border-bottom: 2px solid rgba(0,0,0,0.1);">
            <strong>‚öóÔ∏è pH Science:</strong> pH is logarithmic - each 1 pH unit = 10√ó change in [H‚Å∫] concentration. 
            A change from pH 7 to pH 5 means <strong>100√ó more</strong> hydrogen ions!
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('quick')">Quick Adjustment</button>
            <button class="tab" onclick="switchTab('precise')">Precise Control</button>
            <button class="tab" onclick="switchTab('batch')">Batch Calculator</button>
        </div>

        <!-- Quick Adjustment Tab -->
        <div id="quick-tab" class="tab-content active">
            <div class="section">
                <h2>üìä Current Formulation</h2>
                
                <div class="form-group">
                    <label>Product Type</label>
                    <select id="product-type" class="form-control">
                        <option value="">Select product type...</option>
                        <option value="cleanser">Cleanser (pH 5.5-6.5)</option>
                        <option value="toner">Toner (pH 3.5-5.5)</option>
                        <option value="serum">Serum (pH 3.0-6.0)</option>
                        <option value="moisturizer">Moisturizer (pH 5.0-7.0)</option>
                        <option value="shampoo">Shampoo (pH 4.5-6.0)</option>
                        <option value="conditioner">Conditioner (pH 3.5-5.0)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Current pH</label>
                    <div class="input-group">
                        <input type="number" id="current-ph" class="form-control" step="0.1" min="0" max="14" placeholder="7.2" oninput="updatePHVisual()">
                    </div>
                </div>

                <div class="form-group">
                    <label>Target pH</label>
                    <div class="input-group">
                        <input type="number" id="target-ph" class="form-control" step="0.1" min="0" max="14" placeholder="5.5" oninput="updatePHVisual()">
                    </div>
                </div>

                <div class="form-group">
                    <label>Batch Size</label>
                    <div class="input-group">
                        <input type="number" id="batch-size" class="form-control" step="any" min="0" value="1000">
                        <select id="batch-unit" class="form-control" style="max-width: 100px;">
                            <option value="g">grams</option>
                            <option value="kg">kg</option>
                            <option value="ml">mL</option>
                            <option value="l">L</option>
                        </select>
                    </div>
                </div>

                <div class="ph-visual" id="ph-visual">
                    <div class="ph-arrow current-ph-arrow" id="current-arrow" style="left: 50%;">‚ñº</div>
                    <div class="ph-arrow target-ph-arrow" id="target-arrow" style="left: 39.3%;">‚ñ≤</div>
                </div>
                <div class="ph-markers">
                    <span>0</span><span>2</span><span>4</span><span>6</span><span>8</span><span>10</span><span>12</span><span>14</span>
                </div>
            </div>

            <div class="section">
                <h2>‚öóÔ∏è pH Adjuster Selection</h2>
                
                <div class="form-group">
                    <label>Choose Adjuster Type</label>
                    <div class="adjuster-grid">
                        <div class="adjuster-card acidic" onclick="selectAdjuster('citric')">
                            <strong>Citric Acid</strong><br>
                            <small>Gentle, buffering</small>
                        </div>
                        <div class="adjuster-card acidic" onclick="selectAdjuster('lactic')">
                            <strong>Lactic Acid</strong><br>
                            <small>Skin-friendly</small>
                        </div>
                        <div class="adjuster-card acidic" onclick="selectAdjuster('glycolic')">
                            <strong>Glycolic Acid</strong><br>
                            <small>Exfoliating</small>
                        </div>
                        <div class="adjuster-card basic" onclick="selectAdjuster('naoh')">
                            <strong>NaOH</strong><br>
                            <small>Strong base</small>
                        </div>
                        <div class="adjuster-card basic" onclick="selectAdjuster('tea')">
                            <strong>TEA</strong><br>
                            <small>Mild, buffering</small>
                        </div>
                        <div class="adjuster-card buffer" onclick="selectAdjuster('phosphate')">
                            <strong>Phosphate Buffer</strong><br>
                            <small>pH 6-8</small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Solution Concentration</label>
                    <div class="input-group">
                        <input type="number" id="adjuster-conc" class="form-control" value="10" min="1" max="100" step="1">
                        <span class="unit">%</span>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="calculateAdjustment()">Calculate Required Amount</button>
            </div>
        </div>

        <!-- Precise Control Tab -->
        <div id="precise-tab" class="tab-content">
            <div class="section">
                <h2>üéØ Precise pH Control</h2>
                
                <div class="form-group">
                    <label>Current pH</label>
                    <input type="number" id="precise-current" class="form-control" step="0.01" value="7.2">
                </div>

                <div class="form-group">
                    <label>Target pH</label>
                    <input type="number" id="precise-target" class="form-control" step="0.01" value="5.5">
                </div>

                <div class="form-group">
                    <label>pH Tolerance (¬±)</label>
                    <select id="tolerance" class="form-control">
                        <option value="0.05">¬±0.05 (Pharmaceutical)</option>
                        <option value="0.1" selected>¬±0.1 (Premium)</option>
                        <option value="0.2">¬±0.2 (Standard)</option>
                        <option value="0.3">¬±0.3 (Basic)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Buffer Capacity</label>
                    <select id="buffer-level" class="form-control">
                        <option value="low">Low (No buffer)</option>
                        <option value="medium" selected>Medium (Some buffering)</option>
                        <option value="high">High (Strong buffer)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Ionic Strength (M)</label>
                    <input type="number" id="ionic-strength" class="form-control" step="0.01" value="0.1">
                </div>

                <button class="btn btn-primary" onclick="calculatePrecise()">Calculate with Corrections</button>
            </div>

            <div class="section">
                <h2>üìã Advanced Settings</h2>
                
                <div class="form-group">
                    <label>Temperature (¬∞C)</label>
                    <input type="number" id="temperature" class="form-control" value="25">
                </div>

                <div class="form-group">
                    <label>Calculation Method</label>
                    <select id="calc-method" class="form-control">
                        <option value="simple">Simple (Fast)</option>
                        <option value="henderson">Henderson-Hasselbalch</option>
                        <option value="iterative" selected>Newton-Raphson (Accurate)</option>
                        <option value="davies">Davies Correction (High Ionic)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Safety Factor</label>
                    <input type="number" id="safety-factor" class="form-control" value="0.9" step="0.1" min="0.5" max="1.0">
                    <small style="color: #666;">Add this fraction to account for buffer resistance</small>
                </div>

                <div id="precise-result" class="result-box" style="display: none;"></div>
            </div>
        </div>

        <!-- Batch Calculator Tab -->
        <div id="batch-tab" class="tab-content">
            <div class="section">
                <h2>üì¶ Batch Production</h2>
                
                <div class="form-group">
                    <label>Production Batch Size</label>
                    <div class="input-group">
                        <input type="number" id="prod-batch" class="form-control" value="100">
                        <select id="prod-unit" class="form-control" style="max-width: 100px;">
                            <option value="kg" selected>kg</option>
                            <option value="l">L</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Lab pH (from test batch)</label>
                    <input type="number" id="lab-ph" class="form-control" step="0.1" value="7.0">
                </div>

                <div class="form-group">
                    <label>Production Target pH</label>
                    <input type="number" id="prod-target" class="form-control" step="0.1" value="5.5">
                </div>

                <div class="form-group">
                    <label>Lab Adjustment (per kg)</label>
                    <div class="input-group">
                        <input type="number" id="lab-amount" class="form-control" step="0.001" value="0.5">
                        <span class="unit">g</span>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="scaleToBatch()">Scale to Production</button>
            </div>

            <div class="section">
                <h2>üìä Batch Calculation Results</h2>
                <div id="batch-result" class="result-box" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        const ADJUSTERS = {
            citric: {
                name: "Citric Acid",
                category: "acidic",
                pKa: [3.13, 4.76, 6.40],
                strength: 0.52,  // Adjusted for triprotic acid effectiveness
                mw: 192.12
            },
            lactic: {
                name: "Lactic Acid",
                category: "acidic",
                pKa: [3.86],
                strength: 0.90,  // Monoprotic, quite effective
                mw: 90.08
            },
            glycolic: {
                name: "Glycolic Acid",
                category: "acidic",
                pKa: [3.83],
                strength: 1.05,  // Very effective, strong acid
                mw: 76.05
            },
            naoh: {
                name: "Sodium Hydroxide",
                category: "basic",
                pKa: [15.7],
                strength: 2.5,  // Very strong base
                mw: 40.00
            },
            tea: {
                name: "Triethanolamine",
                category: "basic",
                pKa: [7.76],
                strength: 0.65,  // Weak base
                mw: 149.19
            },
            phosphate: {
                name: "Phosphate Buffer",
                category: "buffer",
                pKa: [2.15, 7.20, 12.35],
                strength: 0.80,  // Buffer system
                mw: 142.0
            }
        };

        let selectedAdjuster = null;

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function selectAdjuster(adjusterKey) {
            selectedAdjuster = adjusterKey;
            document.querySelectorAll('.adjuster-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.adjuster-card').classList.add('selected');
        }

        function updatePHVisual() {
            const current = parseFloat(document.getElementById('current-ph').value);
            const target = parseFloat(document.getElementById('target-ph').value);
            
            if (!isNaN(current)) {
                const currentPos = (current / 14) * 100;
                document.getElementById('current-arrow').style.left = currentPos + '%';
            }
            
            if (!isNaN(target)) {
                const targetPos = (target / 14) * 100;
                document.getElementById('target-arrow').style.left = targetPos + '%';
            }
        }

        function calculateAdjustment() {
            const currentPH = parseFloat(document.getElementById('current-ph').value);
            const targetPH = parseFloat(document.getElementById('target-ph').value);
            const batchSize = parseFloat(document.getElementById('batch-size').value);
            const batchUnit = document.getElementById('batch-unit').value;
            const adjusterConc = parseFloat(document.getElementById('adjuster-conc').value);
            
            if (isNaN(currentPH) || isNaN(targetPH) || !selectedAdjuster) {
                alert('Please fill all fields and select an adjuster');
                return;
            }

            const adjuster = ADJUSTERS[selectedAdjuster];
            
            // Check if direction matches adjuster
            const needAcid = currentPH > targetPH;
            const isAcid = adjuster.category === 'acidic';
            
            if ((needAcid && !isAcid) || (!needAcid && isAcid && adjuster.category !== 'buffer')) {
                alert(`Wrong adjuster! You need ${needAcid ? 'an acid' : 'a base'} to achieve target pH`);
                return;
            }
            
            // CORRECT CALCULATION using logarithmic relationship
            // pH = -log[H+], so [H+] = 10^(-pH)
            
            const H_current = Math.pow(10, -currentPH);  // Current [H+] in M
            const H_target = Math.pow(10, -targetPH);    // Target [H+] in M
            
            // Calculate the change in [H+] concentration
            let deltaH = Math.abs(H_target - H_current);  // Change in molarity
            
            // Large pH change warning
            const pHChange = Math.abs(targetPH - currentPH);
            let largeChangeWarning = '';
            if (pHChange > 2) {
                largeChangeWarning = `<div class="warning-box" style="margin-top: 15px;">
                    <strong>‚ö†Ô∏è Large pH Change:</strong> Changing pH by ${pHChange.toFixed(1)} units is significant. 
                    Consider adjusting in multiple stages or reformulating the base recipe.
                </div>`;
            }
            
            // Convert batch size to liters (assuming density ~1 g/mL for water-based)
            let batchLiters;
            if (batchUnit === 'kg' || batchUnit === 'g') {
                batchLiters = batchUnit === 'kg' ? batchSize : batchSize / 1000;
            } else if (batchUnit === 'ml') {
                batchLiters = batchSize / 1000;
            } else {
                batchLiters = batchSize;
            }
            
            // Calculate moles of H+ or OH- needed
            const molesNeeded = deltaH * batchLiters;
            
            // Account for buffer capacity - varies by pH range
            // Near neutral pH: higher buffering
            // Extreme pH: lower buffering
            const avgPH = (currentPH + targetPH) / 2;
            let bufferFactor;
            if (avgPH >= 4 && avgPH <= 10) {
                bufferFactor = 3.0; // High buffering near neutral
            } else if (avgPH >= 2 && avgPH <= 12) {
                bufferFactor = 2.0; // Moderate buffering
            } else {
                bufferFactor = 1.5; // Less buffering at extremes
            }
            
            const molesWithBuffer = molesNeeded * bufferFactor;
            
            // Calculate mass of adjuster needed
            // For acids: use molecular weight and concentration
            // The adjuster solution concentration affects this
            const adjusterMolarity = (adjusterConc / 100) * (1000 / adjuster.mw); // Approximate molarity
            
            // Volume of adjuster solution needed (in mL)
            let volumeNeeded = (molesWithBuffer / adjusterMolarity) * 1000; // mL
            
            // For concentrated solutions, we need mass instead
            let massNeeded = molesWithBuffer * adjuster.mw; // grams of pure compound
            
            // Adjust for solution concentration
            massNeeded = massNeeded / (adjusterConc / 100); // Account for solution concentration
            
            // Apply empirical correction factor based on adjuster strength
            massNeeded *= (1 / adjuster.strength);
            
            // Convert units for display
            let displayAmount = massNeeded;
            let displayUnit = 'g';
            
            if (displayAmount > 1000) {
                displayAmount /= 1000;
                displayUnit = 'kg';
            }
            
            // For liquid adjusters, also show volume
            let volumeDisplay = volumeNeeded;
            let volumeUnit = 'mL';
            if (volumeNeeded > 1000) {
                volumeDisplay = volumeNeeded / 1000;
                volumeUnit = 'L';
            }
            
            // Calculate percentage of batch
            const percentOfBatch = (massNeeded / (batchUnit === 'kg' ? batchSize * 1000 : batchSize)) * 100;
            
            // Safety check
            let safetyWarning = '';
            
            if (percentOfBatch > 5) {
                safetyWarning = `<div class="safety-box">
                    <strong>‚ö†Ô∏è Safety Warning:</strong> Required amount (${percentOfBatch.toFixed(1)}%) exceeds 5% of batch. 
                    Consider using a more concentrated solution or making smaller adjustments.
                </div>`;
            }
            
            // Display results with scientific accuracy
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result-box';
            resultDiv.innerHTML = `
                <div class="result-header">Required Amount (Scientifically Calculated)</div>
                <div class="result-value">${displayAmount.toFixed(3)} ${displayUnit}</div>
                <div class="result-details">
                    <strong>${adjuster.name}</strong> at ${adjusterConc}% concentration<br>
                    ${adjuster.category === 'basic' || adjuster.category === 'acidic' ? 
                      `Alternative: ${volumeDisplay.toFixed(2)} ${volumeUnit} of solution<br>` : ''}
                    <br>
                    <strong>pH Change Details:</strong><br>
                    Current [H‚Å∫]: ${H_current.toExponential(2)} M<br>
                    Target [H‚Å∫]: ${H_target.toExponential(2)} M<br>
                    Concentration change: ${(Math.abs(H_target/H_current - 1) * 100).toFixed(0)}√ó 
                    ${needAcid ? 'increase' : 'decrease'}<br>
                    <br>
                    <strong>Application Instructions:</strong><br>
                    1. Prepare adjuster solution if using powder form<br>
                    2. Add in small increments (start with ${(displayAmount * 0.3).toFixed(3)} ${displayUnit})<br>
                    3. Mix thoroughly and wait 2-3 minutes<br>
                    4. Check pH before adding more<br>
                    5. Repeat until target pH ¬± 0.2 is reached
                </div>
                ${largeChangeWarning}
                ${safetyWarning}
                <div class="info-box" style="margin-top: 15px;">
                    <strong>üí° Scientific Note:</strong> pH is logarithmic - each unit represents a 10√ó change in [H‚Å∫]. 
                    A change from pH ${currentPH} to ${targetPH} requires ${Math.pow(10, Math.abs(targetPH - currentPH)).toFixed(0)}√ó 
                    ${needAcid ? 'more' : 'less'} hydrogen ions.
                </div>
            `;
            
            // Replace any existing result
            const existingResult = document.querySelector('#quick-tab .result-box');
            if (existingResult) {
                existingResult.remove();
            }
            
            document.querySelector('#quick-tab').appendChild(resultDiv);
        }

        function calculatePrecise() {
            const currentPH = parseFloat(document.getElementById('precise-current').value);
            const targetPH = parseFloat(document.getElementById('precise-target').value);
            const tolerance = parseFloat(document.getElementById('tolerance').value);
            const bufferLevel = document.getElementById('buffer-level').value;
            const ionicStrength = parseFloat(document.getElementById('ionic-strength').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const method = document.getElementById('calc-method').value;
            const safetyFactor = parseFloat(document.getElementById('safety-factor').value);
            
            // CORRECT: Use logarithmic relationship pH = -log[H+]
            const H_current = Math.pow(10, -currentPH);
            const H_target = Math.pow(10, -targetPH);
            
            // Temperature correction for Kw
            const tempCorrection = -6.0875e-3 * (temperature - 25) + 1.5e-5 * Math.pow(temperature - 25, 2);
            const Kw = 1.008e-14 * Math.exp(tempCorrection);
            
            // Davies equation for activity coefficient
            const z = 1; // Assume monovalent
            const sqrtI = Math.sqrt(ionicStrength);
            const logGamma = -0.509 * z * z * (sqrtI / (1 + sqrtI) - 0.3 * ionicStrength);
            const activityCoeff = Math.pow(10, logGamma);
            
            // Buffer capacity factors
            const bufferFactors = { low: 1.2, medium: 2.5, high: 5.0 };
            const bufferResistance = bufferFactors[bufferLevel];
            
            // Calculate H+ concentration change (accounting for activity)
            const H_current_corrected = H_current / activityCoeff;
            const H_target_corrected = H_target / activityCoeff;
            const deltaH = Math.abs(H_target_corrected - H_current_corrected);
            
            // Molar amount needed (for 1L as reference)
            const molesPerLiter = deltaH * bufferResistance * safetyFactor;
            
            // pH change ratio
            const pHRatio = Math.pow(10, Math.abs(targetPH - currentPH));
            
            const resultDiv = document.getElementById('precise-result');
            resultDiv.innerHTML = `
                <div class="result-header">Precise Calculation Results</div>
                <div class="result-details">
                    <strong>Calculation Method:</strong> ${method}<br>
                    <strong>Temperature-corrected Kw:</strong> ${Kw.toExponential(3)}<br>
                    <strong>Activity Coefficient (Œ≥):</strong> ${activityCoeff.toFixed(4)}<br>
                    <br>
                    <strong>Hydrogen Ion Concentrations:</strong><br>
                    Current [H‚Å∫]: ${H_current.toExponential(3)} M<br>
                    Target [H‚Å∫]: ${H_target.toExponential(3)} M<br>
                    Change needed: ${deltaH.toExponential(3)} M<br>
                    <br>
                    <strong>pH Change Analysis:</strong><br>
                    [H‚Å∫] ratio: ${pHRatio.toFixed(1)}√ó ${currentPH > targetPH ? 'increase' : 'decrease'}<br>
                    Buffer Resistance Factor: ${bufferResistance.toFixed(2)}<br>
                    Safety Factor Applied: ${safetyFactor.toFixed(2)}<br>
                    <br>
                    <strong>Molar Requirement:</strong> ${molesPerLiter.toExponential(3)} mol/L<br>
                </div>
                <div class="formula-summary">
                    <h3>Adjustment Summary</h3>
                    <div class="formula-item">
                        <span>Effective current pH:</span>
                        <strong>${(-Math.log10(H_current_corrected)).toFixed(3)}</strong>
                    </div>
                    <div class="formula-item">
                        <span>Effective target pH:</span>
                        <strong>${(-Math.log10(H_target_corrected)).toFixed(3)}</strong>
                    </div>
                    <div class="formula-item">
                        <span>Acceptable range:</span>
                        <strong>${(targetPH - tolerance).toFixed(2)} - ${(targetPH + tolerance).toFixed(2)}</strong>
                    </div>
                    <div class="formula-item">
                        <span>Estimated iterations:</span>
                        <strong>${Math.ceil(Math.abs(targetPH - currentPH) / 0.5)} adjustments</strong>
                    </div>
                </div>
                <div class="info-box" style="margin-top: 15px;">
                    <strong>üìä Understanding the Numbers:</strong><br>
                    A ${Math.abs(targetPH - currentPH).toFixed(1)} pH unit change means the [H‚Å∫] concentration 
                    ${currentPH > targetPH ? 'increases' : 'decreases'} by a factor of ${pHRatio.toFixed(0)}. 
                    This is why small pH changes can require significant amounts of adjuster.
                </div>
            `;
            resultDiv.style.display = 'block';
        }

        function scaleToBatch() {
            const prodBatch = parseFloat(document.getElementById('prod-batch').value);
            const labPH = parseFloat(document.getElementById('lab-ph').value);
            const prodTarget = parseFloat(document.getElementById('prod-target').value);
            const labAmount = parseFloat(document.getElementById('lab-amount').value);
            const prodUnit = document.getElementById('prod-unit').value;
            
            // CORRECT scaling using concentration ratios
            // Lab batch is typically 1 kg reference
            const labBatchSize = 1; // kg
            const scaleFactor = prodBatch / labBatchSize;
            
            // Direct linear scaling for same pH change
            const totalAmount = labAmount * scaleFactor;
            
            // Add 15% safety margin for production (more conservative than lab)
            const safeAmount = totalAmount * 1.15;
            
            // Calculate concentration changes
            const H_lab = Math.pow(10, -labPH);
            const H_target = Math.pow(10, -prodTarget);
            const concentrationRatio = Math.abs(H_target / H_lab);
            
            const resultDiv = document.getElementById('batch-result');
            resultDiv.innerHTML = `
                <div class="result-header">Production Batch Calculation</div>
                <div class="result-value">${safeAmount.toFixed(2)} kg</div>
                <div class="result-details">
                    Total adjuster needed for ${prodBatch} ${prodUnit} batch<br>
                    <small>(includes 15% safety margin for production)</small>
                </div>
                <div class="formula-summary">
                    <h3>Production Recipe</h3>
                    <div class="formula-item">
                        <span>Scale Factor:</span>
                        <strong>${scaleFactor.toFixed(0)}√ó</strong>
                    </div>
                    <div class="formula-item">
                        <span>Lab Amount √ó Scale:</span>
                        <strong>${totalAmount.toFixed(2)} kg</strong>
                    </div>
                    <div class="formula-item">
                        <span>With Safety Margin:</span>
                        <strong>${safeAmount.toFixed(2)} kg</strong>
                    </div>
                    <div class="formula-item">
                        <span>[H‚Å∫] Change:</span>
                        <strong>${concentrationRatio.toFixed(1)}√ó</strong>
                    </div>
                </div>
                <div class="info-box" style="margin-top: 15px;">
                    <strong>üìã Production Protocol:</strong><br>
                    ‚Ä¢ Dissolve in minimal water first<br>
                    ‚Ä¢ Add ${(safeAmount * 0.3).toFixed(2)} kg initially<br>
                    ‚Ä¢ Mix for 10-15 minutes<br>
                    ‚Ä¢ Check pH, add remaining in 2-3 portions<br>
                    ‚Ä¢ Final pH check after 30 minutes rest<br>
                    ‚Ä¢ Document actual usage for future batches
                </div>
            `;
            resultDiv.style.display = 'block';
        }

        // Initialize
        updatePHVisual();
        console.log('Formulation pH Adjustment Calculator Ready');
    </script>
</body>
</html>
