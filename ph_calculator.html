<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional pH Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #4ECDC4;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        h3 {
            color: #4ECDC4;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #4ECDC4;
        }

        .btn {
            padding: 12px 24px;
            background: #4ECDC4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn:hover {
            background: #45b8b0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }

        .btn-success {
            background: #52c41a;
        }

        .btn-success:hover {
            background: #49aa16;
        }

        .btn-danger {
            background: #ff4d4f;
        }

        .btn-danger:hover {
            background: #e63946;
        }

        .result-display {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5f5;
            border-radius: 8px;
            border-left: 4px solid #4ECDC4;
            display: none;
        }

        .result-display.warning {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .result-display.error {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .ph-scale {
            position: relative;
            height: 50px;
            background: linear-gradient(to right, 
                #ff0000 0%, #ff4500 7%, #ffa500 14%, 
                #ffff00 21%, #9acd32 28%, #7fff00 35%,
                #00ff00 42%, #00ffff 49%, #1e90ff 56%,
                #0000ff 63%, #4b0082 70%, #8b00ff 77%,
                #ff00ff 84%, #ff1493 91%, #ff69b4 100%);
            border-radius: 8px;
            margin: 20px 0;
        }

        .ph-scale-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .ph-marker {
            position: absolute;
            width: 4px;
            height: 60px;
            background: #333;
            top: -5px;
            display: none;
        }

        .ph-marker::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -8px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #333;
        }

        .ingredient-category {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .category-badge {
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .category-badge.acidic {
            background: #ffebee;
            color: #c62828;
        }

        .category-badge.basic {
            background: #e3f2fd;
            color: #1565c0;
        }

        .category-badge.neutral {
            background: #f1f8e9;
            color: #558b2f;
        }

        .category-badge.buffer {
            background: #fff3e0;
            color: #ef6c00;
        }

        .category-badge:hover {
            transform: scale(1.05);
        }

        .category-badge.selected {
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background: #4ECDC4;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        .data-table tr.selected {
            background: #e8f5f5;
        }

        .ph-analysis {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .recipe-section {
            background: #f0f8ff;
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .recipe-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .recipe-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .estimated-amount-box {
            background: #e8f5f5;
            border: 2px solid #4ECDC4;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .estimated-amount-box h4 {
            color: #4ECDC4;
            margin-bottom: 10px;
        }

        .amount-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .amount-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
        }

        .amount-item label {
            font-size: 0.9rem;
            color: #666;
        }

        .amount-item .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Professional pH Calculator</h1>
        <p class="subtitle">Precise pH Analysis and Adjustment Tool for Cosmetic Formulation</p>

        <div class="content">
            <!-- pH Analysis Section -->
            <div class="section">
                <h3>📊 Current pH Analysis</h3>
                
                <div class="form-group">
                    <label>Product Type</label>
                    <select id="product-type" class="form-control">
                        <option value="">Select product type...</option>
                        <option value="cleanser">Cleanser</option>
                        <option value="toner">Toner</option>
                        <option value="serum">Serum</option>
                        <option value="moisturizer">Moisturizer</option>
                        <option value="sunscreen">Sunscreen</option>
                        <option value="hair">Hair Product</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Current pH Value</label>
                    <input type="number" id="current-ph" class="form-control" step="any" min="0" max="14" placeholder="e.g., 6.5">
                </div>

                <div class="ph-scale">
                    <div id="ph-marker" class="ph-marker"></div>
                </div>
                <div class="ph-scale-labels">
                    <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span><span>11</span><span>12</span><span>13</span><span>14</span>
                </div>

                <button class="btn btn-success" onclick="analyzePH()">Analyze pH</button>
                <div id="ph-analysis-result" class="result-display"></div>

                <div class="ph-analysis" id="ph-detailed-analysis" style="display: none;">
                    <h4>pH Analysis</h4>
                    <div id="ph-classification"></div>
                    <div id="skin-compatibility"></div>
                    <div id="stability-assessment"></div>
                    <div id="regulatory-compliance"></div>
                </div>
            </div>

            <!-- Target pH Settings -->
            <div class="section">
                <h3>🎯 Target pH Settings</h3>
                
                <div class="form-group">
                    <label>Target pH</label>
                    <input type="number" id="target-ph" class="form-control" step="any" min="0" max="14" placeholder="e.g., 5.5">
                </div>
                
                <div class="form-group">
                    <label>pH Tolerance (±)</label>
                    <select id="ph-tolerance" class="form-control">
                        <option value="0.1">±0.1 (Pharmaceutical)</option>
                        <option value="0.2" selected>±0.2 (Premium Cosmetic)</option>
                        <option value="0.3">±0.3 (Standard Cosmetic)</option>
                        <option value="0.5">±0.5 (Basic Formulation)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Batch Volume (L)</label>
                    <input type="number" id="batch-volume" class="form-control" step="any" min="0" value="1.0">
                </div>

                <button class="btn btn-success" onclick="calculateAdjustment()">Calculate pH Adjustment</button>
                <div id="adjustment-result" class="result-display"></div>
            </div>

            <!-- pH Adjusters Database -->
            <div class="section">
                <h3>⚗️ pH Adjusters Database</h3>
                
                <div class="form-group">
                    <label>Adjuster Category</label>
                    <div class="ingredient-category">
                        <div class="category-badge acidic" onclick="selectAdjusterCategory('acidic')">Acidic</div>
                        <div class="category-badge basic" onclick="selectAdjusterCategory('basic')">Basic</div>
                        <div class="category-badge neutral" onclick="selectAdjusterCategory('neutral')">Neutral</div>
                        <div class="category-badge buffer" onclick="selectAdjusterCategory('buffer')">Buffer</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Select pH Adjuster</label>
                    <select id="adjuster-select" class="form-control" onchange="showAdjusterInfo()">
                        <option value="">Choose a pH adjuster...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Concentration (%)</label>
                    <input type="number" id="adjuster-concentration" class="form-control" step="any" min="0" placeholder="Solution concentration">
                </div>

                <div id="adjuster-info" class="ph-analysis" style="display: none;">
                    <h4 id="adjuster-name-display"></h4>
                    <div id="adjuster-details"></div>
                </div>

                <!-- New: Estimated Amount Calculation -->
                <div class="estimated-amount-box" id="estimated-amount-box">
                    <h4>📊 Calculated Amount Required</h4>
                    <div class="amount-details">
                        <div class="amount-item">
                            <label>Estimated Amount</label>
                            <div class="value" id="estimated-amount-value">-</div>
                        </div>
                        <div class="amount-item">
                            <label>pH Change</label>
                            <div class="value" id="ph-change-value">-</div>
                        </div>
                        <div class="amount-item">
                            <label>Solution Volume</label>
                            <div class="value" id="solution-volume-value">-</div>
                        </div>
                    </div>
                    <button class="btn" onclick="addAdjusterToFormula()" style="margin-top: 10px;">Add to Formula</button>
                </div>

                <div>
                    <button class="btn" onclick="calculateAdjusterAmount()">Calculate Amount</button>
                    <button class="btn btn-danger" onclick="removeSelectedAdjuster()">Remove</button>
                </div>

                <table class="data-table" id="adjusters-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>pH Adjuster</th>
                            <th>Type</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Formula Generation -->
            <div class="recipe-section">
                <h3>📋 Complete pH Adjustment Formula</h3>
                
                <div class="recipe-form">
                    <div>
                        <div class="form-group">
                            <label>Formula Name</label>
                            <input type="text" id="formula-name" class="form-control" placeholder="pH-Balanced Serum">
                        </div>
                        <div class="form-group">
                            <label>Current pH</label>
                            <input type="text" id="display-current-ph" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label>Target pH</label>
                            <input type="text" id="display-target-ph" class="form-control" readonly>
                        </div>
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label>Formula ID</label>
                            <input type="text" id="formula-id" class="form-control" placeholder="pH001">
                        </div>
                        <div class="form-group">
                            <label>Batch Size</label>
                            <input type="text" id="display-batch-size" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label>Product Category</label>
                            <input type="text" id="display-product-type" class="form-control" readonly>
                        </div>
                    </div>
                </div>

                <div class="recipe-buttons">
                    <button class="btn btn-success" onclick="generatePHFormula()">Generate pH Formula</button>
                </div>

                <div id="ph-formula-display"></div>
            </div>
        </div>
    </div>

    <script>
        // Comprehensive pH Adjusters Database
        const PH_ADJUSTERS_DATABASE = {
            // Acidic Adjusters
            "Citric Acid": {
                category: "acidic",
                pka: [3.13, 4.76, 6.40],
                molecular_weight: 192.12,
                max_usage: 2.0,
                solubility: "Very high (59.2g/100ml)",
                buffering_range: "3.0-6.2",
                advantages: ["Natural origin", "Multifunctional (chelating)", "GRAS status"],
                disadvantages: ["Can cause irritation at high concentrations"],
                typical_usage: "0.01-0.5%",
                mechanism: "Weak triprotic acid, provides gradual pH reduction with buffering capacity",
                strength_factor: 0.15 // Effectiveness factor for calculation
            },
            "Lactic Acid": {
                category: "acidic",
                pka: [3.86],
                molecular_weight: 90.08,
                max_usage: 10.0,
                solubility: "Very high (miscible)",
                buffering_range: "2.9-4.9",
                advantages: ["Natural moisturizing factor", "Gentle exfoliation", "Skin conditioning"],
                disadvantages: ["More expensive than mineral acids"],
                typical_usage: "0.1-2.0%",
                mechanism: "Alpha-hydroxy acid with mild buffering and humectant properties",
                strength_factor: 0.18
            },
            "Hydrochloric Acid": {
                category: "acidic",
                pka: [-6],
                molecular_weight: 36.46,
                max_usage: 1.0,
                solubility: "Complete",
                buffering_range: "None (strong acid)",
                advantages: ["Precise pH control", "No residual effects", "Inexpensive"],
                disadvantages: ["No buffering capacity", "Can cause sharp pH changes"],
                typical_usage: "0.001-0.1%",
                mechanism: "Strong acid providing immediate pH reduction without buffering",
                strength_factor: 1.0
            },
            "Phosphoric Acid": {
                category: "acidic",
                pka: [2.15, 7.20, 12.35],
                molecular_weight: 97.99,
                max_usage: 1.5,
                solubility: "Very high",
                buffering_range: "1.1-3.1, 6.2-8.2",
                advantages: ["Excellent buffering capacity", "Multi-functional"],
                disadvantages: ["Can interfere with some actives"],
                typical_usage: "0.01-0.5%",
                mechanism: "Triprotic acid with excellent buffering at physiological pH",
                strength_factor: 0.25
            },
            // Basic Adjusters
            "Sodium Hydroxide": {
                category: "basic",
                pka: [15.7],
                molecular_weight: 39.997,
                max_usage: 1.0,
                solubility: "Very high (111g/100ml)",
                buffering_range: "None (strong base)",
                advantages: ["Precise pH control", "Highly effective", "Inexpensive"],
                disadvantages: ["No buffering capacity", "Caustic at high concentrations"],
                typical_usage: "0.001-0.2%",
                mechanism: "Strong base providing immediate pH increase without buffering",
                strength_factor: 1.0
            },
            "Triethanolamine (TEA)": {
                category: "basic",
                pka: [7.76],
                molecular_weight: 149.19,
                max_usage: 5.0,
                solubility: "Complete",
                buffering_range: "6.8-8.8",
                advantages: ["Emulsifying properties", "Buffering capacity", "Multifunctional"],
                disadvantages: ["Potential nitrosamine formation", "Can yellow over time"],
                typical_usage: "0.1-2.0%",
                mechanism: "Tertiary amine with emulsifying and pH buffering properties",
                strength_factor: 0.12
            },
            "Aminomethyl Propanol (AMP)": {
                category: "basic",
                pka: [9.69],
                molecular_weight: 89.14,
                max_usage: 2.0,
                solubility: "Complete",
                buffering_range: "8.7-10.7",
                advantages: ["Excellent solubilizer", "Low odor", "Thermal stability"],
                disadvantages: ["Higher cost than TEA"],
                typical_usage: "0.1-1.0%",
                mechanism: "Primary amine providing pH adjustment with good buffering capacity",
                strength_factor: 0.15
            },
            "Potassium Hydroxide": {
                category: "basic",
                pka: [15.7],
                molecular_weight: 56.11,
                max_usage: 1.0,
                solubility: "Very high (121g/100ml)",
                buffering_range: "None (strong base)",
                advantages: ["Fast pH adjustment", "No residual effects"],
                disadvantages: ["No buffering", "More expensive than NaOH"],
                typical_usage: "0.001-0.2%",
                mechanism: "Strong base for immediate pH increase",
                strength_factor: 0.95
            }
        };

        // Application State
        let currentPHFormula = {
            currentPH: null,
            targetPH: null,
            productType: null,
            adjusters: [],
            bufferSystem: null
        };

        // Initialize Application
        function initializePHApp() {
            console.log('Initializing Professional pH Calculator...');
            populateAdjusterDropdown();
            setupPHEventListeners();
            console.log('pH Calculator ready!');
        }

        function populateAdjusterDropdown() {
            const adjusterSelect = document.getElementById('adjuster-select');
            Object.keys(PH_ADJUSTERS_DATABASE).sort().forEach(adjuster => {
                const option = document.createElement('option');
                option.value = adjuster;
                option.textContent = adjuster;
                adjusterSelect.appendChild(option);
            });
        }

        function setupPHEventListeners() {
            document.getElementById('current-ph').addEventListener('input', updatePHMarker);
            document.getElementById('target-ph').addEventListener('input', function() {
                updateDisplayField('display-target-ph', this.value);
            });
            document.getElementById('batch-volume').addEventListener('input', function() {
                updateDisplayField('display-batch-size', this.value + 'L');
            });
        }

        function updatePHMarker() {
            const phInput = document.getElementById('current-ph');
            const ph = parseFloat(phInput.value);
            const marker = document.getElementById('ph-marker');
            
            if (!isNaN(ph) && ph >= 0 && ph <= 14) {
                const position = (ph / 14) * 100;
                marker.style.left = `calc(${position}% - 2px)`;
                marker.style.display = 'block';
                // Fix: Use the actual input value directly, not the parsed float
                updateDisplayField('display-current-ph', phInput.value);
            } else {
                marker.style.display = 'none';
            }
        }

        function updateDisplayField(fieldId, value) {
            const field = document.getElementById(fieldId);
            if (field) field.value = value;
        }

        function analyzePH() {
            const currentPH = parseFloat(document.getElementById('current-ph').value);
            const productType = document.getElementById('product-type').value;
            
            if (isNaN(currentPH) || !productType) {
                alert('Please enter current pH and select product type');
                return;
            }

            currentPHFormula.currentPH = currentPH;
            currentPHFormula.productType = productType;

            let classification = '';
            let skinCompatibility = '';
            let stabilityAssessment = '';
            let regulatoryCompliance = '';
            let resultClass = '';

            // pH Range Analysis
            if (currentPH < 3.0) {
                classification = 'Strongly Acidic - Risk of irritation';
                skinCompatibility = 'Not suitable for skin contact';
                stabilityAssessment = 'Potential material degradation';
                regulatoryCompliance = 'Outside normal cosmetic range';
                resultClass = 'error';
            } else if (currentPH < 5.5) {
                classification = 'Mildly Acidic - Good for antimicrobial activity';
                skinCompatibility = 'Compatible with skin acid mantle';
                stabilityAssessment = 'Good for active stability';
                regulatoryCompliance = 'Suitable for most cosmetic applications';
                resultClass = '';
            } else if (currentPH < 7.0) {
                classification = 'Slightly Acidic - Physiologically compatible';
                skinCompatibility = 'Excellent skin compatibility';
                stabilityAssessment = 'Optimal for emulsion stability';
                regulatoryCompliance = 'Ideal for daily use products';
                resultClass = '';
            } else if (currentPH < 8.0) {
                classification = 'Neutral to Slightly Alkaline';
                skinCompatibility = 'Generally compatible';
                stabilityAssessment = 'May affect some active ingredients';
                regulatoryCompliance = 'Acceptable for specific product types';
                resultClass = '';
            } else {
                classification = 'Alkaline - May disrupt skin barrier';
                skinCompatibility = 'Use with caution';
                stabilityAssessment = 'Risk of hydrolysis for some ingredients';
                regulatoryCompliance = 'Limited to specific applications (soaps, etc.)';
                resultClass = 'warning';
            }

            // Product-specific recommendations
            const productRecommendations = {
                'cleanser': { ideal: '5.5-6.5', range: 'Gentle cleansing' },
                'toner': { ideal: '3.5-5.5', range: 'Optimal for toning' },
                'serum': { ideal: '3.0-6.0', range: 'Active-dependent' },
                'moisturizer': { ideal: '5.0-7.0', range: 'Skin barrier support' },
                'sunscreen': { ideal: '6.0-8.0', range: 'Filter stability' },
                'hair': { ideal: '4.5-6.5', range: 'Cuticle care' }
            };

            const productRec = productRecommendations[productType] || { ideal: 'N/A', range: 'N/A' };

            const resultDiv = document.getElementById('ph-analysis-result');
            resultDiv.innerHTML = `<strong>pH ${currentPH.toFixed(2)}</strong><br>${classification}`;
            resultDiv.className = `result-display ${resultClass}`;
            resultDiv.style.display = 'block';

            document.getElementById('ph-classification').innerHTML = `<strong>Classification:</strong> ${classification}`;
            document.getElementById('skin-compatibility').innerHTML = `<strong>Skin Compatibility:</strong> ${skinCompatibility}`;
            document.getElementById('stability-assessment').innerHTML = `<strong>Stability:</strong> ${stabilityAssessment}`;
            document.getElementById('regulatory-compliance').innerHTML = `<strong>Regulatory:</strong> ${regulatoryCompliance}<br><strong>Recommended pH for ${productType}:</strong> ${productRec.ideal} (${productRec.range})`;
            document.getElementById('ph-detailed-analysis').style.display = 'block';

            updateDisplayField('display-product-type', productType.charAt(0).toUpperCase() + productType.slice(1));
        }

        function calculateAdjustment() {
            const currentPH = parseFloat(document.getElementById('current-ph').value);
            const targetPH = parseFloat(document.getElementById('target-ph').value);
            const batchVolume = parseFloat(document.getElementById('batch-volume').value);
            
            if (isNaN(currentPH) || isNaN(targetPH) || isNaN(batchVolume)) {
                alert('Please enter current pH, target pH, and batch volume');
                return;
            }

            currentPHFormula.targetPH = targetPH;
            const pHDifference = targetPH - currentPH;

            let adjustmentDirection = '';
            let recommendedAdjusters = [];

            if (Math.abs(pHDifference) < 0.05) {
                adjustmentDirection = 'No adjustment needed - within tolerance';
            } else if (pHDifference > 0) {
                adjustmentDirection = 'pH needs to be increased (more basic)';
                recommendedAdjusters = ['Sodium Hydroxide', 'Triethanolamine (TEA)', 'Aminomethyl Propanol (AMP)'];
            } else {
                adjustmentDirection = 'pH needs to be decreased (more acidic)';
                recommendedAdjusters = ['Citric Acid', 'Lactic Acid', 'Hydrochloric Acid'];
            }

            const resultDiv = document.getElementById('adjustment-result');
            if (Math.abs(pHDifference) < 0.05) {
                resultDiv.innerHTML = `<strong>No Adjustment Required!</strong><br>Current pH is within target range.`;
                resultDiv.className = 'result-display';
            } else {
                resultDiv.innerHTML = `
                    <strong>pH Adjustment Required!</strong><br>
                    ${adjustmentDirection}<br>
                    ΔpH: ${pHDifference.toFixed(2)} units<br>
                    <strong>Recommended adjusters:</strong> ${recommendedAdjusters.join(', ')}
                `;
                resultDiv.className = 'result-display warning';
            }
            resultDiv.style.display = 'block';

            updateDisplayField('display-batch-size', batchVolume + 'L');
        }

        // NEW FUNCTION: Calculate the amount of adjuster needed
        function calculateAdjusterAmount() {
            const adjusterName = document.getElementById('adjuster-select').value;
            const concentration = parseFloat(document.getElementById('adjuster-concentration').value);
            const currentPH = parseFloat(document.getElementById('current-ph').value);
            const targetPH = parseFloat(document.getElementById('target-ph').value);
            const batchVolume = parseFloat(document.getElementById('batch-volume').value) || 1.0;

            if (!adjusterName) {
                alert('Please select a pH adjuster');
                return;
            }

            if (!concentration || concentration <= 0) {
                alert('Please enter a valid concentration');
                return;
            }

            if (isNaN(currentPH) || isNaN(targetPH)) {
                alert('Please analyze current pH and calculate pH adjustment first');
                return;
            }

            const adjusterData = PH_ADJUSTERS_DATABASE[adjusterName];
            const pHDifference = targetPH - currentPH;
            
            // Advanced calculation based on adjuster properties
            let estimatedAmount = 0;
            const strengthFactor = adjusterData.strength_factor || 0.1;
            
            // Calculate based on pH difference, batch volume, concentration, and adjuster strength
            // pH is logarithmic: pH = -log[H+], so [H+] ratio = 10^(-ΔpH)
            const volumeInML = batchVolume * 1000; // Convert L to mL
            const concentrationFactor = concentration / 100; // Convert % to decimal
            
            // CORRECTED: Use 10^(-ΔpH) for proper logarithmic calculation
            const pHChangeFactor = Math.pow(10, -pHDifference);
            
            // Base calculation: amount proportional to 10^|ΔpH| and inversely proportional to strength and concentration
            estimatedAmount = pHChangeFactor * volumeInML * (0.001 / (strengthFactor * concentrationFactor));
            
            // Apply category-specific adjustments
            if (adjusterData.category === 'acidic' && pHDifference < 0) {
                // Increasing acidity (lowering pH)
                estimatedAmount *= 1.0;
            } else if (adjusterData.category === 'basic' && pHDifference > 0) {
                // Increasing basicity (raising pH)
                estimatedAmount *= 1.0;
            } else if ((adjusterData.category === 'acidic' && pHDifference > 0) || 
                       (adjusterData.category === 'basic' && pHDifference < 0)) {
                alert('Wrong adjuster category selected for this pH change!');
                return;
            }

            // Calculate solution volume needed (in mL)
            const solutionVolume = estimatedAmount / concentrationFactor;

            // Display results
            document.getElementById('estimated-amount-value').textContent = `${estimatedAmount.toFixed(3)} g`;
            document.getElementById('ph-change-value').textContent = `${pHDifference.toFixed(2)} units`;
            document.getElementById('solution-volume-value').textContent = `${solutionVolume.toFixed(2)} mL`;
            document.getElementById('estimated-amount-box').style.display = 'block';

            // Store the calculation for potential use
            currentPHFormula.calculatedAdjuster = {
                name: adjusterName,
                amount: estimatedAmount,
                solutionVolume: solutionVolume,
                concentration: concentration
            };
        }

        function selectAdjusterCategory(category) {
            document.querySelectorAll('.category-badge').forEach(badge => {
                badge.classList.remove('selected');
            });
            document.querySelector(`.category-badge.${category}`).classList.add('selected');
            
            filterAdjustersByCategory(category);
        }

        function filterAdjustersByCategory(category) {
            const adjusterSelect = document.getElementById('adjuster-select');
            adjusterSelect.innerHTML = '<option value="">Choose a pH adjuster...</option>';
            
            Object.entries(PH_ADJUSTERS_DATABASE).forEach(([name, data]) => {
                if (data.category === category) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    adjusterSelect.appendChild(option);
                }
            });
        }

        function showAdjusterInfo() {
            const adjusterName = document.getElementById('adjuster-select').value;
            const infoDiv = document.getElementById('adjuster-info');
            const nameDisplay = document.getElementById('adjuster-name-display');
            const detailsDiv = document.getElementById('adjuster-details');

            if (!adjusterName) {
                infoDiv.style.display = 'none';
                return;
            }

            const data = PH_ADJUSTERS_DATABASE[adjusterName];
            nameDisplay.textContent = `${adjusterName} (${data.category.charAt(0).toUpperCase() + data.category.slice(1)})`;
            
            let detailsHTML = `
                <p><strong>pKa:</strong> ${Array.isArray(data.pka) ? data.pka.join(', ') : data.pka}</p>
                <p><strong>Molecular Weight:</strong> ${data.molecular_weight} g/mol</p>
                <p><strong>Buffering Range:</strong> ${data.buffering_range}</p>
                <p><strong>Typical Usage:</strong> ${data.typical_usage}</p>
                <p><strong>Mechanism:</strong> ${data.mechanism}</p>
                <p><strong>Advantages:</strong> ${data.advantages.join(', ')}</p>
                <p><strong>Considerations:</strong> ${data.disadvantages.join(', ')}</p>
            `;
            
            detailsDiv.innerHTML = detailsHTML;
            infoDiv.style.display = 'block';
        }

        function addAdjusterToFormula() {
            const adjusterName = document.getElementById('adjuster-select').value;
            const concentration = parseFloat(document.getElementById('adjuster-concentration').value);

            if (!adjusterName) {
                alert('Please select a pH adjuster');
                return;
            }

            if (!concentration || concentration <= 0) {
                alert('Please enter a valid concentration');
                return;
            }

            const adjusterData = PH_ADJUSTERS_DATABASE[adjusterName];
            const estimatedAmount = currentPHFormula.calculatedAdjuster?.amount || 0;
            
            const adjuster = {
                name: adjusterName,
                category: adjusterData.category,
                concentration: concentration,
                estimatedAmount: estimatedAmount,
                data: adjusterData
            };

            currentPHFormula.adjusters.push(adjuster);
            updateAdjustersTable();
            
            // Clear inputs
            document.getElementById('adjuster-select').value = '';
            document.getElementById('adjuster-concentration').value = '';
            document.getElementById('adjuster-info').style.display = 'none';
            document.getElementById('estimated-amount-box').style.display = 'none';
        }

        function updateAdjustersTable() {
            const table = document.getElementById('adjusters-table');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            if (currentPHFormula.adjusters.length === 0) {
                table.style.display = 'none';
                return;
            }

            currentPHFormula.adjusters.forEach((adjuster, index) => {
                const row = document.createElement('tr');
                row.dataset.index = index;
                row.onclick = () => selectTableRow(row);
                row.innerHTML = `
                    <td>${adjuster.name}</td>
                    <td><span class="category-badge ${adjuster.category}">${adjuster.category.charAt(0).toUpperCase() + adjuster.category.slice(1)}</span></td>
                    <td>${adjuster.estimatedAmount.toFixed(3)}g (${adjuster.concentration}% solution)</td>
                `;
                tbody.appendChild(row);
            });

            table.style.display = 'table';
        }

        function selectTableRow(row) {
            document.querySelectorAll('#adjusters-table tr').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
        }

        function removeSelectedAdjuster() {
            const selectedRow = document.querySelector('#adjusters-table tr.selected');
            if (!selectedRow) {
                alert('Please select an adjuster to remove');
                return;
            }

            const index = parseInt(selectedRow.dataset.index);
            currentPHFormula.adjusters.splice(index, 1);
            updateAdjustersTable();
        }

        function generatePHFormula() {
            const formulaName = document.getElementById('formula-name').value || 'pH Adjustment Formula';

            if (!currentPHFormula.currentPH || !currentPHFormula.targetPH) {
                alert('Please analyze current pH and calculate pH adjustment first');
                return;
            }

            let formulaHTML = `
                <div style="background: white; border-radius: 8px; padding: 20px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3>${formulaName}</h3>
                    <p><strong>Product Type:</strong> ${currentPHFormula.productType?.charAt(0).toUpperCase() + currentPHFormula.productType?.slice(1) || 'N/A'}</p>
                    
                    <div style="background: #e8f5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <strong>Current pH:</strong> ${currentPHFormula.currentPH.toFixed(2)} → 
                        <strong>Target pH:</strong> ${currentPHFormula.targetPH.toFixed(2)}
                    </div>
            `;

            if (currentPHFormula.adjusters.length > 0) {
                formulaHTML += `<h4>pH Adjusters:</h4><ul>`;
                currentPHFormula.adjusters.forEach(adjuster => {
                    formulaHTML += `<li>${adjuster.name}: ${adjuster.estimatedAmount.toFixed(3)}g (${adjuster.concentration}% solution)</li>`;
                });
                formulaHTML += `</ul>`;
            }

            formulaHTML += '</div>';

            document.getElementById('ph-formula-display').innerHTML = formulaHTML;
        }

        // Initialize on page load
        window.onload = initializePHApp;
    </script>
</body>
</html>
