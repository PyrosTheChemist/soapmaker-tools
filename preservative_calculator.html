<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Preservative Calculator - Philip Riachy, PhD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #6A1B9A, #8E24AA);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .signature {
            position: absolute;
            top: 15px;
            right: 30px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h3 {
            color: #6A1B9A;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #6A1B9A;
            box-shadow: 0 0 0 3px rgba(106, 27, 154, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #6A1B9A, #8E24AA);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin: 3px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(106, 27, 154, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #ff6b6b);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #6A1B9A;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr.selected {
            background: #f3e5f5;
        }

        .result-display {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin: 15px 0;
            display: none;
            font-size: 0.9rem;
        }

        .result-display.error {
            background: linear-gradient(135deg, #f44336, #ff6b6b);
        }

        .result-display.warning {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
        }

        .preservative-analysis {
            background: #f8f0ff;
            border: 2px solid #6A1B9A;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .preservative-analysis h4 {
            color: #4a148c;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .risk-assessment {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .risk-level {
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .risk-level.low { background: #e8f5e8; color: #2e7d32; }
        .risk-level.medium { background: #fff3e0; color: #f57c00; }
        .risk-level.high { background: #ffebee; color: #c62828; }

        .risk-level.selected {
            border-color: #6A1B9A;
            transform: scale(1.05);
        }

        .microbiology-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .microbe-category {
            background: #f0f8ff;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
        }

        .challenge-test {
            background: #fff9e6;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .regulatory-guide {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .preservative-categories {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .category-badge {
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .category-badge.traditional { background: #e3f2fd; color: #1565c0; }
        .category-badge.natural { background: #e8f5e8; color: #2e7d32; }
        .category-badge.broad_spectrum { background: #fff3e0; color: #f57c00; }
        .category-badge.specialty { background: #fce4ec; color: #ad1457; }

        .category-badge.selected {
            border-color: #6A1B9A;
            transform: scale(1.05);
        }

        .recipe-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .recipe-form {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .recipe-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 800px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .recipe-form {
                grid-template-columns: 1fr;
            }
            
            .risk-assessment,
            .preservative-categories {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="signature">Philip Riachy, PhD</div>
            <h1>Professional Preservative Calculator</h1>
            <p class="subtitle">Scientific Microbiological Protection & Preservative System Design</p>
        </div>

        <div class="main-content">
            <!-- Product Analysis -->
            <div class="section">
                <h3>🧫 Product Risk Assessment</h3>
                
                <div class="form-group">
                    <label>Product Category</label>
                    <select id="product-category" class="form-control" onchange="updateRiskProfile()">
                        <option value="">Select product category...</option>
                        <option value="anhydrous">Anhydrous (No water)</option>
                        <option value="emulsion">Emulsion (Cream/Lotion)</option>
                        <option value="serum">Water-based Serum</option>
                        <option value="gel">Gel</option>
                        <option value="shampoo">Shampoo/Body Wash</option>
                        <option value="toner">Toner/Mist</option>
                        <option value="makeup">Color Cosmetics</option>
                        <option value="sunscreen">Sunscreen</option>
                        <option value="baby">Baby Products</option>
                        <option value="organic">Natural/Organic</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Water Activity (aw)</label>
                    <input type="number" id="water-activity" class="form-control" step="0.01" min="0" max="1" placeholder="0.95">
                </div>

                <div class="form-group">
                    <label>pH Range</label>
                    <select id="ph-range" class="form-control">
                        <option value="">Select pH range...</option>
                        <option value="acidic">Acidic (3.0-5.5)</option>
                        <option value="neutral">Neutral (5.5-7.5)</option>
                        <option value="alkaline">Alkaline (7.5-10.0)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Contamination Risk Level</label>
                    <div class="risk-assessment">
                        <div class="risk-level low" onclick="selectRiskLevel('low')">Low Risk</div>
                        <div class="risk-level medium" onclick="selectRiskLevel('medium')">Medium Risk</div>
                        <div class="risk-level high" onclick="selectRiskLevel('high')">High Risk</div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="analyzeContaminationRisk()">Assess Risk Profile</button>
                <div id="risk-analysis-result" class="result-display"></div>

                <div class="preservative-analysis" id="risk-detailed-analysis" style="display: none;">
                    <h4>Microbiological Risk Assessment</h4>
                    <div id="microbial-threats"></div>
                    <div id="preservation-requirements"></div>
                    <div id="regulatory-considerations"></div>
                </div>
            </div>

            <!-- Preservative Selection -->
            <div class="section">
                <h3>🛡️ Preservative Selection</h3>
                
                <div class="form-group">
                    <label>Preservative Category</label>
                    <div class="preservative-categories">
                        <div class="category-badge traditional" onclick="selectPreservativeCategory('traditional')">Traditional</div>
                        <div class="category-badge natural" onclick="selectPreservativeCategory('natural')">Natural</div>
                        <div class="category-badge broad_spectrum" onclick="selectPreservativeCategory('broad_spectrum')">Broad Spectrum</div>
                        <div class="category-badge specialty" onclick="selectPreservativeCategory('specialty')">Specialty</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Select Preservative</label>
                    <select id="preservative-select" class="form-control" onchange="showPreservativeInfo()">
                        <option value="">Choose a preservative...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Usage Rate (%)</label>
                    <input type="number" id="preservative-percentage" class="form-control" step="0.01" min="0" placeholder="Based on selection">
                </div>

                <div id="preservative-info" class="preservative-analysis" style="display: none;">
                    <h4 id="preservative-name-display"></h4>
                    <div id="preservative-details"></div>
                </div>

                <div>
                    <button class="btn" onclick="addPreservativeToSystem()">Add to System</button>
                    <button class="btn btn-danger" onclick="removeSelectedPreservative()">Remove</button>
                </div>

                <table class="data-table" id="preservatives-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Preservative</th>
                            <th>Category</th>
                            <th>Usage %</th>
                            <th>Spectrum</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <button class="btn btn-success" onclick="validatePreservativeSystem()">Validate System</button>
                <div id="system-validation-result" class="result-display"></div>
            </div>

            <!-- Microbiology & Testing -->
            <div class="section">
                <h3>🔬 Challenge Testing</h3>
                
                <div class="microbiology-grid">
                    <div class="microbe-category">
                        <h5>Bacteria</h5>
                        <div style="font-size: 0.8rem;">
                            • Pseudomonas aeruginosa<br>
                            • Staphylococcus aureus<br>
                            • Escherichia coli
                        </div>
                    </div>
                    <div class="microbe-category">
                        <h5>Yeasts & Molds</h5>
                        <div style="font-size: 0.8rem;">
                            • Candida albicans<br>
                            • Aspergillus niger<br>
                            • Saccharomyces cerevisiae
                        </div>
                    </div>
                </div>

                <div class="challenge-test">
                    <h4>Challenge Test Protocol</h4>
                    <div style="font-size: 0.85rem;">
                        <strong>ISO 11930 / USP 51 Standards:</strong><br>
                        • Initial inoculum: 10⁵-10⁶ CFU/g<br>
                        • Test duration: 28 days<br>
                        • Sampling: 0, 1, 2, 7, 14, 28 days<br>
                        • Temperature: 20-25°C<br>
                        • Pass criteria: ≥3 log reduction
                    </div>
                </div>

                <div class="form-group">
                    <label>Test Standard</label>
                    <select id="test-standard" class="form-control">
                        <option value="iso11930">ISO 11930 (EU Standard)</option>
                        <option value="usp51">USP 51 (US Standard)</option>
                        <option value="jp">Japanese Pharmacopoeia</option>
                        <option value="custom">Custom Protocol</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Required Log Reduction</label>
                    <select id="log-reduction" class="form-control">
                        <option value="1">1 log (90% kill)</option>
                        <option value="2">2 log (99% kill)</option>
                        <option value="3" selected>3 log (99.9% kill)</option>
                        <option value="4">4 log (99.99% kill)</option>
                        <option value="5">5 log (99.999% kill)</option>
                    </select>
                </div>

                <button class="btn btn-success" onclick="designChallengeTest()">Design Challenge Test</button>
                <div id="challenge-test-result" class="result-display"></div>

                <div class="preservative-analysis" id="test-protocol" style="display: none;">
                    <h4>Challenge Test Protocol</h4>
                    <div id="test-details"></div>
                </div>
            </div>

            <!-- Regulatory & Safety -->
            <div class="section">
                <h3>⚖️ Regulatory Compliance</h3>
                
                <div class="form-group">
                    <label>Target Markets</label>
                    <select id="target-markets" class="form-control" multiple size="5">
                        <option value="eu">European Union</option>
                        <option value="usa">United States</option>
                        <option value="canada">Canada</option>
                        <option value="japan">Japan</option>
                        <option value="china">China</option>
                        <option value="korea">South Korea</option>
                        <option value="asean">ASEAN Countries</option>
                        <option value="brazil">Brazil</option>
                    </select>
                </div>

                <div class="regulatory-guide">
                    <h4>Key Regulatory Limits</h4>
                    <div style="font-size: 0.8rem;">
                        <strong>EU (Annex V):</strong> Maximum concentrations defined<br>
                        <strong>FDA:</strong> Generally recognized as safe (GRAS)<br>
                        <strong>Health Canada:</strong> Cosmetic Ingredient Hotlist<br>
                        <strong>JFRL:</strong> Positive list system<br>
                        <strong>NMPA China:</strong> Approved preservatives list
                    </div>
                </div>

                <div class="form-group">
                    <label>Product Claims</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px;">
                        <label style="font-size: 0.8rem;"><input type="checkbox" id="claim-natural" style="margin-right: 5px;"> Natural</label>
                        <label style="font-size: 0.8rem;"><input type="checkbox" id="claim-organic" style="margin-right: 5px;"> Organic</label>
                        <label style="font-size: 0.8rem;"><input type="checkbox" id="claim-paraben-free" style="margin-right: 5px;"> Paraben-free</label>
                        <label style="font-size: 0.8rem;"><input type="checkbox" id="claim-sulfate-free" style="margin-right: 5px;"> Sulfate-free</label>
                        <label style="font-size: 0.8rem;"><input type="checkbox" id="claim-baby-safe" style="margin-right: 5px;"> Baby-safe</label>
                        <label style="font-size: 0.8rem;"><input type="checkbox" id="claim-sensitive" style="margin-right: 5px;"> Sensitive skin</label>
                    </div>
                </div>

                <button class="btn btn-success" onclick="checkRegulatoryCompliance()">Check Compliance</button>
                <div id="regulatory-result" class="result-display"></div>

                <div class="preservative-analysis" id="compliance-analysis" style="display: none;">
                    <h4>Regulatory Analysis</h4>
                    <div id="compliance-details"></div>
                </div>

                <div class="preservative-analysis">
                    <h4>💡 Safety Considerations</h4>
                    <ul style="font-size: 0.8rem; margin: 8px 0; padding-left: 16px;">
                        <li>Always use minimum effective concentration</li>
                        <li>Consider synergistic combinations to reduce individual levels</li>
                        <li>Monitor for sensitization potential in sensitive populations</li>
                        <li>Validate efficacy through proper challenge testing</li>
                        <li>Document all safety assessments and testing</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Formula Generation -->
        <div class="recipe-section">
            <h3>📋 Complete Preservation System</h3>
            
            <div class="recipe-form">
                <div>
                    <div class="form-group">
                        <label>System Name</label>
                        <input type="text" id="system-name" class="form-control" placeholder="Multi-Spectrum Preservation System">
                    </div>
                    <div class="form-group">
                        <label>Batch Size (kg)</label>
                        <input type="number" id="batch-size" class="form-control" value="10" min="0.1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>System ID</label>
                        <input type="text" id="system-id" class="form-control" placeholder="PS001">
                    </div>
                </div>
                
                <div>
                    <div class="form-group">
                        <label>Target Shelf Life</label>
                        <select id="shelf-life" class="form-control">
                            <option value="12">12 months</option>
                            <option value="18">18 months</option>
                            <option value="24" selected>24 months</option>
                            <option value="36">36 months</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Storage Conditions</label>
                        <select id="storage-conditions" class="form-control">
                            <option value="ambient">Room Temperature</option>
                            <option value="cool">Cool & Dry</option>
                            <option value="refrigerated">Refrigerated</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Manufacturing Method</label>
                        <select id="manufacturing-method" class="form-control">
                            <option value="hot">Hot Process</option>
                            <option value="cold">Cold Process</option>
                            <option value="phase">Phase Addition</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <div class="form-group">
                        <label>Preservation Strategy</label>
                        <textarea id="preservation-strategy" class="form-control" rows="3" placeholder="Multi-hurdle approach combining traditional preservatives with natural antimicrobials..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Testing Protocol</label>
                        <textarea id="testing-protocol" class="form-control" rows="3" placeholder="Challenge testing per ISO 11930, microbial limits testing, stability studies..."></textarea>
                    </div>
                </div>
            </div>

            <div class="recipe-buttons">
                <button class="btn btn-success" onclick="generatePreservationSystem()">Generate System</button>
                <button class="btn" onclick="exportPreservativePDF()">Export PDF</button>
                <button class="btn" onclick="savePreservativeSystem()">Save JSON</button>
                <button class="btn" onclick="loadPreservativeSystem()">Load JSON</button>
                <button class="btn btn-danger" onclick="clearAllPreservativeData()">New System</button>
            </div>

            <div id="preservative-system-display"></div>
        </div>
    </div>

    <script>
        // Comprehensive Preservative Database with Scientific Data
        const PRESERVATIVES_DATABASE = {
            // Traditional Preservatives
            "Phenoxyethanol": {
                category: "traditional",
                cas_number: "122-99-6",
                max_usage: { eu: 1.0, usa: 1.0, global: 1.0 },
                optimal_range: "0.5-1.0%",
                ph_range: "3-12",
                spectrum: ["bacteria", "yeast"],
                mechanism: "Cell membrane disruption, protein denaturation",
                advantages: ["Broad pH stability", "Good compatibility", "Low odor"],
                limitations: ["Limited mold activity", "Potential eye irritation"],
                synergies: ["Ethylhexylglycerin", "Caprylyl Glycol"],
                heat_stability: "Excellent (up to 80°C)",
                regulatory_status: "Approved in major markets"
            },
            "Methylparaben": {
                category: "traditional",
                cas_number: "99-76-3",
                max_usage: { eu: 0.4, usa: 0.25, global: 0.4 },
                optimal_range: "0.1-0.4%",
                ph_range: "4-8",
                spectrum: ["bacteria", "yeast", "mold"],
                mechanism: "Inhibition of cellular respiration and enzyme function",
                advantages: ["Excellent broad spectrum", "Long history of safe use"],
                limitations: ["pH dependent", "Paraben concerns"],
                synergies: ["Propylparaben", "Phenoxyethanol"],
                heat_stability: "Good (up to 70°C)",
                regulatory_status: "Restricted in EU, approved USA"
            },
            "Propylparaben": {
                category: "traditional",
                cas_number: "94-13-3",
                max_usage: { eu: 0.14, usa: 0.25, global: 0.14 },
                optimal_range: "0.05-0.14%",
                ph_range: "4-8",
                spectrum: ["bacteria", "yeast", "mold"],
                mechanism: "Cell membrane disruption, metabolic inhibition",
                advantages: ["Strong antifungal activity", "Synergistic with methylparaben"],
                limitations: ["Limited water solubility", "Paraben concerns"],
                synergies: ["Methylparaben", "Butylparaben"],
                heat_stability: "Good (up to 70°C)",
                regulatory_status: "Restricted concentrations globally"
            },
            "DMDM Hydantoin": {
                category: "traditional",
                cas_number: "6440-58-0",
                max_usage: { eu: 0.6, usa: 0.2, global: 0.2 },
                optimal_range: "0.1-0.6%",
                ph_range: "6-8",
                spectrum: ["bacteria", "yeast", "mold"],
                mechanism: "Formaldehyde release, protein cross-linking",
                advantages: ["Excellent broad spectrum", "Cost effective"],
                limitations: ["Formaldehyde release", "pH sensitive"],
                synergies: ["Phenoxyethanol", "Iodopropynyl Butylcarbamate"],
                heat_stability: "Moderate (up to 60°C)",
                regulatory_status: "Being phased out in some markets"
            },

            // Natural Preservatives
            "Potassium Sorbate": {
                category: "natural",
                cas_number: "24634-61-5",
                max_usage: { eu: 0.6, usa: 0.6, global: 0.6 },
                optimal_range: "0.1-0.6%",
                ph_range: "3-6.5",
                spectrum: ["yeast", "mold"],
                mechanism: "Inhibition of dehydrogenase enzymes",
                advantages: ["Natural origin", "Food grade safety"],
                limitations: ["pH dependent", "Limited bacterial activity"],
                synergies: ["Sodium Benzoate", "Natural acids"],
                heat_stability: "Good (up to 75°C)",
                regulatory_status: "Widely accepted as natural"
            },
            "Sodium Benzoate": {
                category: "natural",
                cas_number: "532-32-1",
                max_usage: { eu: 0.5, usa: 0.1, global: 0.5 },
                optimal_range: "0.1-0.5%",
                ph_range: "2.5-4.0",
                spectrum: ["bacteria", "yeast"],
                mechanism: "Interference with cellular pH regulation",
                advantages: ["Natural origin", "Excellent water solubility"],
                limitations: ["Very pH dependent", "Limited mold activity"],
                synergies: ["Potassium Sorbate", "Citric acid"],
                heat_stability: "Excellent (up to 100°C)",
                regulatory_status: "Natural preservative status"
            },
            "Leucidal Liquid SF": {
                category: "natural",
                cas_number: "N/A",
                max_usage: { eu: 2.0, usa: 2.0, global: 2.0 },
                optimal_range: "2.0-4.0%",
                ph_range: "3-8",
                spectrum: ["bacteria"],
                mechanism: "Antimicrobial peptides from fermented radish root",
                advantages: ["100% natural", "Broad pH range", "Skin conditioning"],
                limitations: ["High usage rates", "Limited antifungal"],
                synergies: ["Geogard ECT", "Natural organic acids"],
                heat_stability: "Moderate (up to 65°C)",
                regulatory_status: "Natural preservative, COSMOS approved"
            },
            "Geogard ECT": {
                category: "natural",
                cas_number: "70851-07-9",
                max_usage: { eu: 1.0, usa: 1.0, global: 1.0 },
                optimal_range: "0.5-1.0%",
                ph_range: "3-8",
                spectrum: ["bacteria", "yeast", "mold"],
                mechanism: "Cell wall disruption and metabolic inhibition",
                advantages: ["Broad spectrum", "Natural origin", "Good stability"],
                limitations: ["Higher cost", "May affect product color"],
                synergies: ["Natural acids", "Silver compounds"],
                heat_stability: "Good (up to 70°C)",
                regulatory_status: "Natural preservative, globally accepted"
            },

            // Broad Spectrum Preservatives
            "Optiphen Plus": {
                category: "broad_spectrum",
                cas_number: "Mixture",
                max_usage: { eu: 1.5, usa: 1.5, global: 1.5 },
                optimal_range: "0.75-1.5%",
                ph_range: "4-10",
                spectrum: ["bacteria", "yeast", "mold"],
                mechanism: "Synergistic combination of phenoxyethanol and caprylyl glycol",
                advantages: ["Complete preservation", "Broad pH range", "Paraben-free"],
                limitations: ["Higher cost", "Complex mixture"],
                synergies: ["Additional boosters may not be needed"],
                heat_stability: "Good (up to 75°C)",
                regulatory_status: "Approved globally, paraben-free claim"
            },
            "Germaben II": {
                category: "broad_spectrum",
                cas_number: "Mixture",
                max_usage: { eu: 1.0, usa: 1.0, global: 1.0 },
                optimal_range: "0.5-1.0%",
                ph_range: "3-8",
                spectrum: ["bacteria", "yeast", "mold"],
                mechanism: "Synergistic parabens with diazolidinyl urea",
                advantages: ["Excellent efficacy", "Lower individual concentrations"],
                limitations: ["Contains parabens", "Formaldehyde release potential"],
                synergies: ["Antioxidants", "Chelating agents"],
                heat_stability: "Moderate (up to 65°C)",
                regulatory_status: "Traditional system, some restrictions"
            },
            "Euxyl PE 9010": {
                category: "broad_spectrum",
                cas_number: "Mixture",
                max_usage: { eu: 1.0, usa: 1.0, global: 1.0 },
                optimal_range: "0.8-1.0%",
                ph_range: "2-12",
                spectrum: ["bacteria", "yeast", "mold"],
                mechanism: "Phenoxyethanol with ethylhexylglycerin synergy",
                advantages: ["Broad pH stability", "Excellent compatibility"],
                limitations: ["Moderate antifungal activity", "Cost considerations"],
                synergies: ["Additional fungicides may be needed"],
                heat_stability: "Excellent (up to 80°C)",
                regulatory_status: "Widely accepted, paraben-free"
            },

            // Specialty Preservatives
            "Iodopropynyl Butylcarbamate": {
                category: "specialty",
                cas_number: "55406-53-6",
                max_usage: { eu: 0.02, usa: 0.1, global: 0.02 },
                optimal_range: "0.005-0.02%",
                ph_range: "2-9",
                spectrum: ["mold", "yeast"],
                mechanism: "Disruption of cell membrane integrity",
                advantages: ["Extremely potent fungicide", "Low usage rates"],
                limitations: ["Potential sensitizer", "Limited bacterial activity"],
                synergies: ["Phenoxyethanol", "Other antibacterials"],
                heat_stability: "Good (up to 70°C)",
                regulatory_status: "Restricted concentration, some bans"
            },
            "Zinc Pyrithione": {
                category: "specialty",
                cas_number: "13463-41-7",
                max_usage: { eu: 1.0, usa: 1.0, global: 1.0 },
                optimal_range: "0.1-1.0%",
                ph_range: "6-9",
                spectrum: ["bacteria", "yeast", "mold"],
                mechanism: "Metal ion interference with cellular processes",
                advantages: ["Antidandruff activity", "Broad antimicrobial"],
                limitations: ["Color instability", "Metal sensitivity"],
                synergies: ["Chelating agents", "Antioxidants"],
                heat_stability: "Moderate (up to 60°C)",
                regulatory_status: "OTC drug in some applications"
            },
            "Silver Sodium Hydrogen Zirconium Phosphate": {
                category: "specialty",
                cas_number: "265647-11-8",
                max_usage: { eu: 2.5, usa: 2.5, global: 2.5 },
                optimal_range: "0.1-2.5%",
                ph_range: "3-11",
                spectrum: ["bacteria", "yeast", "mold"],
                mechanism: "Slow-release silver ions disrupting cellular function",
                advantages: ["Long-lasting activity", "Broad spectrum", "Heat stable"],
                limitations: ["Higher cost", "Potential discoloration"],
                synergies: ["Compatible with most systems"],
                heat_stability: "Excellent (up to 120°C)",
                regulatory_status: "Novel preservative, growing acceptance"
            }
        };

        // Application State
        let currentPreservativeSystem = {
            productProfile: null,
            preservatives: [],
            riskLevel: null,
            testProtocol: null
        };

        // Initialize Application
        function initializePreservativeApp() {
            console.log('Initializing Professional Preservative Calculator...');
            populatePreservativeDropdown();
            setupPreservativeEventListeners();
            console.log('Preservative Calculator ready!');
        }

        function populatePreservativeDropdown() {
            const preservativeSelect = document.getElementById('preservative-select');
            Object.keys(PRESERVATIVES_DATABASE).sort().forEach(preservative => {
                const option = document.createElement('option');
                option.value = preservative;
                option.textContent = preservative;
                preservativeSelect.appendChild(option);
            });
        }

        function setupPreservativeEventListeners() {
            document.getElementById('preservative-percentage').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addPreservativeToSystem();
            });
        }

        function updateRiskProfile() {
            const category = document.getElementById('product-category').value;
            
            // Auto-populate water activity based on product type
            const waterActivities = {
                anhydrous: 0.0,
                emulsion: 0.95,
                serum: 0.98,
                gel: 0.95,
                shampoo: 0.99,
                toner: 0.99,
                makeup: 0.85,
                sunscreen: 0.90,
                baby: 0.96,
                organic: 0.96
            };
            
            if (waterActivities[category] !== undefined) {
                document.getElementById('water-activity').value = waterActivities[category];
            }
        }

        function selectRiskLevel(level) {
            document.querySelectorAll('.risk-level').forEach(badge => badge.classList.remove('selected'));
            document.querySelector(`.risk-level.${level}`).classList.add('selected');
            currentPreservativeSystem.riskLevel = level;
        }

        function selectPreservativeCategory(category) {
            document.querySelectorAll('.category-badge').forEach(badge => badge.classList.remove('selected'));
            document.querySelector(`.category-badge.${category}`).classList.add('selected');
            
            filterPreservativesByCategory(category);
        }

        function filterPreservativesByCategory(category) {
            const preservativeSelect = document.getElementById('preservative-select');
            preservativeSelect.innerHTML = '<option value="">Choose a preservative...</option>';
            
            Object.entries(PRESERVATIVES_DATABASE).forEach(([name, data]) => {
                if (data.category === category) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    preservativeSelect.appendChild(option);
                }
            });
        }

        function showPreservativeInfo() {
            const preservativeName = document.getElementById('preservative-select').value;
            const infoDiv = document.getElementById('preservative-info');
            const nameDisplay = document.getElementById('preservative-name-display');
            const detailsDiv = document.getElementById('preservative-details');

            if (!preservativeName) {
                infoDiv.style.display = 'none';
                return;
            }

            const data = PRESERVATIVES_DATABASE[preservativeName];
            nameDisplay.textContent = `${preservativeName} (${data.category.replace('_', ' ').toUpperCase()})`;
            
            // Auto-populate suggested usage rate
            document.getElementById('preservative-percentage').value = parseFloat(data.optimal_range.split('-')[1]) || 1.0;
            
            let detailsHTML = `
                <p><strong>CAS Number:</strong> ${data.cas_number}</p>
                <p><strong>Optimal Range:</strong> ${data.optimal_range}</p>
                <p><strong>pH Range:</strong> ${data.ph_range}</p>
                <p><strong>Antimicrobial Spectrum:</strong> ${data.spectrum.join(', ')}</p>
                <p><strong>Mechanism:</strong> ${data.mechanism}</p>
                <p><strong>Advantages:</strong> ${data.advantages.join(', ')}</p>
                <p><strong>Limitations:</strong> ${data.limitations.join(', ')}</p>
                <p><strong>Synergies:</strong> ${data.synergies.join(', ')}</p>
                <p><strong>Heat Stability:</strong> ${data.heat_stability}</p>
                <p><strong>Max Usage (EU/USA):</strong> ${data.max_usage.eu}% / ${data.max_usage.usa}%</p>
            `;
            
            detailsDiv.innerHTML = detailsHTML;
            infoDiv.style.display = 'block';
        }

        function analyzeContaminationRisk() {
            const productCategory = document.getElementById('product-category').value;
            const waterActivity = parseFloat(document.getElementById('water-activity').value);
            const phRange = document.getElementById('ph-range').value;
            const riskLevel = currentPreservativeSystem.riskLevel;
            
            if (!productCategory || !riskLevel) {
                alert('Please select product category and contamination risk level');
                return;
            }

            currentPreservativeSystem.productProfile = {
                category: productCategory,
                waterActivity: waterActivity || 0.95,
                phRange: phRange,
                riskLevel: riskLevel
            };

            let microbialThreats = '';
            let preservationRequirements = '';
            let regulatoryConsiderations = '';
            let resultClass = '';

            // Analyze microbial threats
            if (waterActivity > 0.95) {
                microbialThreats = 'High water activity supports bacterial, yeast, and mold growth. Pseudomonas and gram-negative bacteria are primary concerns.';
                resultClass = 'warning';
            } else if (waterActivity > 0.85) {
                microbialThreats = 'Moderate water activity primarily supports yeast and mold growth. Bacterial growth limited but possible.';
                resultClass = '';
            } else if (waterActivity > 0.60) {
                microbialThreats = 'Low water activity mainly supports xerophilic molds. Most bacteria cannot survive.';
                resultClass = '';
            } else {
                microbialThreats = 'Very low water activity - minimal microbial growth possible. Preservation may not be required.';
                resultClass = '';
            }

            // Preservation requirements
            if (riskLevel === 'high' && waterActivity > 0.95) {
                preservationRequirements = 'Broad-spectrum preservation required. Consider multi-hurdle approach with primary + booster system.';
            } else if (riskLevel === 'medium') {
                preservationRequirements = 'Standard preservation adequate. Single broad-spectrum preservative or traditional combination.';
            } else {
                preservationRequirements = 'Basic preservation sufficient. Natural preservatives may be adequate for low-risk products.';
            }

            // Regulatory considerations
            if (productCategory === 'baby') {
                regulatoryConsiderations = 'Baby product regulations apply. Avoid formaldehyde releasers and strong sensitizers. Consider natural options.';
            } else if (productCategory === 'organic') {
                regulatoryConsiderations = 'Organic certification limits. Focus on naturally-derived preservatives and organic-compliant options.';
            } else {
                regulatoryConsiderations = 'Standard cosmetic regulations apply. Full range of approved preservatives available.';
            }

            const resultDiv = document.getElementById('risk-analysis-result');
            resultDiv.innerHTML = `
                <strong>Risk Analysis Complete!</strong><br>
                Product: ${productCategory.charAt(0).toUpperCase() + productCategory.slice(1)}<br>
                Risk Level: ${riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1)}<br>
                Water Activity: ${waterActivity.toFixed(2)}
            `;
            resultDiv.className = `result-display ${resultClass}`;
            resultDiv.style.display = 'block';

            document.getElementById('microbial-threats').innerHTML = `<strong>Microbial Threats:</strong> ${microbialThreats}`;
            document.getElementById('preservation-requirements').innerHTML = `<strong>Preservation Strategy:</strong> ${preservationRequirements}`;
            document.getElementById('regulatory-considerations').innerHTML = `<strong>Regulatory:</strong> ${regulatoryConsiderations}`;
            
            document.getElementById('risk-detailed-analysis').style.display = 'block';
        }

        function addPreservativeToSystem() {
            const preservativeName = document.getElementById('preservative-select').value;
            const percentage = parseFloat(document.getElementById('preservative-percentage').value);

            if (!preservativeName) {
                alert('Please select a preservative');
                return;
            }

            if (!percentage || percentage <= 0) {
                alert('Please enter a valid usage percentage');
                return;
            }

            const preservativeData = PRESERVATIVES_DATABASE[preservativeName];
            
            // Check if usage rate exceeds maximum allowed
            const maxUsage = preservativeData.max_usage.eu; // Use EU as most restrictive
            if (percentage > maxUsage) {
                alert(`Usage rate ${percentage}% exceeds maximum allowed ${maxUsage}% in EU`);
                return;
            }

            const preservative = {
                name: preservativeName,
                category: preservativeData.category,
                percentage: percentage,
                spectrum: preservativeData.spectrum,
                data: preservativeData
            };

            currentPreservativeSystem.preservatives.push(preservative);
            updatePreservativesTable();
            
            // Clear inputs
            document.getElementById('preservative-select').value = '';
            document.getElementById('preservative-percentage').value = '';
            document.getElementById('preservative-info').style.display = 'none';
        }

        function updatePreservativesTable() {
            const table = document.getElementById('preservatives-table');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            if (currentPreservativeSystem.preservatives.length === 0) {
                table.style.display = 'none';
                return;
            }

            currentPreservativeSystem.preservatives.forEach((preservative, index) => {
                const row = document.createElement('tr');
                row.onclick = () => selectTableRow(row, 'preservative', index);
                row.innerHTML = `
                    <td>${preservative.name}</td>
                    <td><span class="category-badge ${preservative.category}">${preservative.category.replace('_', ' ')}</span></td>
                    <td>${preservative.percentage}%</td>
                    <td>${preservative.spectrum.join(', ')}</td>
                `;
                tbody.appendChild(row);
            });

            table.style.display = 'table';
        }

        function removeSelectedPreservative() {
            const selectedRow = document.querySelector('#preservatives-table tr.selected');
            if (!selectedRow) {
                alert('Please select a preservative to remove');
                return;
            }

            const index = parseInt(selectedRow.dataset.index);
            currentPreservativeSystem.preservatives.splice(index, 1);
            updatePreservativesTable();
        }

        function validatePreservativeSystem() {
            if (currentPreservativeSystem.preservatives.length === 0) {
                alert('Please add preservatives to your system first');
                return;
            }

            let validation = {
                bacteria: false,
                yeast: false,
                mold: false,
                totalConcentration: 0,
                regulatoryIssues: []
            };

            // Check spectrum coverage and concentrations
            currentPreservativeSystem.preservatives.forEach(preservative => {
                validation.totalConcentration += preservative.percentage;
                
                if (preservative.spectrum.includes('bacteria')) validation.bacteria = true;
                if (preservative.spectrum.includes('yeast')) validation.yeast = true;
                if (preservative.spectrum.includes('mold')) validation.mold = true;

                // Check regulatory limits
                if (preservative.percentage > preservative.data.max_usage.eu) {
                    validation.regulatoryIssues.push(`${preservative.name} exceeds EU limit`);
                }
            });

            let validationResult = '';
            let resultClass = '';

            if (validation.bacteria && validation.yeast && validation.mold) {
                validationResult = 'Complete broad-spectrum coverage achieved!';
                resultClass = '';
            } else {
                validationResult = 'Incomplete spectrum coverage detected.';
                resultClass = 'warning';
                
                if (!validation.bacteria) validationResult += ' Missing bacterial protection.';
                if (!validation.yeast) validationResult += ' Missing yeast protection.';
                if (!validation.mold) validationResult += ' Missing mold protection.';
            }

            if (validation.regulatoryIssues.length > 0) {
                validationResult += ' Regulatory issues: ' + validation.regulatoryIssues.join(', ');
                resultClass = 'error';
            }

            const resultDiv = document.getElementById('system-validation-result');
            resultDiv.innerHTML = `
                <strong>System Validation:</strong><br>
                ${validationResult}<br>
                Total Concentration: ${validation.totalConcentration.toFixed(2)}%
            `;
            resultDiv.className = `result-display ${resultClass}`;
            resultDiv.style.display = 'block';
        }

        function designChallengeTest() {
            const testStandard = document.getElementById('test-standard').value;
            const logReduction = document.getElementById('log-reduction').value;

            const protocols = {
                iso11930: {
                    name: 'ISO 11930:2019',
                    organisms: ['P. aeruginosa', 'S. aureus', 'C. albicans', 'A. niger'],
                    inoculum: '10⁵-10⁶ CFU/g',
                    sampling: '0, 1, 2, 7, 14, 28 days',
                    temperature: '20-25°C',
                    criteria: `≥${logReduction} log reduction by day 14, no increase by day 28`
                },
                usp51: {
                    name: 'USP 51',
                    organisms: ['P. aeruginosa', 'S. aureus', 'E. coli', 'C. albicans', 'A. niger'],
                    inoculum: '10⁵-10⁶ CFU/g',
                    sampling: '0, 1, 7, 14, 28 days',
                    temperature: '20-25°C',
                    criteria: `≥${logReduction} log reduction for bacteria by day 14, no increase for fungi`
                },
                jp: {
                    name: 'Japanese Pharmacopoeia',
                    organisms: ['P. aeruginosa', 'S. aureus', 'C. albicans', 'A. niger', 'S. cerevisiae'],
                    inoculum: '10⁵-10⁶ CFU/g',
                    sampling: '0, 1, 2, 7, 14, 28 days',
                    temperature: '20-25°C',
                    criteria: `≥${logReduction} log reduction, specific criteria for each organism`
                }
            };

            const protocol = protocols[testStandard];
            
            currentPreservativeSystem.testProtocol = {
                standard: testStandard,
                logReduction: logReduction,
                protocol: protocol
            };

            const resultDiv = document.getElementById('challenge-test-result');
            resultDiv.innerHTML = `
                <strong>Challenge Test Designed!</strong><br>
                Standard: ${protocol.name}<br>
                Required Reduction: ${logReduction} log<br>
                Test Duration: 28 days
            `;
            resultDiv.className = 'result-display';
            resultDiv.style.display = 'block';

            document.getElementById('test-details').innerHTML = `
                <strong>Test Protocol: ${protocol.name}</strong><br>
                <strong>Test Organisms:</strong> ${protocol.organisms.join(', ')}<br>
                <strong>Initial Inoculum:</strong> ${protocol.inoculum}<br>
                <strong>Sampling Points:</strong> ${protocol.sampling}<br>
                <strong>Temperature:</strong> ${protocol.temperature}<br>
                <strong>Pass Criteria:</strong> ${protocol.criteria}
            `;
            
            document.getElementById('test-protocol').style.display = 'block';
        }

        function checkRegulatoryCompliance() {
            if (currentPreservativeSystem.preservatives.length === 0) {
                alert('Please add preservatives to check compliance');
                return;
            }

            const targetMarkets = Array.from(document.getElementById('target-markets').selectedOptions).map(option => option.value);
            const claims = {
                natural: document.getElementById('claim-natural').checked,
                organic: document.getElementById('claim-organic').checked,
                parabenFree: document.getElementById('claim-paraben-free').checked,
                sulfateFree: document.getElementById('claim-sulfate-free').checked,
                babySafe: document.getElementById('claim-baby-safe').checked,
                sensitive: document.getElementById('claim-sensitive').checked
            };

            let complianceIssues = [];
            let marketRestrictions = [];

            currentPreservativeSystem.preservatives.forEach(preservative => {
                const data = preservative.data;
                
                // Check paraben claims
                if (claims.parabenFree && preservative.name.toLowerCase().includes('paraben')) {
                    complianceIssues.push(`${preservative.name} conflicts with paraben-free claim`);
                }

                // Check natural claims
                if (claims.natural && data.category === 'traditional') {
                    complianceIssues.push(`${preservative.name} may not support natural claims`);
                }

                // Check baby safety
                if (claims.babySafe && (data.cas_number === '6440-58-0' || data.cas_number === '55406-53-6')) {
                    complianceIssues.push(`${preservative.name} not recommended for baby products`);
                }

                // Check market restrictions
                targetMarkets.forEach(market => {
                    if (market === 'eu' && preservative.percentage > data.max_usage.eu) {
                        marketRestrictions.push(`${preservative.name} exceeds EU limit (${data.max_usage.eu}%)`);
                    }
                    if (market === 'usa' && preservative.percentage > data.max_usage.usa) {
                        marketRestrictions.push(`${preservative.name} exceeds USA limit (${data.max_usage.usa}%)`);
                    }
                });
            });

            let complianceResult = '';
            let resultClass = '';

            if (complianceIssues.length === 0 && marketRestrictions.length === 0) {
                complianceResult = 'System complies with all selected markets and claims!';
                resultClass = '';
            } else {
                complianceResult = 'Compliance issues detected.';
                resultClass = 'warning';
            }

            const resultDiv = document.getElementById('regulatory-result');
            resultDiv.innerHTML = `
                <strong>Regulatory Compliance:</strong><br>
                ${complianceResult}<br>
                Markets: ${targetMarkets.join(', ')}
            `;
            resultDiv.className = `result-display ${resultClass}`;
            resultDiv.style.display = 'block';

            let complianceDetails = '';
            if (complianceIssues.length > 0) {
                complianceDetails += '<strong>Claim Conflicts:</strong><br>' + complianceIssues.map(issue => `• ${issue}`).join('<br>') + '<br><br>';
            }
            if (marketRestrictions.length > 0) {
                complianceDetails += '<strong>Market Restrictions:</strong><br>' + marketRestrictions.map(issue => `• ${issue}`).join('<br>');
            }

            if (complianceDetails) {
                document.getElementById('compliance-details').innerHTML = complianceDetails;
                document.getElementById('compliance-analysis').style.display = 'block';
            }
        }

        // Formula Generation Functions
        function generatePreservationSystem() {
            if (currentPreservativeSystem.preservatives.length === 0) {
                alert('Please add preservatives to your system first');
                return;
            }

            const systemName = document.getElementById('system-name').value || 'Professional Preservation System';
            const batchSize = parseFloat(document.getElementById('batch-size').value) || 10;
            const preservationStrategy = document.getElementById('preservation-strategy').value;
            const testingProtocol = document.getElementById('testing-protocol').value;

            let systemHTML = `
                <div style="background: white; border-radius: 8px; padding: 20px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3>${systemName}</h3>
                    <p><strong>Batch Size:</strong> ${batchSize}kg | <strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                        <thead>
                            <tr style="background: #6A1B9A; color: white;">
                                <th style="padding: 12px; text-align: left;">Preservative</th>
                                <th style="padding: 12px; text-align: left;">Category</th>
                                <th style="padding: 12px; text-align: left;">Usage %</th>
                                <th style="padding: 12px; text-align: left;">Amount (g)</th>
                                <th style="padding: 12px; text-align: left;">Spectrum</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            let totalPreservatives = 0;
            currentPreservativeSystem.preservatives.forEach(preservative => {
                const amount = (preservative.percentage * batchSize * 10); // Convert to grams
                totalPreservatives += preservative.percentage;
                systemHTML += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">${preservative.name}</td>
                        <td style="padding: 10px;"><span class="category-badge ${preservative.category}">${preservative.category.replace('_', ' ')}</span></td>
                        <td style="padding: 10px;">${preservative.percentage}%</td>
                        <td style="padding: 10px;">${amount.toFixed(1)}g</td>
                        <td style="padding: 10px; font-size: 0.8rem;">${preservative.spectrum.join(', ')}</td>
                    </tr>
                `;
            });

            systemHTML += `
                        </tbody>
                    </table>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0; padding: 15px; background: #f8f0ff; border-radius: 8px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #6A1B9A;">${totalPreservatives.toFixed(2)}%</div>
                            <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">Total Preservatives</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #6A1B9A;">${currentPreservativeSystem.preservatives.length}</div>
                            <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">Active Components</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #6A1B9A;">${document.getElementById('shelf-life').value}</div>
                            <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">Months Shelf Life</div>
                        </div>
                    </div>
            `;

            if (currentPreservativeSystem.productProfile) {
                systemHTML += `
                    <div style="margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 6px; font-size: 0.9rem; border: 2px solid #6A1B9A;">
                        <h4 style="color: #4a148c; margin-bottom: 8px;">Product Risk Profile</h4>
                        <strong>Category:</strong> ${currentPreservativeSystem.productProfile.category.charAt(0).toUpperCase() + currentPreservativeSystem.productProfile.category.slice(1)}<br>
                        <strong>Water Activity:</strong> ${currentPreservativeSystem.productProfile.waterActivity.toFixed(2)}<br>
                        <strong>pH Range:</strong> ${currentPreservativeSystem.productProfile.phRange || 'Not specified'}<br>
                        <strong>Risk Level:</strong> ${currentPreservativeSystem.productProfile.riskLevel.charAt(0).toUpperCase() + currentPreservativeSystem.productProfile.riskLevel.slice(1)}
                    </div>
                `;
            }

            if (currentPreservativeSystem.testProtocol) {
                systemHTML += `
                    <div style="margin-top: 15px; padding: 15px; background: #fff9e6; border-radius: 6px; font-size: 0.9rem; border: 2px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 8px;">Challenge Test Protocol</h4>
                        <strong>Standard:</strong> ${currentPreservativeSystem.testProtocol.protocol.name}<br>
                        <strong>Test Organisms:</strong> ${currentPreservativeSystem.testProtocol.protocol.organisms.join(', ')}<br>
                        <strong>Required Reduction:</strong> ≥${currentPreservativeSystem.testProtocol.logReduction} log<br>
                        <strong>Pass Criteria:</strong> ${currentPreservativeSystem.testProtocol.protocol.criteria}
                    </div>
                `;
            }

            if (preservationStrategy) {
                systemHTML += `
                    <h4 style="color: #6A1B9A; margin-top: 20px;">Preservation Strategy:</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${preservationStrategy}</div>
                `;
            }

            if (testingProtocol) {
                systemHTML += `
                    <h4 style="color: #6A1B9A; margin-top: 20px;">Testing Protocol:</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${testingProtocol}</div>
                `;
            }

            systemHTML += `
                <div style="margin-top: 20px; padding: 15px; background: #f8f0ff; border-radius: 6px; font-size: 0.9rem;">
                    <h4 style="color: #4a148c; margin-bottom: 8px;">⚠️ Manufacturing & QC Guidelines</h4>
                    <ul style="margin: 8px 0; padding-left: 16px;">
                        <li>Add preservatives during cool-down phase (&lt;60°C) unless heat-stable</li>
                        <li>Ensure complete dissolution and uniform distribution</li>
                        <li>Perform microbial limits testing on finished products</li>
                        <li>Conduct stability studies under accelerated conditions</li>
                        <li>Document all preservative additions and batch records</li>
                        <li>Validate challenge test effectiveness before commercialization</li>
                    </ul>
                </div>
            `;

            systemHTML += '</div>';

            document.getElementById('preservative-system-display').innerHTML = systemHTML;
        }

        function exportPreservativePDF() {
            if (currentPreservativeSystem.preservatives.length === 0) {
                alert('Please add preservatives to your system first');
                return;
            }

            if (!window.jspdf) {
                alert('PDF library not loaded. Please refresh the page and try again.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            const systemName = document.getElementById('system-name').value || 'Professional Preservation System';
            const batchSize = parseFloat(document.getElementById('batch-size').value) || 10;

            let yPosition = 20;

            // Header
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text(systemName, 20, yPosition);
            yPosition += 12;

            pdf.setFontSize(8);
            pdf.setFont(undefined, 'normal');
            pdf.text('Professional Preservative Calculator - Philip Riachy, PhD', 130, 15);
            pdf.text(`Batch Size: ${batchSize}kg | Date: ${new Date().toLocaleDateString()}`, 20, yPosition);
            yPosition += 15;

            // Preservatives
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Preservation System', 20, yPosition);
            yPosition += 8;

            pdf.setFontSize(8);
            pdf.setFont(undefined, 'normal');
            let totalPreservatives = 0;
            
            currentPreservativeSystem.preservatives.forEach(preservative => {
                const amount = (preservative.percentage * batchSize * 10);
                totalPreservatives += preservative.percentage;
                pdf.text(`${preservative.name}`, 20, yPosition);
                pdf.text(`${preservative.percentage}%`, 80, yPosition);
                pdf.text(`${amount.toFixed(1)}g`, 100, yPosition);
                pdf.text(`${preservative.spectrum.join(', ')}`, 120, yPosition);
                yPosition += 4;
            });
            yPosition += 5;

            pdf.text(`Total Preservative Concentration: ${totalPreservatives.toFixed(2)}%`, 20, yPosition);
            yPosition += 10;

            // Risk Profile
            if (currentPreservativeSystem.productProfile) {
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('Product Risk Profile', 20, yPosition);
                yPosition += 8;

                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                pdf.text(`Product Category: ${currentPreservativeSystem.productProfile.category}`, 20, yPosition);
                pdf.text(`Water Activity: ${currentPreservativeSystem.productProfile.waterActivity.toFixed(2)}`, 80, yPosition);
                pdf.text(`Risk Level: ${currentPreservativeSystem.productProfile.riskLevel}`, 130, yPosition);
                yPosition += 10;
            }

            // Challenge Test
            if (currentPreservativeSystem.testProtocol) {
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'bold');
                pdf.text('Challenge Test Protocol', 20, yPosition);
                yPosition += 8;

                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                pdf.text(`Standard: ${currentPreservativeSystem.testProtocol.protocol.name}`, 20, yPosition);
                yPosition += 4;
                pdf.text(`Organisms: ${currentPreservativeSystem.testProtocol.protocol.organisms.join(', ')}`, 20, yPosition);
                yPosition += 4;
                pdf.text(`Required Reduction: ≥${currentPreservativeSystem.testProtocol.logReduction} log`, 20, yPosition);
                yPosition += 10;
            }

            // Preservation Strategy
            const preservationStrategy = document.getElementById('preservation-strategy').value;
            if (preservationStrategy) {
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text('Preservation Strategy:', 20, yPosition);
                yPosition += 6;

                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                const lines = pdf.splitTextToSize(preservationStrategy, 170);
                lines.forEach(line => {
                    if (yPosition > 270) return;
                    pdf.text(line, 20, yPosition);
                    yPosition += 3;
                });
            }

            const fileName = `${systemName.replace(/[^a-z0-9]/gi, '_')}_Preservation_System.pdf`;
            pdf.save(fileName);
        }

        // Data Management Functions
        function savePreservativeSystem() {
            const systemName = document.getElementById('system-name').value || 'preservation_system';
            
            const data = {
                system: currentPreservativeSystem,
                systemDetails: {
                    name: document.getElementById('system-name').value,
                    id: document.getElementById('system-id').value,
                    batchSize: document.getElementById('batch-size').value,
                    shelfLife: document.getElementById('shelf-life').value,
                    storageConditions: document.getElementById('storage-conditions').value,
                    manufacturingMethod: document.getElementById('manufacturing-method').value,
                    preservationStrategy: document.getElementById('preservation-strategy').value,
                    testingProtocol: document.getElementById('testing-protocol').value
                },
                timestamp: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${systemName.replace(/[^a-z0-9]/gi, '_')}_preservation_system.json`;
            link.click();
            
            URL.revokeObjectURL(link.href);
        }

        function loadPreservativeSystem() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        currentPreservativeSystem = data.system || {
                            productProfile: null,
                            preservatives: [],
                            riskLevel: null,
                            testProtocol: null
                        };
                        
                        if (data.systemDetails) {
                            document.getElementById('system-name').value = data.systemDetails.name || '';
                            document.getElementById('system-id').value = data.systemDetails.id || '';
                            document.getElementById('batch-size').value = data.systemDetails.batchSize || '10';
                            document.getElementById('shelf-life').value = data.systemDetails.shelfLife || '24';
                            document.getElementById('storage-conditions').value = data.systemDetails.storageConditions || 'ambient';
                            document.getElementById('manufacturing-method').value = data.systemDetails.manufacturingMethod || 'hot';
                            document.getElementById('preservation-strategy').value = data.systemDetails.preservationStrategy || '';
                            document.getElementById('testing-protocol').value = data.systemDetails.testingProtocol || '';
                        }
                        
                        updatePreservativesTable();
                        
                        if (currentPreservativeSystem.productProfile) {
                            document.getElementById('product-category').value = currentPreservativeSystem.productProfile.category;
                            document.getElementById('water-activity').value = currentPreservativeSystem.productProfile.waterActivity;
                            document.getElementById('ph-range').value = currentPreservativeSystem.productProfile.phRange;
                        }
                        
                        if (currentPreservativeSystem.riskLevel) {
                            selectRiskLevel(currentPreservativeSystem.riskLevel);
                        }
                        
                        alert('Preservation system loaded successfully!');
                        
                    } catch (error) {
                        console.error('Error loading system:', error);
                        alert('Error loading system file. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllPreservativeData() {
            if (confirm('Are you sure you want to clear all data and start a new preservation system?')) {
                currentPreservativeSystem = {
                    productProfile: null,
                    preservatives: [],
                    riskLevel: null,
                    testProtocol: null
                };
                
                // Clear form fields
                document.getElementById('system-name').value = '';
                document.getElementById('system-id').value = '';
                document.getElementById('batch-size').value = '10';
                document.getElementById('shelf-life').value = '24';
                document.getElementById('storage-conditions').value = 'ambient';
                document.getElementById('manufacturing-method').value = 'hot';
                document.getElementById('preservation-strategy').value = '';
                document.getElementById('testing-protocol').value = '';
                
                // Clear product analysis
                document.getElementById('product-category').value = '';
                document.getElementById('water-activity').value = '';
                document.getElementById('ph-range').value = '';
                document.getElementById('preservative-select').value = '';
                document.getElementById('preservative-percentage').value = '';
                document.getElementById('test-standard').value = 'iso11930';
                document.getElementById('log-reduction').value = '3';
                
                // Clear target markets and claims
                document.getElementById('target-markets').selectedIndex = -1;
                document.getElementById('claim-natural').checked = false;
                document.getElementById('claim-organic').checked = false;
                document.getElementById('claim-paraben-free').checked = false;
                document.getElementById('claim-sulfate-free').checked = false;
                document.getElementById('claim-baby-safe').checked = false;
                document.getElementById('claim-sensitive').checked = false;
                
                // Reset displays
                updatePreservativesTable();
                document.querySelectorAll('.risk-level').forEach(badge => badge.classList.remove('selected'));
                document.querySelectorAll('.category-badge').forEach(badge => badge.classList.remove('selected'));
                document.getElementById('risk-analysis-result').style.display = 'none';
                document.getElementById('risk-detailed-analysis').style.display = 'none';
                document.getElementById('preservative-info').style.display = 'none';
                document.getElementById('system-validation-result').style.display = 'none';
                document.getElementById('challenge-test-result').style.display = 'none';
                document.getElementById('test-protocol').style.display = 'none';
                document.getElementById('regulatory-result').style.display = 'none';
                document.getElementById('compliance-analysis').style.display = 'none';
                document.getElementById('preservative-system-display').innerHTML = '';
                
                // Repopulate dropdown
                populatePreservativeDropdown();
                
                alert('Started new preservation system!');
            }
        }

        // Utility Functions
        function selectTableRow(row, type, index) {
            const table = row.closest('table');
            table.querySelectorAll('tr').forEach(tr => tr.classList.remove('selected'));
            row.classList.add('selected');
            row.dataset.index = index;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePreservativeApp);
    </script>
</body>
</html>